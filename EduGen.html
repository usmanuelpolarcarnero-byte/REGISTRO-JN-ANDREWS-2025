<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduGen AI - I.E. JN ANDREWS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuente Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Librería QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .glass-header {
            background: rgba(30, 58, 138, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 4px solid #FACC15;
        }
        
        .card-shadow { box-shadow: 0 10px 40px -10px rgba(30, 58, 138, 0.2); }
        
        .btn-primary {
            background: linear-gradient(135deg, #1E3A8A 0%, #2563EB 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .btn-primary:active { transform: scale(0.98); }

        canvas { background-color: #f8fafc; border-radius: 1rem; width: 100% !important; height: 200px !important; }
        
        @media print {
            body * { visibility: hidden; }
            #printable-report, #printable-report * { visibility: visible; }
            #printable-report { position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 20px; z-index: 9999; }
            .no-print { display: none !important; }
        }
        #printable-report { display: none; }
        @media print { #printable-report { display: block; } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen flex items-center justify-center p-4 text-gray-800">

    <!-- REPORTE DE IMPRESIÓN -->
    <div id="printable-report">
        <div class="border-b-2 border-yellow-400 pb-4 mb-6 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="image_9d4f3d.jpg" alt="Logo" style="width: 60px; height: auto;">
                <div>
                    <h1 class="text-2xl font-bold text-blue-900">I.E. J.N. ANDREWS</h1>
                    <p class="text-sm text-gray-500">Examen de Conocimientos - Prof. Manuel Polar</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-400">Fecha</p>
                <p class="font-mono text-sm" id="print-date">--/--/----</p>
            </div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6 grid grid-cols-2 gap-4">
            <div><p class="text-xs text-gray-500 uppercase font-bold">Estudiante</p><p class="text-lg font-bold text-gray-800" id="print-student">--</p></div>
            <div><p class="text-xs text-gray-500 uppercase font-bold">Grado</p><p class="text-gray-800" id="print-grade">--</p></div>
            <div><p class="text-xs text-gray-500 uppercase font-bold">Nota Oficial</p><p class="text-xl font-bold text-blue-700" id="print-score">--</p></div>
        </div>
        <h3 class="font-bold text-gray-700 border-b border-gray-300 pb-2 mb-4">Detalle de Respuestas</h3>
        <div id="print-details" class="space-y-3"></div>
        <div class="mt-12 text-center text-xs text-gray-400 border-t border-gray-200 pt-4"><p>Documento generado por EduGen AI</p></div>
    </div>

    <!-- APP CONTAINER -->
    <div class="bg-white w-full max-w-md rounded-3xl card-shadow overflow-hidden fade-in relative min-h-[700px] flex flex-col border border-white/50 no-print">
        
        <!-- HEADER -->
        <div class="glass-header p-5 text-white shadow-lg z-20 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-400 rounded-full mix-blend-overlay opacity-20 blur-2xl"></div>
            <div class="flex items-center gap-4 relative z-10">
                <div class="w-16 h-16 bg-white rounded-xl flex items-center justify-center shadow-lg p-1 shrink-0 border-2 border-yellow-400">
                    <img src="image_9d4f3d.jpg" alt="Escudo" class="w-full h-full object-contain">
                </div>
                <div class="flex-1">
                    <h2 class="text-[10px] font-bold text-yellow-300 tracking-widest uppercase mb-0.5">Institución Educativa</h2>
                    <h1 class="font-extrabold text-xl leading-tight">J.N. ANDREWS</h1>
                    <div class="h-0.5 w-10 bg-yellow-400 my-1 rounded-full"></div>
                    <p class="text-[11px] text-blue-100 font-medium flex items-center gap-1">
                        <i class="fas fa-chalkboard-teacher text-yellow-400"></i> Prof. Manuel Polar Carnero
                    </p>
                </div>
            </div>
            <button onclick="window.location.href = window.location.pathname" class="absolute top-4 right-4 bg-white/10 hover:bg-white/20 p-2 rounded-lg backdrop-blur-sm transition text-yellow-300 border border-white/10 shadow-sm" title="Inicio">
                <i class="fas fa-home text-lg"></i>
            </button>
        </div>

        <!-- VISTAS -->
        <div class="flex-1 overflow-hidden relative bg-slate-50">
            
            <!-- 1. DOCENTE: CONFIGURACIÓN -->
            <div id="view-teacher" class="p-6 h-full overflow-y-auto flex flex-col gap-4">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-lg bg-blue-100 text-blue-700 flex items-center justify-center text-sm"><i class="fas fa-cog"></i></span>
                        Nuevo Examen
                    </h2>
                    <p class="text-xs text-slate-500 mt-1 ml-10">Vinculado a: <strong>Registro Oficial</strong></p>
                </div>
                
                <!-- ZONA DE CARGA REAL -->
                <input type="file" id="hidden-file-input" class="hidden" accept=".pdf,.txt,.doc,.docx,.mp4,.mp3,.jpg,.png" onchange="handleFileUpload(this)">
                <div id="upload-container" class="border-2 border-dashed border-blue-200 bg-blue-50/50 rounded-2xl p-4 text-center hover:bg-blue-50 transition cursor-pointer group" onclick="document.getElementById('hidden-file-input').click()">
                    <div class="bg-white text-blue-600 w-10 h-10 rounded-full flex items-center justify-center mx-auto mb-2 shadow-sm group-hover:scale-110 transition border border-blue-100">
                        <i class="fas fa-cloud-upload-alt text-lg"></i>
                    </div>
                    <p class="text-xs font-bold text-slate-600">Subir Material (PDF/Video/Texto)</p>
                </div>
                
                <textarea id="input-text" class="w-full border border-slate-200 rounded-2xl p-4 text-sm focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none resize-none h-24 shadow-sm placeholder:text-slate-400" placeholder="Pegue aquí el texto, resumen o tema para que la IA genere las preguntas..."></textarea>
                
                <!-- FILTROS REGISTRO -->
                <div class="bg-blue-50 border border-blue-100 p-3 rounded-xl">
                    <p class="text-[10px] font-bold text-blue-800 uppercase mb-2">Datos Académicos</p>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <select id="select-bimestre" class="w-full text-xs p-2 rounded border border-slate-200 font-semibold text-slate-700">
                            <option value="B1">I Bimestre</option>
                            <option value="B2">II Bimestre</option>
                            <option value="B3">III Bimestre</option>
                            <option value="B4">IV Bimestre</option>
                        </select>
                        <select id="select-area" class="w-full text-xs p-2 rounded border border-slate-200 font-semibold text-slate-700">
                            <option value="arte">Arte y Cultura</option>
                            <option value="dpcc">DPCC</option>
                            <option value="ept">EPT</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="select-nivel" class="w-full text-xs p-2 rounded border border-slate-200 font-semibold text-slate-700" onchange="updateGrades()">
                            <option value="primaria">Primaria</option>
                            <option value="secundaria">Secundaria</option>
                        </select>
                        <select id="select-grado" class="w-full text-xs p-2 rounded border border-slate-200 font-semibold text-slate-700">
                            <!-- JS llena esto -->
                        </select>
                    </div>
                </div>

                <!-- CONFIG EXAMEN -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
                        <label class="text-[10px] font-bold text-slate-400 uppercase block">Preguntas</label>
                        <select id="select-count" class="w-full text-xs font-semibold text-slate-700 bg-transparent outline-none">
                            <option value="3">3 Preguntas</option>
                            <option value="5">5 Preguntas</option>
                            <option value="10">10 Preguntas</option>
                            <option value="15">15 Preguntas</option>
                            <option value="20">20 Preguntas</option>
                        </select>
                    </div>
                    <div class="bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
                        <label class="text-[10px] font-bold text-slate-400 uppercase block">Tiempo/Preg</label>
                        <select id="select-time" class="w-full text-xs font-semibold text-slate-700 bg-transparent outline-none">
                            <option value="15">15 seg</option>
                            <option value="30" selected>30 seg</option>
                            <option value="60">1 min</option>
                            <option value="120">2 min</option>
                        </select>
                    </div>
                </div>

                <!-- FECHAS -->
                <div class="bg-white rounded-xl p-3 border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2"><i class="far fa-clock"></i> Disponibilidad (Opcional)</p>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="datetime-local" id="quiz-start" class="w-full bg-slate-50 border border-slate-200 rounded p-1 text-[10px]">
                        <input type="datetime-local" id="quiz-end" class="w-full bg-slate-50 border border-slate-200 rounded p-1 text-[10px]">
                    </div>
                </div>

                <button onclick="previsualizarExamen()" class="mt-2 w-full btn-primary text-white font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 text-sm uppercase tracking-wide">
                    <i class="fas fa-magic"></i> Crear Borrador con IA
                </button>
                <div class="h-4"></div>
            </div>

            <!-- 1.5. DOCENTE: REVISIÓN (NUEVO PASO) -->
            <div id="view-review" class="hidden p-6 h-full overflow-y-auto flex flex-col gap-4 bg-slate-50 fade-in">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-bold text-slate-800">Revisión Docente</h2>
                    <button onclick="showView('view-teacher')" class="text-xs text-red-500 font-bold border border-red-200 px-2 py-1 rounded bg-white">Cancelar</button>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-xs text-yellow-800">
                    <i class="fas fa-info-circle mr-1"></i> Revise las preguntas generadas. Puede editar el texto si es necesario antes de publicar.
                </div>

                <div id="review-container" class="space-y-4">
                    <!-- Aquí se inyectan los inputs de preguntas -->
                </div>

                <div class="grid grid-cols-2 gap-3 mt-4 mb-8">
                    <button onclick="previsualizarExamen()" class="bg-white border-2 border-slate-200 text-slate-600 font-bold py-3 rounded-xl text-xs uppercase">
                        <i class="fas fa-sync-alt mr-1"></i> Regenerar
                    </button>
                    <button onclick="publicarExamenDefinitivo()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg text-xs uppercase flex items-center justify-center gap-2">
                        <i class="fas fa-check-circle"></i> Aprobar y Publicar
                    </button>
                </div>
            </div>

            <!-- 2. LINK Y QR -->
            <div id="view-link" class="hidden h-full flex flex-col items-center justify-center p-8 text-center fade-in bg-white">
                <div class="w-16 h-16 bg-green-50 text-green-500 rounded-full flex items-center justify-center mb-4 text-2xl animate-bounce border-4 border-green-100">
                    <i class="fas fa-check"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800">¡Examen Activo!</h2>
                <p class="text-xs text-slate-500 mb-4">Escanee el QR para ingresar.</p>
                
                <!-- QR CODE AREA MEJORADO -->
                <div class="bg-white p-4 border border-slate-200 rounded-lg shadow-md mb-4 flex justify-center">
                    <div id="qrcode"></div>
                </div>

                <div class="bg-slate-50 p-3 rounded-xl w-full mb-3 border border-slate-200 cursor-pointer hover:bg-slate-100 transition" onclick="copyLink()">
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Enlace Directo</p>
                    <p id="generated-link" class="text-blue-600 font-mono font-bold text-[10px] truncate">...</p>
                </div>

                <button class="w-full bg-[#25D366] text-white font-bold py-3 rounded-xl shadow-lg mb-2 flex items-center justify-center gap-2 text-sm hover:bg-[#20b957] transition" onclick="shareWhatsApp()">
                    <i class="fab fa-whatsapp"></i> Enviar a Alumnos
                </button>
                <button class="w-full bg-white border-2 border-slate-200 text-slate-500 font-bold py-3 rounded-xl text-sm hover:bg-slate-50 transition" onclick="goToRegistration()">
                    Acceder al Examen
                </button>
            </div>

            <!-- 3. REGISTRO ESTUDIANTE -->
            <div id="view-register" class="hidden h-full flex flex-col justify-center p-8 fade-in bg-white">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold text-blue-900">Ingreso Estudiante</h2>
                    <p class="text-xs text-slate-500">Selecciona tus datos correctamente.</p>
                </div>
                
                <div class="space-y-4 mb-6">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <p class="text-[10px] text-blue-400 font-bold uppercase">Evaluación</p>
                        <p id="student-context-display" class="text-sm font-bold text-blue-800">--</p>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1 block mb-1">Soy el alumno(a):</label>
                        <select id="reg-student-select" class="w-full border-2 border-slate-200 bg-white rounded-lg p-3 outline-none text-sm font-medium focus:border-blue-500">
                            <option value="">Cargando lista...</option>
                        </select>
                    </div>
                </div>
                
                <button onclick="startQuiz()" class="w-full btn-primary text-white font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 group">
                    Comenzar <i class="fas fa-arrow-right group-hover:translate-x-1 transition"></i>
                </button>
            </div>

            <!-- 4. QUIZ -->
            <div id="view-student" class="hidden h-full flex flex-col fade-in bg-slate-50">
                <div class="w-full bg-white h-1.5 shadow-sm">
                    <div id="progress-bar" class="bg-yellow-400 h-1.5 transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="p-6 flex-1 flex flex-col relative overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <span class="px-3 py-1 bg-white rounded-full text-xs font-bold text-slate-400 shadow-sm border border-slate-100">
                            <span id="q-current" class="text-blue-600">1</span>/<span id="q-total">5</span>
                        </span>
                        <div class="flex items-center gap-1 text-red-500 font-mono font-bold bg-red-50 px-3 py-1 rounded-full border border-red-100">
                            <i class="far fa-clock"></i> <span id="timer">30</span>s
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 mb-4 flex-1 flex flex-col justify-center">
                        <h3 id="question-text" class="text-lg font-bold text-slate-800 leading-relaxed text-center"></h3>
                    </div>
                    <div id="options-container" class="space-y-2 pb-6"></div>
                </div>
            </div>

            <!-- 5. RESULTADOS -->
            <div id="view-results" class="hidden p-6 h-full flex flex-col fade-in overflow-y-auto bg-slate-50">
                <div class="text-center mb-4">
                    <h2 class="text-xl font-bold text-blue-900">Resultados</h2>
                </div>

                <div class="bg-white rounded-3xl p-4 shadow-sm border border-slate-100 mb-4 flex items-center justify-between">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Nota Oficial</p>
                        <p id="minedu-grade" class="text-5xl font-extrabold text-blue-600 mt-1">--</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Aciertos</p>
                        <p id="final-score" class="text-2xl font-bold text-slate-700">0/0</p>
                    </div>
                </div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 mb-4">
                    <canvas id="resultsChart"></canvas>
                </div>

                <div class="bg-blue-50 border border-blue-100 rounded-2xl p-4 mb-4">
                    <p id="ai-feedback" class="text-xs text-blue-800 leading-relaxed font-medium"></p>
                </div>
                
                <p id="save-status" class="text-[10px] text-slate-400 text-center mb-4 italic animate-pulse">Guardando...</p>

                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="printReport()" class="bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg text-xs uppercase">
                        <i class="fas fa-print mr-1"></i> Imprimir
                    </button>
                    <button onclick="window.location.href = window.location.pathname" class="bg-white border-2 border-slate-200 text-slate-500 font-bold py-3 rounded-xl text-xs uppercase">
                        Salir
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, Timestamp } 
        from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CREDENCIALES COMPARTIDAS ---
        const firebaseConfig = {
          apiKey: "AIzaSyClWwYzro_avn1pK0DvD4x1r4v1grSAoE0",
          authDomain: "registro-jn-andrews-mpc.firebaseapp.com",
          projectId: "registro-jn-andrews-mpc",
          storageBucket: "registro-jn-andrews-mpc.firebasestorage.app",
          messagingSenderId: "701752375464",
          appId: "1:701752375464:web:eaab256668b869d026aa9d"
        };

        // --- 2. BASE DE DATOS LOCAL (Espejo del Registro) ---
        const database = {
            primaria: { "1": ["BOLIVAR HILARIO, Jazmin", "ESTRADA ANCASI, Alisson", "GASPAR VIZCARDO, Alessandro", "HUITTOCCOLLO HUARACCONE, Tania", "LEGUIA VEGA Jairo Isai", "LOZANO COAQUIRA, Jerry Matt", "MAMANI VILLAFUERTE, Estrellita Luz Celeste", "MESCCO OLMEDA, Lucia Camila", "MIRAMIRA GUTIERREZ Emily Valeria", "MOLLEAPAZA VALERIANO, Isabella Romina", "MONTEZA FLORIAN, Jheyli Katherine", "MORAN GOZME, Brenda Nicol", "MOROCHARA HUACCHA, Arthur Dylan", "PUERTAS AGUILAR Kalet Gael", "QUISPE MARIN, Stefano Fabián", "RAMOS TICONA, Liam Caleb", "TORRES CHISI, Luciana Michelle", "ZEGARA ANDRADE Maritza Noemí"], "2": ["CALCINA QUISPE Nicole Kiara", "CHAMBI CHAMBI Lucy Cristel", "CHOQUEPATA MAMANI Ayddam Mateo", "DIAZ CAPACOILA, Greissy Camila", "GUZMAN CCAMA Dorud Emir", "HUAMANI HUALLA Sofía Guadalupe", "HUAYCHO HUACANI, Lucero Krissia", "MAMANI APAZA Leonard Josías", "MONTEZA RIVAS Geral Mihael", "OCSA LLANQUIRE Thiago Hernán", "ORTEGA QUISPE Kaleb Richard", "PONCE CARDENAS Lía Antonella", "RAVELO PACCO, Arjen Thyago", "SACSI QUISPE Yelina Maite", "SALAZAR PÉREZ Juan David", "TAIPE DE LA CRUZ Vasthy Andrea", "TORRES PAUCCARA Marcos Sebastián", "VILLAFUERTE TICONA Luis Ángel"], "3": ["AMANQUI YANARICO, Ana Divora", "ARIZA CASTRO Antonela Kendall", "AROCUTIPA MAMANI, Roció Yamileth", "CALCINA MURILLO, Thiago Jhunior", "CCANCHILLO TORRES, Jesús Franco", "CHAMBI VILCA Nicol Abigail", "CONDORI QUISPE, Raquel Amira", "HUITTOCCOLLO HUARACCONE, Jhans Roly", "MAMANI QUISPE, Dayana Nicol", "MAMANI QUISPE, Shirley Abigail", "MAMANI RAMOS, Lesly Abigail", "MAQUERA ROMERO, Esteyci Alejandra", "MELENDEZ PEÑAFIEL, Dayiro Albert", "MELENDEZ PEÑAFIEL, Moisés Leonel", "MOLLEAPAZA VALERIANO, Evangelina Shamara", "OSORIO IMATA, Keyla", "PACCO LOPE, Lionard Griezmann", "QUELLCA CHOQUEPATA, Thiago Luan", "QUISPE CAMALA, José Manuel", "QUISPE CAMALA, Juan Manuel", "QUISPE CHAUPI, Misael Matías"], "4": ["ANCCALLE MERMA, Jesús", "APAZA GIRALDO NICOLAS NEYMAR", "CHOQUENAIRA PONTECIL, Neymar", "CORDERO MONTEZ, Williannys Anabella", "CUTIMBO TACUMA, Esaú Alvaro", "GUZMAN SEVILLANO, Sebastián Lian", "HUARICCALLO HUACHO Clhoe Allison", "MAMANI PAUCCAR, Zaza Jeison", "PHALA TORRES, Israel José", "QUISPE HUAMANI, Angie Medeley", "QUISPE QUISPE, Luz Kiara", "VALDEZ SUNI, Evelyn Adaluz", "YAULI QUISPE, Zebasthian Luis"], "5": ["ANCASI VILLAFUETE Andrea Edith", "APAZA MAMANI Mateo Jacob", "AROCUTIPA MAMANI Dayiro Jheampol", "BATALLANOS SALHUA Alía Luz", "BELÓN AQUINO Joaquín Jhared", "CAPRISTANO AYNAYA Yamilett lucero", "CHORA COAQUIRA Tiago Mateo", "CRUZ ROJAS Nicole", "GUZMAN CCAMA Sebastián Rodrigo", "HUITTOCCOLLO HUARACCONE Leydi Nicol", "LAURA SUPA Hebert Antony", "LIZARRAGA TICONA Dylan Caleb", "MACHUCA CRUZ Ghislaine", "MAMANI ROJAS Alejandra Celeste", "MANCHA COAQUIRA Wilmar Junior", "MIRAMIRA GUTIERREZ Elías Samuel", "OCSA LLANQUIRE Brianna jazmin", "PACCO LOPE Naydelyn Candy", "QUISPE MARAS Eymi Alondra", "QUISPE QUISPE Eduardo Sebastián", "RUIZ TITO Arjen Brenner", "SACSI QUISPE Romina Yamilet", "TAIPE DE LA CRUZ Nerina", "YNOFUENTE CANAHUIRI Sheyla Nicole", "YUCRA SULLA Ian Luis Eidan"], "6": ["BARRIONUEVO CASTRO, Jeyko Paul", "BRINGAS JUAREZ, Bryams Jhamilth", "CALCINA MURILLO, Nicol Nataly", "CALDERON CARDENAS, Kiara Samira", "CAMI VILLAVICENCIO, Yhojan Yoset", "COAQUIRA CONDO, Briseth Ashlee", "DE LA CRUZ CONDORI, Jorvic Steeven", "ESTRADA ANCASI, Joshemir Anthony", "GASPAR VIZCARDO, Randy Oscar", "LIPA CASCAMAYTA, Rouse Perla Nicole", "LLANQUE ALMIRON, Hassiel Brigitte", "MANCHA MAMANI, Yidda Abigail", "MANCHA ROJAS, Dheivy Maycol", "OSORIO IMATA, Liz", "PALOMINO REYES, Naomi Eliana", "PEÑA ARANIBAR, Rihana Franshesca", "QUISPE CAMALA, Ana Gabriela", "SANTILLAN NEYRA, Cristhoper Luis Ángel", "TICONA RIOS, Jhon Joshiro", "VARGAS CHOQUE, Patrick Rodrigo", "YAULI QUISPE, Juan Diego"] },
            secundaria: { "1": ["ARUCUTIPA CALISAYA Yuliet Luanna", "CISA SAHUAYANAY Miguel Ángel", "COLQUE CHAMBI Jhems Kevin", "CRUZ ROJAS Jhon Alex", "CUYO CHOQUE Will Adriano", "GALLEGOS ZEA, James Jamir", "GUETTI RUIZ Johana Nicol", "GUTIERREZ OSORIO, Rony Alex", "GUTIERREZ ZAMATA, Gianela Ninel", "MENDOZA MAMANI, Víctor Manuel", "MONTEZA RIVAS Yair Alexander", "SANGUINO MARQUEZ Carlos Santiago", "TICONA CONDORI Heidy Milena", "VIÑA HUAMAN Esteban Andreus Caleb", "ZEVALLOS MAMANI Alisom Kimberly"], "2": ["AGUILAR TILCA, Midwad Harison", "ARMAS PEÑA, Moisés Jubal", "ARUCUTIPA CALISAYA, Emerson garry", "BELÓN AQUINO, Dayiro Andree", "CALDERON LEANDRO, Yhong Puyol.", "CALLOAPAZA CONDORCAHUANA Jhamile Sadira", "CCANCHILLO TORRES, Yulissam Priyanka", "CHOQUE LIZARRAGA, Piero Valentino", "CHOQUEHUANCA CARI, Nicole Mia Marey", "COAQUIRA CONDO, Llandhel Roberth", "CONDORI QUISPE, Mayli Yasu", "CORIMANYA ARISACA, Branco Adriano", "DIAZ CAPACOILA, Anely Yesica", "HUAYHUA HUITTOCCOLLO Alonso Delbir", "LUNA QUISPE, Jimmy Noé", "LUQUE VILCAPAZA, Eva Luz", "MANCHA COAQUIRA, George Luis", "PEREIRA VILCA Neymar Piero", "PEREZ LUPO, Gerald Abdías", "PHALA TORRES, Benjamín Franco", "QUISPE CAMALA, José Daniel", "QUISPE GUTIERREZ, Ana Cristina", "QUISPE QUISPE, Thalía Úrsula", "RIVEROS SUPA, Mathias Leonardo", "VILCA GUTIERREZ, Jandy Betzabe"], "3": ["AMANQUI YANARICO, Jean Paul", "ANCCALLE MERMA, Danna Magdiell", "APAZA MAMANI, Eduardo Nicolás", "AROCUTIPA ROMERO, Zamir Yhonncy", "BELÓN AQUINO, Fabrizio André", "CHOQUEHUANCA CARI, David Yair", "FALCON PUMA, Enoc Elías", "GARCIA CISA SANTIAGO BENJAMIN", "GARCIA TICONA Emanuel Matías", "HANAMPA QUISPE, Erick Jonathan", "MACHUCA CRUZ Baurulet", "MALPARTIDA ALE Alvaro Joaquín", "MAMANI ANAYA Sebastián Mateo", "MARQUEZ TACURI, Jesús", "MERMA MENDOZA, Roberto Maradona", "MIRAMIRA GUTIERREZ, Josías Daniel", "ORTEGA BENAVENTE, Nill Antony", "OSORIO CCACCA Marisol", "ROQUE HUARCA, Dianeth Nicol", "TOTORA CUCHO Yuliana Nery", "VALDEZ SUNI, Luz Maricielo", "VARGAS CARI Marylin Elena Josenit"], "4": ["BRINGAS JUAREZ Brandon", "CANAZA QUISPE Luis Eduardo", "CARDENAS CARDENAS Vivian Maryel", "CONDORI QUISPE Abel Benjamín", "GARCIA TICONA Angie Ruth", "GUTIERREZ ALVAREZ Lisandro", "JANAMPA LIMA Jeff Dacio", "LLANQUE ALMIRON Yader Jocsan", "MOLLEAPAZA VALERIANO Yesybell Analia", "SALAZAR PEREZ Juan Hersy", "SANGUINO MARQUEZ Daylen", "VILCA ALVAREZ Rodrigo Alejandro", "VIÑA HUAMAN Brayan Andrés"], "5": ["APAZA GAMARRA German Enrique", "AYALA PEÑAFIEL Diego Gabriel", "CALCINA QUISPE Lizeth Sheyla", "CAMI VILLAVICENCIO Olger Eliel", "CONDORI ANAHUA Abigail Dorkas", "CONDORI ANAHUA Jetzabe María del Pilar", "CORDOVA OVADA Gabriel Gedeón", "CUTIMBO TACUMA David Alexander", "HANAMPA QUISPE Rubí Alejandra", "HUAMAN CANAHUIRI, Frank Antony", "HUARCAYA COILA STEFANY", "MARIN CHOQUE Fredy Erick", "ORCOAPAZA MAMANI Johan Joel", "PALO AGUILAR Yanira Brendaly", "QUISPE CAMALA Kevin Andi", "QUISPE CHOQUE Oliver Omar", "SANCHEZ PEROZO Oriana Valentina", "SANO MAMANI Jenny Abigail", "SUPANTA HUACHANI Angely", "VARGAS ALANOCA Maryori Nayomi"] }
        };

        let db, auth;
        let userId = "PROFESOR_MANUEL"; // ID FIJO PARA SINCRONIZACIÓN
        let isFirebaseActive = false;

        // INIT FIREBASE
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            signInAnonymously(auth).then(() => {
                isFirebaseActive = true;
                console.log("Conectado a la nube del Profesor Manuel");
            }).catch(e => console.error("Error login:", e));
        } catch(e) { console.error(e); }

        // --- ESTADO APP ---
        let currentQuestions = [];
        let currentIdx = 0;
        let score = 0;
        let timer = 30;
        let interval;
        let timePerQuestion = 30;
        
        let sessionConfig = { 
            bimestre: "", area: "", nivel: "", grado: "", prompt: "", 
            start: null, end: null 
        };
        let studentData = { index: -1, name: "" };
        let userAnswers = [];

        // PREGUNTAS MOCK (Fallback por si no hay API Key)
        const mockDB = {
            primaria: [ { q: "¿Capital de Perú?", opts: ["Lima", "Cusco", "Arequipa", "Piura"], a: 0 }, { q: "¿5 + 3?", opts: ["10", "8", "6", "9"], a: 1 }, { q: "Animal mamífero", opts: ["Sapo", "Trucha", "Perro", "Loro"], a: 2 } ],
            secundaria: [ { q: "¿Autor de 'El Quijote'?", opts: ["Dante", "Cervantes", "Homero", "Vallejo"], a: 1 }, { q: "Símbolo Au", opts: ["Plata", "Cobre", "Oro", "Hierro"], a: 2 }, { q: "Raíz de 144", opts: ["10", "11", "12", "13"], a: 2 } ]
        };

        // --- INICIALIZACIÓN: DETECTAR MODO ALUMNO POR URL O QUERY PARAM ---
        window.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            
            // SI HAY UN ID DE EXAMEN (?q=...)
            const quizId = params.get('q');
            if (quizId) {
                console.log("Cargando examen ID:", quizId);
                // Bloquear vista profesor
                document.getElementById('view-teacher').classList.add('hidden');
                
                if (isFirebaseActive || db) {
                    try {
                        const docRef = doc(db, `artifacts/1:701752375464:web:eaab256668b869d026aa9d/users/${userId}/examenes_creados`, quizId);
                        const snap = await getDoc(docRef);
                        if (snap.exists()) {
                            const data = snap.data();
                            // Cargar Config
                            sessionConfig = data.config;
                            // Convertir fechas string a Date si existen
                            if(sessionConfig.start) sessionConfig.start = new Date(sessionConfig.start.seconds * 1000);
                            if(sessionConfig.end) sessionConfig.end = new Date(sessionConfig.end.seconds * 1000);
                            
                            timePerQuestion = parseInt(sessionConfig.time);
                            currentQuestions = data.questions;
                            
                            // Ir a registro
                            goToRegistration();
                        } else {
                            alert("Examen no encontrado o eliminado.");
                        }
                    } catch (e) { console.error("Error cargando examen", e); }
                }
            } else {
                // Modo Profesor (Por defecto)
                updateGrades(); 
            }
        });

        // --- UI HELPERS ---
        window.updateGrades = () => {
            const n = document.getElementById('select-nivel').value;
            const g = document.getElementById('select-grado');
            g.innerHTML = '';
            const max = n === 'primaria' ? 6 : 5;
            for(let i=1; i<=max; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = i + '° Grado';
                g.appendChild(opt);
            }
        };

        // FUNCIÓN DE CARGA DE ARCHIVOS
        window.handleFileUpload = (input) => {
            const file = input.files[0];
            if(file) {
                const dropzone = document.getElementById('upload-container');
                dropzone.classList.remove('border-blue-200', 'bg-blue-50/50');
                dropzone.classList.add('border-green-300', 'bg-green-50');
                dropzone.querySelector('p').innerText = `Archivo: ${file.name}`;
                dropzone.querySelector('i').className = "fas fa-check-circle text-green-500 text-lg";
                
                if(file.type === "text/plain") {
                    const reader = new FileReader();
                    reader.onload = (e) => { document.getElementById('input-text').value = e.target.result; };
                    reader.readAsText(file);
                } else {
                    alert("✅ Archivo cargado correctamente. Asegúrese de escribir un breve resumen o tema en el cuadro de texto para ayudar a la IA.");
                }
            }
        };

        // --- IA: GENERACIÓN DE PREGUNTAS ---
        function getAIKey() {
            let key = localStorage.getItem('gemini_api_key');
            if(!key) {
                key = prompt("Para generar preguntas con IA, ingrese su API Key de Gemini:");
                if(key) localStorage.setItem('gemini_api_key', key);
            }
            return key;
        }

        window.previsualizarExamen = async () => {
            const btn = document.querySelector('button[onclick="previsualizarExamen()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analizando Texto...';
            btn.disabled = true;

            // Recoger config
            sessionConfig.nivel = document.getElementById('select-nivel').value;
            sessionConfig.grado = document.getElementById('select-grado').value;
            sessionConfig.area = document.getElementById('select-area').value;
            sessionConfig.bimestre = document.getElementById('select-bimestre').value;
            sessionConfig.prompt = document.getElementById('input-text').value;
            
            const qCount = parseInt(document.getElementById('select-count').value);
            const time = parseInt(document.getElementById('select-time').value);
            sessionConfig.time = time;

            // IA GENERATION
            const apiKey = getAIKey();
            
            // Si el cuadro de texto está vacío o muy corto, alertar
            if (sessionConfig.prompt.length < 5) {
                alert("Por favor escriba un tema o pegue el contenido del archivo en el cuadro de texto.");
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                return;
            }

            if (apiKey) {
                try {
                    const prompt = `Actúa como profesor. Genera un examen de ${qCount} preguntas de opción múltiple sobre este texto/tema: "${sessionConfig.prompt}".
                    Nivel: ${sessionConfig.nivel} ${sessionConfig.grado}°.
                    Formato JSON array: [{ "q": "Pregunta", "opts": ["A", "B", "C", "D"], "a": indice_correcta_0_a_3 }]`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({contents:[{parts:[{text:prompt}]}], generationConfig:{responseMimeType:"application/json"}})
                    });
                    
                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);
                    currentQuestions = JSON.parse(data.candidates[0].content.parts[0].text);
                } catch (e) {
                    console.error("Error IA", e);
                    alert("⚠️ No se pudo conectar con la IA. Verifique su API Key o internet. Usando preguntas de ejemplo.");
                    generateMockQuestions(qCount);
                }
            } else {
                alert("No se ingresó API Key. Usando preguntas de ejemplo.");
                generateMockQuestions(qCount);
            }

            // RENDERIZAR REVISIÓN
            const container = document.getElementById('review-container');
            container.innerHTML = '';
            
            currentQuestions.forEach((q, i) => {
                container.innerHTML += `
                <div class="bg-white p-3 rounded border border-slate-200 shadow-sm relative group">
                    <p class="text-xs font-bold text-slate-400 mb-1">Pregunta ${i+1}</p>
                    <textarea class="w-full text-sm font-bold text-slate-800 border-b border-slate-200 focus:border-blue-500 outline-none mb-2" onchange="updateQuestion(${i}, 'q', this.value)">${q.q}</textarea>
                    <div class="grid grid-cols-2 gap-2">
                        ${q.opts.map((opt, oi) => `
                            <div class="flex items-center gap-1">
                                <input type="radio" name="q${i}" ${q.a === oi ? 'checked' : ''} onchange="updateQuestion(${i}, 'a', ${oi})">
                                <input type="text" class="w-full text-xs text-slate-600 border-b border-slate-100 outline-none" value="${opt}" onchange="updateOption(${i}, ${oi}, this.value)">
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            });

            showView('view-review');
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        };

        function generateMockQuestions(count) {
            let base = mockDB[sessionConfig.nivel];
            currentQuestions = [];
            for(let i=0; i<count; i++) {
                let q = {...base[i % base.length]}; 
                if(i >= base.length) q.q += ` (Var. ${i+1})`;
                currentQuestions.push(q);
            }
        }

        window.updateQuestion = (idx, field, val) => { currentQuestions[idx][field] = val; };
        window.updateOption = (qIdx, oIdx, val) => { currentQuestions[qIdx].opts[oIdx] = val; };

        // --- PUBLICAR EXAMEN (SAVE TO FIREBASE & GENERATE LINK) ---
        window.publicarExamenDefinitivo = async () => {
            const btn = document.querySelector('button[onclick="publicarExamenDefinitivo()"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publicando...';
            btn.disabled = true;

            const startVal = document.getElementById('quiz-start').value;
            const endVal = document.getElementById('quiz-end').value;
            sessionConfig.start = startVal ? new Date(startVal) : null;
            sessionConfig.end = endVal ? new Date(endVal) : null;

            if (isFirebaseActive) {
                try {
                    // Guardar definición del examen
                    const docRef = await addDoc(collection(db, `artifacts/1:701752375464:web:eaab256668b869d026aa9d/users/${userId}/examenes_creados`), {
                        config: sessionConfig,
                        questions: currentQuestions,
                        createdAt: Timestamp.now()
                    });

                    // Generar Link Corto
                    const baseUrl = window.location.href.split('?')[0]; 
                    const finalLink = `${baseUrl}?q=${docRef.id}`;
                    
                    document.getElementById('generated-link').innerText = finalLink;
                    
                    // QR Code (Menos denso y más grande)
                    document.getElementById('qrcode').innerHTML = "";
                    new QRCode(document.getElementById("qrcode"), {
                        text: finalLink,
                        width: 200,
                        height: 200,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.L
                    });

                    showView('view-link');

                } catch (e) {
                    console.error("Error publicando", e);
                    alert("Error al guardar en la nube.");
                }
            } else {
                alert("Error de conexión con la base de datos.");
            }
            btn.innerHTML = '<i class="fas fa-check-circle"></i> Aprobar y Publicar';
            btn.disabled = false;
        };

        window.copyLink = () => {
            const link = document.getElementById('generated-link').innerText;
            navigator.clipboard.writeText(link).then(() => alert("¡Enlace copiado!"));
        }

        window.shareWhatsApp = () => {
            const link = document.getElementById('generated-link').innerText;
            const text = `Examen de ${sessionConfig.area.toUpperCase()} (${sessionConfig.grado}°): ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        window.goToRegistration = () => {
            // Validar Horario
            const now = new Date();
            if(sessionConfig.start && now < sessionConfig.start) return alert(`Aún no inicia. Hora: ${sessionConfig.start.toLocaleString()}`);
            if(sessionConfig.end && now > sessionConfig.end) return alert(`Examen finalizado. Cierre: ${sessionConfig.end.toLocaleString()}`);

            // Cargar lista
            const list = database[sessionConfig.nivel][sessionConfig.grado];
            const select = document.getElementById('reg-student-select');
            
            document.getElementById('student-context-display').innerText = 
                `${sessionConfig.grado}° ${sessionConfig.nivel.toUpperCase()} - ${sessionConfig.area.toUpperCase()}`;
            
            select.innerHTML = '<option value="">Selecciona tu nombre...</option>';
            if(list) {
                list.forEach((name, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx; 
                    opt.innerText = name;
                    select.appendChild(opt);
                });
            } else {
                select.innerHTML = '<option>No hay lista cargada</option>';
            }

            showView('view-register');
        };

        window.startQuiz = () => {
            const idx = document.getElementById('reg-student-select').value;
            if(idx === "") return alert("Por favor selecciona tu nombre de la lista.");
            
            const list = database[sessionConfig.nivel][sessionConfig.grado];
            studentData.index = parseInt(idx);
            studentData.name = list[idx];

            score = 0; currentIdx = 0;
            userAnswers = new Array(currentQuestions.length).fill(null);
            showView('view-student');
            loadQuestion();
        };

        function loadQuestion() {
            if(currentIdx >= currentQuestions.length) return endQuiz();
            
            const q = currentQuestions[currentIdx];
            document.getElementById('question-text').innerText = q.q;
            document.getElementById('q-current').innerText = currentIdx + 1;
            document.getElementById('q-total').innerText = currentQuestions.length;
            
            const pct = (currentIdx / currentQuestions.length) * 100;
            document.getElementById('progress-bar').style.width = `${pct}%`;

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            q.opts.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-xl border border-slate-200 hover:bg-blue-50 transition flex items-center group";
                btn.innerHTML = `<span class="w-6 h-6 rounded-full bg-slate-100 text-slate-500 text-xs flex items-center justify-center mr-3 font-bold group-hover:bg-blue-500 group-hover:text-white transition">${String.fromCharCode(65+i)}</span> <span class="text-sm text-slate-700 font-medium">${opt}</span>`;
                btn.onclick = () => checkAnswer(i, btn);
                container.appendChild(btn);
            });

            clearInterval(interval);
            timer = timePerQuestion;
            document.getElementById('timer').innerText = timer;
            interval = setInterval(() => {
                timer--;
                document.getElementById('timer').innerText = timer;
                if(timer <= 0) checkAnswer(-1, null);
            }, 1000);
        }

        function checkAnswer(selIdx, btn) {
            clearInterval(interval);
            userAnswers[currentIdx] = selIdx;
            
            const correct = currentQuestions[currentIdx].a;
            if(selIdx === correct) {
                score++;
                if(btn) {
                    btn.classList.remove('hover:bg-blue-50');
                    btn.classList.add('bg-green-50', 'border-green-500', 'text-green-700');
                    btn.querySelector('span').classList.add('bg-green-500', 'text-white');
                }
            } else if (btn) {
                btn.classList.remove('hover:bg-blue-50');
                btn.classList.add('bg-red-50', 'border-red-500', 'text-red-700');
                btn.querySelector('span').classList.add('bg-red-500', 'text-white');
            }

            currentIdx++;
            setTimeout(loadQuestion, 800);
        }

        async function endQuiz() {
            showView('view-results');
            const total = currentQuestions.length;
            const pct = (score/total)*100;
            const gradeInfo = getMineduGrade(pct);
            
            document.getElementById('minedu-grade').innerText = gradeInfo.letter;
            document.getElementById('minedu-grade').className = `text-5xl font-extrabold mt-1 ${gradeInfo.color}`;
            document.getElementById('final-score').innerText = `${score}/${total}`;
            document.getElementById('ai-feedback').innerText = gradeInfo.desc;
            
            drawChart(score, total);
            
            // --- SINCRONIZACIÓN CON REGISTRO OFICIAL ---
            const statusEl = document.getElementById('save-status');
            
            if(isFirebaseActive) {
                try {
                    // ID único por sesión/día para que no se sobreescriba si toman varios el mismo día
                    // Pero para mantener compatibilidad con el registro, usamos una estructura predecible
                    const today = new Date().toISOString().split('T')[0];
                    const docId = `registro-${sessionConfig.bimestre}-${sessionConfig.nivel}-${sessionConfig.grado}-${sessionConfig.area}-${today}`;
                    
                    const docRef = doc(db, `artifacts/1:701752375464:web:eaab256668b869d026aa9d/users/${userId}/registros_auxiliares`, docId);
                    
                    const snap = await getDoc(docRef);
                    let data = { notas: {}, headers: {}, prompt: `Evaluación: ${sessionConfig.prompt.substring(0,30)}...` };
                    
                    if(snap.exists()) { data = snap.data(); } 
                    else {
                        data.headers = { "header-C1-0": "Examen Virtual", "header-C1-1": "Participación" };
                    }
                    
                    data.notas[`nota-${studentData.index}-C1-0`] = gradeInfo.letter;
                    data.notas[`asistencia-${studentData.index}`] = "A";
                    
                    await setDoc(docRef, data, { merge: true });
                    
                    statusEl.innerText = "✅ Nota registrada en el cuaderno auxiliar del profesor.";
                    statusEl.className = "text-[10px] text-green-600 font-bold text-center mb-4";
                    
                } catch(e) {
                    console.error("Error sync:", e);
                    statusEl.innerText = "⚠️ Nota guardada en dispositivo (Error de red).";
                }
            } else {
                statusEl.innerText = "⚠️ Modo Demo (Sin conexión)";
            }
        }

        function showView(id) {
            ['view-teacher','view-review','view-link','view-register','view-student','view-results'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function getMineduGrade(p) {
            if(p >= 85) return { letter: "AD", color: "text-blue-700", desc: "¡Logro Destacado! Excelente desempeño." };
            if(p >= 70) return { letter: "A", color: "text-green-700", desc: "Logro Esperado. Buen trabajo." };
            if(p >= 50) return { letter: "B", color: "text-yellow-600", desc: "En Proceso. Sigue practicando." };
            return { letter: "C", color: "text-red-600", desc: "En Inicio. Necesitas reforzamiento." };
        }

        function drawChart(s, t) {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            ctx.clearRect(0,0,300,150);
            const h1 = (s/t)*120;
            const h2 = ((t-s)/t)*120;
            ctx.fillStyle="#22c55e"; ctx.fillRect(100, 140-h1, 40, h1);
            ctx.fillStyle="#ef4444"; ctx.fillRect(160, 140-h2, 40, h2);
            ctx.fillStyle="#333"; ctx.font="bold 12px sans-serif";
            ctx.fillText("✔", 112, 155); ctx.fillText("✖", 172, 155);
        }

        // Globales
        window.showView = showView;
        window.printReport = () => {
            document.getElementById('print-student').innerText = studentData.name;
            document.getElementById('print-date').innerText = new Date().toLocaleDateString();
            document.getElementById('print-grade').innerText = `${sessionConfig.grado}° ${sessionConfig.nivel.toUpperCase()}`;
            document.getElementById('print-score').innerText = `${document.getElementById('minedu-grade').innerText} (${score}/${currentQuestions.length})`;
            const det = document.getElementById('print-details');
            det.innerHTML = '';
            currentQuestions.forEach((q, i) => {
                const u = userAnswers[i];
                const ok = u === q.a;
                det.innerHTML += `<div class="border-b p-2 text-xs flex justify-between"><span>${i+1}. ${q.q}</span><span class="${ok?'text-green-600':'text-red-600'} font-bold">${ok?'CORRECTO':'INCORRECTO'}</span></div>`;
            });
            window.print();
        };
    </script>
</body>
</html>