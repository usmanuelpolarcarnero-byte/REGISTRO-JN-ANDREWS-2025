<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduGen AI - I.E. JN ANDREWS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuente Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Librer√≠a QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- LIBRER√çAS PARA LEER ARCHIVOS (PDF y WORD) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .glass-header {
            background: rgba(30, 58, 138, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 4px solid #FACC15;
        }
        
        .card-shadow { box-shadow: 0 10px 40px -10px rgba(30, 58, 138, 0.2); }
        
        .btn-primary {
            background: linear-gradient(135deg, #1E3A8A 0%, #2563EB 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .btn-primary:active { transform: scale(0.98); }

        canvas { background-color: #f8fafc; border-radius: 1rem; width: 100% !important; height: 200px !important; }
        
        @media print {
            body * { visibility: hidden; }
            #printable-report, #printable-report * { visibility: visible; }
            #printable-report { position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 20px; z-index: 9999; }
            .no-print { display: none !important; }
        }
        #printable-report { display: none; }
        @media print { #printable-report { display: block; } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Modal de Alerta Fraude */
        .fraud-alert { animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen flex items-center justify-center p-4 text-gray-800">

    <!-- REPORTE DE IMPRESI√ìN (DOCENTE) -->
    <div id="printable-report">
        <div class="border-b-2 border-yellow-400 pb-4 mb-6 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="image_9d4f3d.jpg" alt="Logo" style="width: 60px; height: auto;">
                <div>
                    <h1 class="text-2xl font-bold text-blue-900">I.E. J.N. ANDREWS</h1>
                    <p class="text-sm text-gray-500">Reporte de Resultados - Prof. Manuel Polar</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-400">Fecha de Impresi√≥n</p>
                <p class="font-mono text-sm" id="rep-date">--/--/----</p>
            </div>
        </div>
        
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
            <h3 class="font-bold text-lg text-slate-800" id="rep-title">Examen de...</h3>
            <p class="text-sm text-slate-500" id="rep-subtitle">Grado - Nivel - √Årea</p>
        </div>

        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="border-b-2 border-slate-800">
                    <th class="py-2 text-xs uppercase">Estudiante</th>
                    <th class="py-2 text-xs uppercase text-center">Nota</th>
                    <th class="py-2 text-xs uppercase text-center">Nivel (MINEDU)</th>
                    <th class="py-2 text-xs uppercase text-right">Fecha</th>
                </tr>
            </thead>
            <tbody id="rep-body" class="text-sm">
                <!-- Se llena din√°micamente -->
            </tbody>
        </table>

        <div class="mt-12 text-center text-xs text-gray-400 border-t border-gray-200 pt-4">
            <p>Documento generado por EduGen AI - Sistema de Gesti√≥n Pedag√≥gica</p>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div class="bg-white w-full max-w-md rounded-3xl card-shadow overflow-hidden fade-in relative min-h-[750px] flex flex-col border border-white/50 no-print">
        
        <!-- HEADER -->
        <div class="glass-header p-5 text-white shadow-lg z-20 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-400 rounded-full mix-blend-overlay opacity-20 blur-2xl"></div>
            <div class="flex items-center gap-4 relative z-10">
                <div class="w-16 h-16 bg-white rounded-xl flex items-center justify-center shadow-lg p-1 shrink-0 border-2 border-yellow-400">
                    <img src="image_9d4f3d.jpg" alt="Escudo" class="w-full h-full object-contain">
                </div>
                <div class="flex-1">
                    <h2 class="text-[10px] font-bold text-yellow-300 tracking-widest uppercase mb-0.5">Instituci√≥n Educativa</h2>
                    <h1 class="font-extrabold text-xl leading-tight">J.N. ANDREWS</h1>
                    <div class="h-0.5 w-10 bg-yellow-400 my-1 rounded-full"></div>
                    <p class="text-[11px] text-blue-100 font-medium flex items-center gap-1">
                        <i class="fas fa-chalkboard-teacher text-yellow-400"></i> Prof. Manuel Polar Carnero
                    </p>
                </div>
            </div>
            <!-- Bot√≥n Home para Profesor -->
            <button onclick="window.location.href = window.location.pathname" class="absolute top-4 right-4 bg-white/10 hover:bg-white/20 p-2 rounded-lg backdrop-blur-sm transition text-yellow-300 border border-white/10 shadow-sm" title="Inicio">
                <i class="fas fa-home text-lg"></i>
            </button>
        </div>

        <!-- VISTAS -->
        <div class="flex-1 overflow-hidden relative bg-slate-50">
            
            <!-- 1. DOCENTE: DASHBOARD (NUEVO) -->
            <div id="view-dashboard-docente" class="p-6 h-full overflow-y-auto flex flex-col gap-4">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-sm font-bold text-slate-500 uppercase">Panel de Control</h2>
                    <button onclick="configurarIA()" class="text-[10px] bg-purple-100 text-purple-700 px-3 py-1 rounded-full border border-purple-200 hover:bg-purple-200 font-bold flex items-center gap-1 shadow-sm">
                        üîë Configurar IA
                    </button>
                </div>

                <div class="flex gap-2 mb-2">
                    <button onclick="showView('view-teacher')" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl shadow text-xs uppercase flex items-center justify-center gap-2">
                        <i class="fas fa-plus-circle"></i> Nuevo Examen
                    </button>
                    <button onclick="loadExamList()" class="flex-1 bg-white border-2 border-slate-200 text-slate-600 font-bold py-3 rounded-xl shadow-sm text-xs uppercase flex items-center justify-center gap-2">
                        <i class="fas fa-list"></i> Mis Ex√°menes
                    </button>
                </div>

                <div id="exam-list-container" class="space-y-3 hidden">
                    <p class="text-xs font-bold text-slate-400 uppercase ml-1">Historial de Evaluaciones</p>
                    <div id="exam-list-items" class="space-y-2">
                        <!-- Lista de ex√°menes se inyecta aqu√≠ -->
                        <div class="text-center py-10 text-slate-400"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>
                    </div>
                </div>

                <!-- Vista por defecto: Crear Examen (se reutiliza view-teacher content) -->
                <div id="create-exam-wrapper"></div>
            </div>

            <!-- 1.1 DOCENTE: CREAR -->
            <div id="view-teacher" class="p-6 h-full overflow-y-auto flex flex-col gap-4">
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-lg bg-blue-100 text-blue-700 flex items-center justify-center text-sm"><i class="fas fa-magic"></i></span>
                        Generar
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="configurarIA()" class="text-[10px] bg-purple-50 text-purple-600 border border-purple-200 px-2 py-1 rounded hover:bg-purple-100 font-bold" title="Cambiar Llave IA">
                            üîë IA Key
                        </button>
                        <button onclick="showDashboard()" class="text-xs text-blue-600 font-bold hover:underline">Ver Historial</button>
                    </div>
                </div>
                
                <!-- ZONA DE CARGA REAL -->
                <input type="file" id="hidden-file-input" class="hidden" accept=".pdf,.txt,.doc,.docx" onchange="handleFileUpload(this)">
                <div id="upload-container" class="border-2 border-dashed border-blue-200 bg-blue-50/50 rounded-2xl p-4 text-center hover:bg-blue-50 transition cursor-pointer group relative" onclick="document.getElementById('hidden-file-input').click()">
                    <!-- Loader Overlay -->
                    <div id="file-loading" class="hidden absolute inset-0 bg-white/90 flex flex-col items-center justify-center rounded-2xl z-10">
                        <i class="fas fa-circle-notch fa-spin text-blue-600 text-2xl"></i>
                        <p class="text-xs text-blue-600 font-bold mt-2">Procesando archivo...</p>
                    </div>
                    <div class="bg-white text-blue-600 w-10 h-10 rounded-full flex items-center justify-center mx-auto mb-2 shadow-sm group-hover:scale-110 transition border border-blue-100">
                        <i class="fas fa-cloud-upload-alt text-lg"></i>
                    </div>
                    <p class="text-xs font-bold text-slate-600">Clic para Subir Archivo</p>
                    <p class="text-[9px] text-slate-400 mt-1">PDF, Word o Texto plano</p>
                </div>
                
                <textarea id="input-text" class="w-full border border-slate-200 rounded-2xl p-4 text-sm focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none resize-none h-24 shadow-sm placeholder:text-slate-400" placeholder="El contenido del archivo aparecer√° aqu√≠..."></textarea>
                
                <div class="bg-blue-50 border border-blue-100 p-3 rounded-xl">
                    <p class="text-[10px] font-bold text-blue-800 uppercase mb-2">Configuraci√≥n Acad√©mica</p>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <select id="select-bimestre" class="w-full text-xs p-2 rounded border border-slate-200 font-semibold text-slate-700"><option value="B1">I Bimestre</option><option value="B2">II Bimestre</option><option value="B3">III Bimestre</option><option value="B4">IV Bimestre</option></select>
                        <select id="select-area" class="w-full text-xs p-2 rounded border border-slate-200 font-semibold text-slate-700"><option value="arte">Arte y Cultura</option><option value="dpcc">DPCC</option><option value="ept">EPT</option></select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="select-nivel" class="w-full text-xs p-2 rounded border border-slate-200 font-semibold text-slate-700" onchange="updateGrades()"><option value="primaria">Primaria</option><option value="secundaria">Secundaria</option></select>
                        <select id="select-grado" class="w-full text-xs p-2 rounded border border-slate-200 font-semibold text-slate-700"></select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
                        <label class="text-[10px] font-bold text-slate-400 uppercase block">Preguntas</label>
                        <select id="select-count" class="w-full text-xs font-semibold text-slate-700 bg-transparent outline-none"><option value="3">3</option><option value="5">5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option></select>
                    </div>
                    <div class="bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
                        <label class="text-[10px] font-bold text-slate-400 uppercase block">Tiempo</label>
                        <select id="select-time" class="w-full text-xs font-semibold text-slate-700 bg-transparent outline-none"><option value="15">15s</option><option value="30" selected>30s</option><option value="60">1m</option><option value="120">2m</option></select>
                    </div>
                </div>

                <!-- FECHAS -->
                <div class="bg-white rounded-xl p-3 border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2"><i class="far fa-clock"></i> Disponibilidad (Opcional)</p>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="datetime-local" id="quiz-start" class="w-full bg-slate-50 border border-slate-200 rounded p-1 text-[10px]">
                        <input type="datetime-local" id="quiz-end" class="w-full bg-slate-50 border border-slate-200 rounded p-1 text-[10px]">
                    </div>
                </div>

                <button onclick="previsualizarExamen()" class="mt-2 w-full btn-primary text-white font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 text-sm uppercase tracking-wide">
                    <i class="fas fa-robot"></i> Generar Borrador
                </button>
                <div class="h-4"></div>
            </div>

            <!-- 1.2 DOCENTE: REVISI√ìN -->
            <div id="view-review" class="hidden p-6 h-full overflow-y-auto flex flex-col gap-4 bg-slate-50 fade-in">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-bold text-slate-800">Revisi√≥n Docente</h2>
                    <button onclick="showView('view-teacher')" class="text-xs text-red-500 font-bold border border-red-200 px-2 py-1 rounded bg-white">Cancelar</button>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-xs text-yellow-800">
                    <i class="fas fa-edit mr-1"></i> Puede editar las preguntas antes de publicar.
                </div>

                <div id="review-container" class="space-y-4">
                    <!-- Aqu√≠ se inyectan los inputs de preguntas -->
                </div>

                <div class="grid grid-cols-2 gap-3 mt-4 mb-8">
                    <button onclick="previsualizarExamen()" class="bg-white border-2 border-slate-200 text-slate-600 font-bold py-3 rounded-xl text-xs uppercase">
                        <i class="fas fa-sync-alt mr-1"></i> Regenerar
                    </button>
                    <button onclick="publicarExamenDefinitivo()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg text-xs uppercase flex items-center justify-center gap-2">
                        <i class="fas fa-check-circle"></i> Publicar
                    </button>
                </div>
            </div>

            <!-- 1.3 DOCENTE: GESTI√ìN DE RESULTADOS (EL NUEVO CEREBRO) -->
            <div id="view-exam-results" class="hidden p-6 h-full overflow-y-auto flex flex-col gap-4 bg-slate-50 fade-in">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-bold text-slate-800">Resultados</h2>
                    <button onclick="showDashboard()" class="text-xs bg-white border border-slate-300 px-2 py-1 rounded text-slate-600">Volver</button>
                </div>
                
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-blue-900 text-sm" id="res-exam-title">...</h3>
                    <p class="text-xs text-slate-500 mb-3" id="res-exam-meta">...</p>
                    
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button onclick="imprimirReporteDocente()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 rounded text-xs flex items-center justify-center gap-1">
                            <i class="fas fa-print"></i> Imprimir Lista
                        </button>
                        <button id="btn-cerrar-examen" onclick="toggleExamenState()" class="bg-red-50 hover:bg-red-100 text-red-600 font-bold py-2 rounded text-xs flex items-center justify-center gap-1">
                            <i class="fas fa-lock"></i> Cerrar Examen
                        </button>
                    </div>
                    
                    <!-- BOT√ìN DE SINCRONIZACI√ìN OFICIAL -->
                    <button onclick="sincronizarNotasOficial()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-md text-xs uppercase flex items-center justify-center gap-2 mt-2">
                        <i class="fas fa-cloud-upload-alt text-lg"></i> Aprobar y Sincronizar Registro
                    </button>
                    <p class="text-[9px] text-slate-400 text-center mt-1">Env√≠a las notas al Registro Auxiliar Oficial</p>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-xs">
                        <thead class="bg-slate-50 text-slate-500 font-bold uppercase">
                            <tr>
                                <th class="p-3 text-left">Alumno</th>
                                <th class="p-3 text-center">Nota</th>
                                <th class="p-3 text-center">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body" class="divide-y divide-slate-100">
                            <!-- Resultados aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 2. LINK Y QR -->
            <div id="view-link" class="hidden h-full flex flex-col items-center justify-center p-8 text-center fade-in bg-white">
                <div class="w-16 h-16 bg-green-50 text-green-500 rounded-full flex items-center justify-center mb-4 text-2xl animate-bounce border-4 border-green-100">
                    <i class="fas fa-check"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800">¬°Examen Publicado!</h2>
                <p class="text-xs text-slate-500 mb-4">Escanee el QR o comparta el enlace.</p>
                
                <!-- QR CODE AREA MEJORADO -->
                <div class="bg-white p-4 border border-slate-200 rounded-lg shadow-md mb-4 flex justify-center">
                    <div id="qrcode"></div>
                </div>

                <div class="bg-slate-50 p-3 rounded-xl w-full mb-3 border border-slate-200 cursor-pointer" onclick="copyLink()">
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Enlace Directo</p>
                    <p id="generated-link" class="text-blue-600 font-mono font-bold text-[10px] truncate">...</p>
                </div>

                <button class="w-full bg-[#25D366] text-white font-bold py-3 rounded-xl shadow-lg mb-2 flex items-center justify-center gap-2 text-sm hover:bg-[#20b957]" onclick="shareWhatsApp()">
                    <i class="fab fa-whatsapp"></i> Enviar a Alumnos
                </button>
                <button class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg text-sm hover:bg-blue-700" onclick="verResultadosAhora()"><i class="fas fa-chart-bar"></i> Resultados</button>
            </div>

            <!-- 3. REGISTRO ESTUDIANTE -->
            <div id="view-register" class="hidden h-full flex flex-col justify-center p-8 fade-in bg-white">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold text-blue-900">Ingreso Estudiante</h2>
                    <p class="text-xs text-slate-500">Selecciona tus datos correctamente.</p>
                </div>
                
                <div class="space-y-4 mb-6">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <p class="text-[10px] text-blue-400 font-bold uppercase">Evaluaci√≥n</p>
                        <p id="student-context-display" class="text-sm font-bold text-blue-800">--</p>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1 block mb-1">Soy el alumno(a):</label>
                        <select id="reg-student-select" class="w-full border-2 border-slate-200 bg-white rounded-lg p-3 outline-none text-sm font-medium focus:border-blue-500">
                            <option value="">Cargando lista...</option>
                        </select>
                    </div>
                </div>
                
                <button id="btn-start-quiz" onclick="startQuiz()" class="w-full btn-primary text-white font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 group">
                    Comenzar <i class="fas fa-arrow-right group-hover:translate-x-1 transition"></i>
                </button>
            </div>

            <!-- 4. QUIZ -->
            <div id="view-student" class="hidden h-full flex flex-col fade-in bg-slate-50">
                <div class="w-full bg-white h-1.5 shadow-sm">
                    <div id="progress-bar" class="bg-yellow-400 h-1.5 transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="p-6 flex-1 flex flex-col relative overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <span class="px-3 py-1 bg-white rounded-full text-xs font-bold text-slate-400 shadow-sm border border-slate-100">
                            <span id="q-current" class="text-blue-600">1</span>/<span id="q-total">5</span>
                        </span>
                        <div class="flex items-center gap-1 text-red-500 font-mono font-bold bg-red-50 px-3 py-1 rounded-full border border-red-100">
                            <i class="far fa-clock"></i> <span id="timer">30</span>s
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 mb-4 flex-1 flex flex-col justify-center">
                        <h3 id="question-text" class="text-lg font-bold text-slate-800 leading-relaxed text-center"></h3>
                    </div>
                    <div id="options-container" class="space-y-2 pb-6"></div>
                </div>
            </div>

            <!-- 5. RESULTADOS ALUMNO -->
            <div id="view-results" class="hidden p-6 h-full flex flex-col fade-in overflow-y-auto bg-slate-50">
                <div class="text-center mb-4">
                    <h2 class="text-xl font-bold text-blue-900">Resultados</h2>
                </div>

                <div class="bg-white rounded-3xl p-4 shadow-sm border border-slate-100 mb-4 flex items-center justify-between">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Nota Oficial</p>
                        <p id="minedu-grade" class="text-5xl font-extrabold text-blue-600 mt-1">--</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Aciertos</p>
                        <p id="final-score" class="text-2xl font-bold text-slate-700">0/0</p>
                    </div>
                </div>

                <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 mb-4">
                    <canvas id="resultsChart"></canvas>
                </div>

                <div class="bg-blue-50 border border-blue-100 rounded-2xl p-4 mb-4">
                    <p id="ai-feedback" class="text-xs text-blue-800 leading-relaxed font-medium"></p>
                </div>
                
                <p id="save-status" class="text-[10px] text-green-600 text-center mb-4 font-bold">
                    <i class="fas fa-check-circle"></i> Examen enviado al profesor
                </p>

                <button onclick="location.reload()" class="bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg text-xs uppercase w-full">
                    Finalizar
                </button>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, updateDoc, Timestamp } 
        from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CREDENCIALES COMPARTIDAS ---
        const firebaseConfig = {
          apiKey: "AIzaSyClWwYzro_avn1pK0DvD4x1r4v1grSAoE0",
          authDomain: "registro-jn-andrews-mpc.firebaseapp.com",
          projectId: "registro-jn-andrews-mpc",
          storageBucket: "registro-jn-andrews-mpc.firebasestorage.app",
          messagingSenderId: "701752375464",
          appId: "1:701752375464:web:eaab256668b869d026aa9d"
        };

        // --- 2. BASE DE DATOS LOCAL (Espejo del Registro) ---
        const database = {
            primaria: { "1": ["BOLIVAR HILARIO, Jazmin", "ESTRADA ANCASI, Alisson", "GASPAR VIZCARDO, Alessandro", "HUITTOCCOLLO HUARACCONE, Tania", "LEGUIA VEGA Jairo Isai", "LOZANO COAQUIRA, Jerry Matt", "MAMANI VILLAFUERTE, Estrellita Luz Celeste", "MESCCO OLMEDA, Lucia Camila", "MIRAMIRA GUTIERREZ Emily Valeria", "MOLLEAPAZA VALERIANO, Isabella Romina", "MONTEZA FLORIAN, Jheyli Katherine", "MORAN GOZME, Brenda Nicol", "MOROCHARA HUACCHA, Arthur Dylan", "PUERTAS AGUILAR Kalet Gael", "QUISPE MARIN, Stefano Fabi√°n", "RAMOS TICONA, Liam Caleb", "TORRES CHISI, Luciana Michelle", "ZEGARA ANDRADE Maritza Noem√≠"], "2": ["CALCINA QUISPE Nicole Kiara", "CHAMBI CHAMBI Lucy Cristel", "CHOQUEPATA MAMANI Ayddam Mateo", "DIAZ CAPACOILA, Greissy Camila", "GUZMAN CCAMA Dorud Emir", "HUAMANI HUALLA Sof√≠a Guadalupe", "HUAYCHO HUACANI, Lucero Krissia", "MAMANI APAZA Leonard Jos√≠as", "MONTEZA RIVAS Geral Mihael", "OCSA LLANQUIRE Thiago Hern√°n", "ORTEGA QUISPE Kaleb Richard", "PONCE CARDENAS L√≠a Antonella", "RAVELO PACCO, Arjen Thyago", "SACSI QUISPE Yelina Maite", "SALAZAR P√âREZ Juan David", "TAIPE DE LA CRUZ Vasthy Andrea", "TORRES PAUCCARA Marcos Sebasti√°n", "VILLAFUERTE TICONA Luis √Ångel"], "3": ["AMANQUI YANARICO, Ana Divora", "ARIZA CASTRO Antonela Kendall", "AROCUTIPA MAMANI, Roci√≥ Yamileth", "CALCINA MURILLO, Thiago Jhunior", "CCANCHILLO TORRES, Jes√∫s Franco", "CHAMBI VILCA Nicol Abigail", "CONDORI QUISPE, Raquel Amira", "HUITTOCCOLLO HUARACCONE, Jhans Roly", "MAMANI QUISPE, Dayana Nicol", "MAMANI QUISPE, Shirley Abigail", "MAMANI RAMOS, Lesly Abigail", "MAQUERA ROMERO, Esteyci Alejandra", "MELENDEZ PE√ëAFIEL, Dayiro Albert", "MELENDEZ PE√ëAFIEL, Mois√©s Leonel", "MOLLEAPAZA VALERIANO, Evangelina Shamara", "OSORIO IMATA, Keyla", "PACCO LOPE, Lionard Griezmann", "QUELLCA CHOQUEPATA, Thiago Luan", "QUISPE CAMALA, Jos√© Manuel", "QUISPE CAMALA, Juan Manuel", "QUISPE CHAUPI, Misael Mat√≠as"], "4": ["ANCCALLE MERMA, Jes√∫s", "APAZA GIRALDO NICOLAS NEYMAR", "CHOQUENAIRA PONTECIL, Neymar", "CORDERO MONTEZ, Williannys Anabella", "CUTIMBO TACUMA, Esa√∫ Alvaro", "GUZMAN SEVILLANO, Sebasti√°n Lian", "HUARICCALLO HUACHO Clhoe Allison", "MAMANI PAUCCAR, Zaza Jeison", "PHALA TORRES, Israel Jos√©", "QUISPE HUAMANI, Angie Medeley", "QUISPE QUISPE, Luz Kiara", "VALDEZ SUNI, Evelyn Adaluz", "YAULI QUISPE, Zebasthian Luis"], "5": ["ANCASI VILLAFUETE Andrea Edith", "APAZA MAMANI Mateo Jacob", "AROCUTIPA MAMANI Dayiro Jheampol", "BATALLANOS SALHUA Al√≠a Luz", "BEL√ìN AQUINO Joaqu√≠n Jhared", "CAPRISTANO AYNAYA Yamilett lucero", "CHORA COAQUIRA Tiago Mateo", "CRUZ ROJAS Nicole", "GUZMAN CCAMA Sebasti√°n Rodrigo", "HUITTOCCOLLO HUARACCONE Leydi Nicol", "LAURA SUPA Hebert Antony", "LIZARRAGA TICONA Dylan Caleb", "MACHUCA CRUZ Ghislaine", "MAMANI ROJAS Alejandra Celeste", "MANCHA COAQUIRA Wilmar Junior", "MIRAMIRA GUTIERREZ El√≠as Samuel", "OCSA LLANQUIRE Brianna jazmin", "PACCO LOPE Naydelyn Candy", "QUISPE MARAS Eymi Alondra", "QUISPE QUISPE Eduardo Sebasti√°n", "RUIZ TITO Arjen Brenner", "SACSI QUISPE Romina Yamilet", "TAIPE DE LA CRUZ Nerina", "YNOFUENTE CANAHUIRI Sheyla Nicole", "YUCRA SULLA Ian Luis Eidan"], "6": ["BARRIONUEVO CASTRO, Jeyko Paul", "BRINGAS JUAREZ, Bryams Jhamilth", "CALCINA MURILLO, Nicol Nataly", "CALDERON CARDENAS, Kiara Samira", "CAMI VILLAVICENCIO, Yhojan Yoset", "COAQUIRA CONDO, Briseth Ashlee", "DE LA CRUZ CONDORI, Jorvic Steeven", "ESTRADA ANCASI, Joshemir Anthony", "GASPAR VIZCARDO, Randy Oscar", "LIPA CASCAMAYTA, Rouse Perla Nicole", "LLANQUE ALMIRON, Hassiel Brigitte", "MANCHA MAMANI, Yidda Abigail", "MANCHA ROJAS, Dheivy Maycol", "OSORIO IMATA, Liz", "PALOMINO REYES, Naomi Eliana", "PE√ëA ARANIBAR, Rihana Franshesca", "QUISPE CAMALA, Ana Gabriela", "SANTILLAN NEYRA, Cristhoper Luis √Ångel", "TICONA RIOS, Jhon Joshiro", "VARGAS CHOQUE, Patrick Rodrigo", "YAULI QUISPE, Juan Diego"] },
            secundaria: { "1": ["ARUCUTIPA CALISAYA Yuliet Luanna", "CISA SAHUAYANAY Miguel √Ångel", "COLQUE CHAMBI Jhems Kevin", "CRUZ ROJAS Jhon Alex", "CUYO CHOQUE Will Adriano", "GALLEGOS ZEA, James Jamir", "GUETTI RUIZ Johana Nicol", "GUTIERREZ OSORIO, Rony Alex", "GUTIERREZ ZAMATA, Gianela Ninel", "MENDOZA MAMANI, V√≠ctor Manuel", "MONTEZA RIVAS Yair Alexander", "SANGUINO MARQUEZ Carlos Santiago", "TICONA CONDORI Heidy Milena", "VI√ëA HUAMAN Esteban Andreus Caleb", "ZEVALLOS MAMANI Alisom Kimberly"], "2": ["AGUILAR TILCA, Midwad Harison", "ARMAS PE√ëA, Mois√©s Jubal", "ARUCUTIPA CALISAYA, Emerson garry", "BEL√ìN AQUINO, Dayiro Andree", "CALDERON LEANDRO, Yhong Puyol.", "CALLOAPAZA CONDORCAHUANA Jhamile Sadira", "CCANCHILLO TORRES, Yulissam Priyanka", "CHOQUE LIZARRAGA, Piero Valentino", "CHOQUEHUANCA CARI, Nicole Mia Marey", "COAQUIRA CONDO, Llandhel Roberth", "CONDORI QUISPE, Mayli Yasu", "CORIMANYA ARISACA, Branco Adriano", "DIAZ CAPACOILA, Anely Yesica", "HUAYHUA HUITTOCCOLLO Alonso Delbir", "LUNA QUISPE, Jimmy No√©", "LUQUE VILCAPAZA, Eva Luz", "MANCHA COAQUIRA, George Luis", "PEREIRA VILCA Neymar Piero", "PEREZ LUPO, Gerald Abd√≠as", "PHALA TORRES, Benjam√≠n Franco", "QUISPE CAMALA, Jos√© Daniel", "QUISPE GUTIERREZ, Ana Cristina", "QUISPE QUISPE, Thal√≠a √örsula", "RIVEROS SUPA, Mathias Leonardo", "VILCA GUTIERREZ, Jandy Betzabe"], "3": ["AMANQUI YANARICO, Jean Paul", "ANCCALLE MERMA, Danna Magdiell", "APAZA MAMANI, Eduardo Nicol√°s", "AROCUTIPA ROMERO, Zamir Yhonncy", "BEL√ìN AQUINO, Fabrizio Andr√©", "CHOQUEHUANCA CARI, David Yair", "FALCON PUMA, Enoc El√≠as", "GARCIA CISA SANTIAGO BENJAMIN", "GARCIA TICONA Emanuel Mat√≠as", "HANAMPA QUISPE, Erick Jonathan", "MACHUCA CRUZ Baurulet", "MALPARTIDA ALE Alvaro Joaqu√≠n", "MAMANI ANAYA Sebasti√°n Mateo", "MARQUEZ TACURI, Jes√∫s", "MERMA MENDOZA, Roberto Maradona", "MIRAMIRA GUTIERREZ, Jos√≠as Daniel", "ORTEGA BENAVENTE, Nill Antony", "OSORIO CCACCA Marisol", "ROQUE HUARCA, Dianeth Nicol", "TOTORA CUCHO Yuliana Nery", "VALDEZ SUNI, Luz Maricielo", "VARGAS CARI Marylin Elena Josenit"], "4": ["BRINGAS JUAREZ Brandon", "CANAZA QUISPE Luis Eduardo", "CARDENAS CARDENAS Vivian Maryel", "CONDORI QUISPE Abel Benjam√≠n", "GARCIA TICONA Angie Ruth", "GUTIERREZ ALVAREZ Lisandro", "JANAMPA LIMA Jeff Dacio", "LLANQUE ALMIRON Yader Jocsan", "MOLLEAPAZA VALERIANO Yesybell Analia", "SALAZAR PEREZ Juan Hersy", "SANGUINO MARQUEZ Daylen", "VILCA ALVAREZ Rodrigo Alejandro", "VI√ëA HUAMAN Brayan Andr√©s"], "5": ["APAZA GAMARRA German Enrique", "AYALA PE√ëAFIEL Diego Gabriel", "CALCINA QUISPE Lizeth Sheyla", "CAMI VILLAVICENCIO Olger Eliel", "CONDORI ANAHUA Abigail Dorkas", "CONDORI ANAHUA Jetzabe Mar√≠a del Pilar", "CORDOVA OVADA Gabriel Gede√≥n", "CUTIMBO TACUMA David Alexander", "HANAMPA QUISPE Rub√≠ Alejandra", "HUAMAN CANAHUIRI, Frank Antony", "HUARCAYA COILA STEFANY", "MARIN CHOQUE Fredy Erick", "ORCOAPAZA MAMANI Johan Joel", "PALO AGUILAR Yanira Brendaly", "QUISPE CAMALA Kevin Andi", "QUISPE CHOQUE Oliver Omar", "SANCHEZ PEROZO Oriana Valentina", "SANO MAMANI Jenny Abigail", "SUPANTA HUACHANI Angely", "VARGAS ALANOCA Maryori Nayomi"] }
        };

        let db, auth;
        let userId = "PROFESOR_MANUEL"; 
        let isFirebaseActive = false;
        let currentExamId = null;
        let currentResults = []; // Almacena resultados para sync
        let fraudWarnings = 0;

        // INIT FIREBASE
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            signInAnonymously(auth).then(() => {
                isFirebaseActive = true;
                console.log("Conectado a la nube del Profesor Manuel");
            }).catch(e => console.error("Error login:", e));
        } catch(e) { console.error(e); }

        let currentQuestions = [];
        let currentIdx = 0;
        let score = 0;
        let timer = 30;
        let interval;
        let timePerQuestion = 30;
        let sessionConfig = { bimestre: "", area: "", nivel: "", grado: "", prompt: "", start: null, end: null, active: true };
        let studentData = { index: -1, name: "" };
        let userAnswers = [];

        // PREGUNTAS MOCK (Fallback por si no hay API Key)
        const mockDB = {
            primaria: [ { q: "¬øCapital de Per√∫?", opts: ["Lima", "Cusco", "Arequipa", "Piura"], a: 0 }, { q: "¬ø5 + 3?", opts: ["10", "8", "6", "9"], a: 1 } ],
            secundaria: [ { q: "¬øAutor de 'El Quijote'?", opts: ["Dante", "Cervantes", "Homero", "Vallejo"], a: 1 }, { q: "S√≠mbolo Au", opts: ["Plata", "Cobre", "Oro", "Hierro"], a: 2 } ]
        };

        // --- INICIALIZACI√ìN: DETECTAR MODO ALUMNO POR URL O QUERY PARAM ---
        window.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const quizId = params.get('q');
            
            if (quizId) {
                document.getElementById('view-teacher').classList.add('hidden');
                document.getElementById('view-dashboard-docente').classList.add('hidden');
                
                if (isFirebaseActive || db) {
                    try {
                        const docRef = doc(db, `artifacts/1:701752375464:web:eaab256668b869d026aa9d/users/${userId}/examenes_creados`, quizId);
                        const snap = await getDoc(docRef);
                        if (snap.exists()) {
                            const data = snap.data();
                            if(!data.active) { alert("‚õî Este examen ha sido CERRADO por el docente."); return; }
                            
                            sessionConfig = data.config;
                            currentQuestions = data.questions;
                            timePerQuestion = parseInt(sessionConfig.time);
                            currentExamId = quizId;
                            
                            goToRegistration();
                        } else {
                            alert("Examen no encontrado.");
                        }
                    } catch (e) { console.error("Error cargando examen", e); }
                }
            } else {
                // Modo Profesor (Por defecto)
                updateGrades(); 
            }
        });

        // --- ANTI-FRAUDE ---
        window.handleFraudWarning = () => {
            if(!document.getElementById('view-student').classList.contains('hidden')) {
                fraudWarnings++;
                if(fraudWarnings >= 3) {
                    alert("‚õî SE DETECT√ì ACTIVIDAD SOSPECHOSA (CAMBIO DE VENTANA)\n\nEl examen se enviar√° autom√°ticamente con la nota actual.");
                    endQuiz();
                } else {
                    alert(`‚ö†Ô∏è ADVERTENCIA DE SEGURIDAD (${fraudWarnings}/3)\n\nNo salgas de la pantalla del examen o se anular√° tu intento.`);
                }
            }
        };

        window.addEventListener('blur', handleFraudWarning);
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'hidden') handleFraudWarning();
        });

        // --- FUNCIONES DASHBOARD DOCENTE ---
        window.showDashboard = () => {
            showView('view-dashboard-docente');
            loadExamList();
        }

        // --- GESTI√ìN DE API KEY ---
        window.configurarIA = () => {
            const currentKey = localStorage.getItem('gemini_api_key') || "";
            const newKey = prompt("Ingrese su nueva API Key de Google Gemini:", currentKey);
            if(newKey !== null) {
                localStorage.setItem('gemini_api_key', newKey.trim());
                alert(newKey ? "‚úÖ Llave guardada." : "üóëÔ∏è Llave borrada.");
            }
        };

        window.loadExamList = async () => {
            const listContainer = document.getElementById('exam-list-items');
            document.getElementById('exam-list-container').classList.remove('hidden');
            
            if(!isFirebaseActive) return;
            
            try {
                const q = collection(db, `artifacts/1:701752375464:web:eaab256668b869d026aa9d/users/${userId}/examenes_creados`);
                const querySnapshot = await getDocs(q);
                listContainer.innerHTML = "";
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.createdAt ? new Date(data.createdAt.seconds*1000).toLocaleDateString() : 'Hoy';
                    const status = data.active !== false ? '<span class="text-green-600">Activo</span>' : '<span class="text-red-500">Cerrado</span>';
                    
                    listContainer.innerHTML += `
                    <div class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm hover:bg-slate-50 cursor-pointer flex justify-between items-center" onclick="openExamResults('${doc.id}')">
                        <div>
                            <p class="text-sm font-bold text-slate-700">${data.config.area.toUpperCase()} - ${data.config.grado}¬∞</p>
                            <p class="text-[10px] text-slate-400">${date} ‚Ä¢ ${status}</p>
                        </div>
                        <i class="fas fa-chevron-right text-slate-300"></i>
                    </div>`;
                });
            } catch(e) { console.error(e); }
        }

        window.openExamResults = async (examId) => {
            currentExamId = examId;
            showView('view-exam-results');
            const tbody = document.getElementById('results-table-body');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>';
            
            try {
                // 1. Cargar Info Examen
                const examRef = doc(db, `artifacts/1:701752375464:web:eaab256668b869d026aa9d/users/${userId}/examenes_creados`, examId);
                const examSnap = await getDoc(examRef);
                const examData = examSnap.data();
                sessionConfig = examData.config; // Guardar para usar en sync
                
                document.getElementById('res-exam-title').innerText = `Resultados: ${examData.config.area.toUpperCase()}`;
                document.getElementById('res-exam-meta').innerText = `${examData.config.grado}¬∞ ${examData.config.nivel} | ${examData.questions.length} Preguntas`;
                
                // Bot√≥n cerrar
                const btnClose = document.getElementById('btn-cerrar-examen');
                if(examData.active === false) {
                    btnClose.innerHTML = '<i class="fas fa-lock-open"></i> Abrir Examen';
                    btnClose.classList.replace('bg-red-50','bg-green-50');
                    btnClose.classList.replace('text-red-600','text-green-600');
                } else {
                    btnClose.innerHTML = '<i class="fas fa-lock"></i> Cerrar Examen';
                    btnClose.classList.replace('bg-green-50','bg-red-50');
                    btnClose.classList.replace('text-green-600','text-red-600');
                }

                // 2. Cargar Respuestas
                const resRef = collection(db, `artifacts/1:701752375464:web:eaab256668b869d026aa9d/users/${userId}/examenes_creados/${examId}/respuestas`);
                const resSnaps = await getDocs(resRef);
                
                tbody.innerHTML = "";
                currentResults = []; // Reset para sync

                resSnaps.forEach(r => {
                    const d = r.data();
                    const grade = getMineduGrade(d.percentage);
                    currentResults.push({ ...d, gradeLetter: grade.letter }); // Guardar para sync
                    
                    const waLink = `https://wa.me/?text=Hola ${d.student}, tu nota en el examen de ${examData.config.area} es: ${grade.letter} (${d.score}/${d.total})`;
                    
                    tbody.innerHTML += `
                    <tr class="border-b border-slate-50 hover:bg-slate-50">
                        <td class="p-3 text-slate-700 font-medium">${d.student}</td>
                        <td class="p-3 text-center"><span class="px-2 py-1 rounded text-[10px] font-bold ${grade.bgClass} ${grade.textColor}">${grade.letter}</span></td>
                        <td class="p-3 text-center">
                            <a href="${waLink}" target="_blank" class="text-green-500 hover:text-green-600 bg-green-50 p-2 rounded-full"><i class="fab fa-whatsapp"></i></a>
                        </td>
                    </tr>`;
                });
                
                if(resSnaps.empty) tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-xs text-slate-400">A√∫n no hay respuestas.</td></tr>';

            } catch(e) { console.error(e); }
        }

        window.toggleExamenState = async () => {
            if(!currentExamId) return;
            try {
                const ref = doc(db, `artifacts/1:701752375464:web:eaab256668b869d026aa9d/users/${userId}/examenes_creados`, currentExamId);
                const snap = await getDoc(ref);
                const newState = !snap.data().active;
                await updateDoc(ref, { active: newState });
                openExamResults(currentExamId); // Recargar
                alert(newState ? "Examen ABIERTO nuevamente." : "Examen CERRADO. Nadie m√°s podr√° ingresar.");
            } catch(e) { console.error(e); }
        }

        // --- SINCRONIZACI√ìN OFICIAL (EL GRAN BOT√ìN) ---
        window.sincronizarNotasOficial = async () => {
            if(!currentExamId || currentResults.length === 0) return alert("No hay notas para sincronizar.");
            if(!confirm("¬øEst√° seguro de enviar estas notas al Registro Oficial?\n\nSe actualizar√° la base de datos principal.")) return;
            
            const btn = document.querySelector('button[onclick="sincronizarNotasOficial()"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';
            btn.disabled = true;

            try {
                // ID Sesi√≥n compatible con Registro Auxiliar (Fecha Hoy)
                const today = new Date().toISOString().split('T')[0];
                const docId = `registro-${sessionConfig.bimestre}-${sessionConfig.nivel}-${sessionConfig.grado}-${sessionConfig.area}-${today}`;
                const docRef = doc(db, `artifacts/1:701752375464:web:eaab256668b869d026aa9d/users/${userId}/registros_auxiliares`, docId);
                
                const snap = await getDoc(docRef);
                let data = { notas: {}, headers: {}, prompt: `Examen EduGen: ${sessionConfig.prompt.substring(0,30)}...` };
                
                if(snap.exists()) data = snap.data();
                else data.headers = { "header-C1-0": "Examen Virtual (EduGen)", "header-C1-1": "Participaci√≥n" };

                // Batch update local object
                currentResults.forEach(r => {
                    data.notas[`nota-${r.studentIndex}-C1-0`] = r.gradeLetter;
                    data.notas[`asistencia-${r.studentIndex}`] = "A";
                });

                await setDoc(docRef, data, { merge: true });
                alert("‚úÖ ¬°Sincronizaci√≥n Exitosa!\n\nLas notas han sido enviadas al Registro Auxiliar Oficial.");
                
            } catch(e) {
                console.error(e);
                alert("Error al sincronizar.");
            }
            btn.innerHTML = '<i class="fas fa-check"></i> Sincronizado';
        }

        window.imprimirReporteDocente = () => {
            document.getElementById('rep-title').innerText = `Resultados: ${sessionConfig.area.toUpperCase()}`;
            document.getElementById('rep-subtitle').innerText = `${sessionConfig.grado}¬∞ ${sessionConfig.nivel} - ${new Date().toLocaleDateString()}`;
            document.getElementById('rep-date').innerText = new Date().toLocaleString();
            
            const tbody = document.getElementById('rep-body');
            tbody.innerHTML = "";
            
            currentResults.forEach(r => {
                tbody.innerHTML += `
                <tr class="border-b border-slate-200">
                    <td class="py-2">${r.student}</td>
                    <td class="py-2 text-center font-bold">${r.score}/${r.total}</td>
                    <td class="py-2 text-center font-bold text-blue-700">${r.gradeLetter}</td>
                    <td class="py-2 text-right text-slate-500">${new Date(r.timestamp.seconds*1000).toLocaleTimeString()}</td>
                </tr>`;
            });
            window.print();
        }

        // --- UI HELPERS ---
        window.updateGrades = () => {
            const n = document.getElementById('select-nivel').value;
            const g = document.getElementById('select-grado');
            g.innerHTML = '';
            const max = n === 'primaria' ? 6 : 5;
            for(let i=1; i<=max; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = i + '¬∞ Grado';
                g.appendChild(opt);
            }
        };

        // FUNCI√ìN DE CARGA DE ARCHIVOS
        window.handleFileUpload = async (input) => {
            const file = input.files[0];
            if(!file) return;

            const dropzone = document.getElementById('upload-container');
            const loader = document.getElementById('file-loading');
            
            // Mostrar estado de carga
            loader.classList.remove('hidden');
            dropzone.classList.add('border-blue-400');

            try {
                let text = "";
                
                if(file.type === "application/pdf") {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let maxPages = Math.min(pdf.numPages, 5); // Leer max 5 p√°ginas para rapidez
                    for(let i=1; i<=maxPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ') + "\n";
                    }
                } 
                else if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document") { // DOCX
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                    text = result.value;
                }
                else if(file.type === "text/plain") {
                    text = await file.text();
                } 
                else {
                    alert("Formato no soportado directamente. Por favor copie y pegue el texto.");
                    loader.classList.add('hidden');
                    return;
                }

                if(text.length < 10) throw new Error("No se pudo extraer texto legible.");
                
                // √âxito
                document.getElementById('input-text').value = text.substring(0, 15000); // Limite seguridad
                dropzone.querySelector('p').innerText = `Archivo Cargado: ${file.name}`;
                dropzone.querySelector('i').className = "fas fa-file-alt text-green-600 text-2xl";
                dropzone.classList.remove('border-dashed');
                dropzone.classList.add('border-green-500', 'bg-green-50');

            } catch (e) {
                console.error(e);
                alert("Error al leer el archivo. Intente copiar y pegar el texto manualmente.");
            } finally {
                loader.classList.add('hidden');
            }
        };

        // --- IA: GENERACI√ìN DE PREGUNTAS (CON CASCADA DE FALLBACK) ---
        function getAIKey() {
            let key = localStorage.getItem('gemini_api_key');
            if(!key) {
                key = prompt("Ingrese su API Key de Google Gemini (AI Studio):");
                if(key) {
                    key = key.trim();
                    localStorage.setItem('gemini_api_key', key);
                }
            }
            return key;
        }

        // FUNCI√ìN BLINDADA PARA LA CONEXI√ìN IA
        async function fetchGemini(apiKey, prompt) {
            // Lista de modelos a probar en orden
            const models = [
                'gemini-1.5-flash',
                'gemini-1.5-pro',
                'gemini-1.0-pro',
                'gemini-pro'
            ];

            let lastError = null;

            for (const model of models) {
                try {
                    console.log(`Intentando conectar con modelo: ${model}...`);
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            contents:[{parts:[{text:prompt}]}], 
                            generationConfig:{
                                responseMimeType:"application/json",
                                temperature: 0.3
                            }
                        })
                    });

                    const data = await response.json();
                    
                    if(data.error) {
                        // Si el error es 404 (modelo no encontrado), probamos el siguiente
                        if(data.error.code === 404) {
                            console.warn(`Modelo ${model} no disponible, probando siguiente...`);
                            continue;
                        }
                        throw new Error(data.error.message);
                    }
                    
                    return data; // √âxito, salimos del bucle y retornamos

                } catch (e) {
                    console.error(`Fallo en ${model}:`, e);
                    lastError = e;
                    // Si el error contiene "404", es seguro seguir probando
                    if(e.message.includes("404")) continue;
                    // Si es error de API Key invalida, detenemos todo
                    if(e.message.includes("API key") || e.message.includes("400") || e.message.includes("403")) throw e;
                }
            }
            // Si llegamos aqu√≠, todos fallaron
            throw lastError || new Error("No se pudo conectar con ning√∫n modelo de IA disponible.");
        }

        window.previsualizarExamen = async () => {
            const btn = document.querySelector('button[onclick="previsualizarExamen()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conectando con IA...';
            btn.disabled = true;

            // Recoger config
            sessionConfig.nivel = document.getElementById('select-nivel').value;
            sessionConfig.grado = document.getElementById('select-grado').value;
            sessionConfig.area = document.getElementById('select-area').value;
            sessionConfig.bimestre = document.getElementById('select-bimestre').value;
            sessionConfig.prompt = document.getElementById('input-text').value;
            
            const qCount = parseInt(document.getElementById('select-count').value);
            const time = parseInt(document.getElementById('select-time').value);
            sessionConfig.time = time;

            // Validaci√≥n de contenido
            if (sessionConfig.prompt.length < 5) {
                alert("‚ö†Ô∏è Falta contenido.\n\nPor favor escriba un tema o suba un archivo para que la IA pueda generar las preguntas.");
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                return;
            }

            // IA GENERATION
            const apiKey = getAIKey();
            
            if (apiKey) {
                try {
                    const prompt = `Act√∫a como profesor experto.
                    Contexto: Examen de ${sessionConfig.area} para ${sessionConfig.grado}¬∞ de ${sessionConfig.nivel}.
                    Base: "${sessionConfig.prompt.substring(0,6000)}".
                    
                    Tarea: Genera ${qCount} preguntas de opci√≥n m√∫ltiple RIGUROSAS basadas EXCLUSIVAMENTE en el texto base proporcionado.
                    - Nivel de dificultad: Intermedio/Alto.
                    - Formato de respuesta JSON estricto: Un array de objetos.
                    - Estructura: [{"q": "Enunciado de la pregunta", "opts": ["Opci√≥n A", "Opci√≥n B", "Opci√≥n C", "Opci√≥n D"], "a": indice_numero_0_a_3}]
                    - No uses formato Markdown, solo JSON puro.`;
                    
                    const data = await fetchGemini(apiKey, prompt);
                    
                    if(!data.candidates || !data.candidates[0].content) {
                        throw new Error("La IA no devolvi√≥ resultados v√°lidos.");
                    }

                    const jsonText = data.candidates[0].content.parts[0].text;
                    currentQuestions = JSON.parse(jsonText);
                    
                    // √âXITO: Mostrar revisi√≥n
                    renderReview();
                    showView('view-review');

                } catch (e) {
                    console.error("Error IA Final", e);
                    
                    // Si es error de autenticaci√≥n, borrar la key
                    if(e.message.includes("400") || e.message.includes("403") || e.message.includes("API key")) {
                        localStorage.removeItem('gemini_api_key');
                        alert(`‚õî ERROR DE LLAVE (API KEY)\n\nLa llave ingresada no es v√°lida o ha expirado.\n\nSe ha borrado la llave. Por favor intente generar de nuevo e ingrese una llave v√°lida.`);
                    } else {
                        alert(`‚ö†Ô∏è ERROR DE CONEXI√ìN IA\n\nNo se pudo conectar con ning√∫n modelo de Google Gemini tras varios intentos.\n\nCausa probable: Problema temporal de Google o bloqueo de red.\n\nSe generar√°n preguntas de ejemplo (Modo Offline) para que pueda probar la herramienta.`);
                        generateMockQuestions(qCount);
                        renderReview();
                        showView('view-review');
                    }
                }
            } else {
                alert("Cancelado: No se ingres√≥ API Key.");
            }

            btn.innerHTML = originalHTML;
            btn.disabled = false;
        };

        function renderReview() {
            const container = document.getElementById('review-container');
            container.innerHTML = '';
            currentQuestions.forEach((q, i) => {
                container.innerHTML += `
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm relative group hover:border-blue-300 transition">
                    <div class="flex justify-between mb-2">
                        <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">Pregunta ${i+1}</span>
                        <button onclick="deleteQuestion(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </div>
                    <textarea class="w-full text-sm font-semibold text-slate-800 border-b border-slate-200 focus:border-blue-500 outline-none mb-3 bg-transparent resize-y" rows="2" onchange="updateQuestion(${i}, 'q', this.value)">${q.q}</textarea>
                    <div class="grid grid-cols-1 gap-2">
                        ${q.opts.map((opt, oi) => `
                            <div class="flex items-center gap-2 p-1 rounded hover:bg-slate-50">
                                <input type="radio" name="q${i}" ${q.a === oi ? 'checked' : ''} onchange="updateQuestion(${i}, 'a', ${oi})" class="accent-green-600 cursor-pointer">
                                <input type="text" class="w-full text-xs text-slate-600 bg-transparent border-none focus:ring-0" value="${opt}" onchange="updateOption(${i}, ${oi}, this.value)">
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            });
        }
        
        window.deleteQuestion = (idx) => {
            if(confirm("¬øBorrar esta pregunta?")) {
                currentQuestions.splice(idx, 1);
                renderReview();
            }
        }

        function generateMockQuestions(count) {
            let base = mockDB[sessionConfig.nivel];
            currentQuestions = [];
            for(let i=0; i<count; i++) {
                let q = {...base[i % base.length]}; 
                if(i >= base.length) q.q += ` (Var. ${i+1})`;
                currentQuestions.push(q);
            }
        }

        window.updateQuestion = (idx, field, val) => { currentQuestions[idx][field] = val; };
        window.updateOption = (qIdx, oIdx, val) => { currentQuestions[qIdx].opts[oIdx] = val; };

        // --- PUBLICAR EXAMEN (SAVE TO FIREBASE & GENERATE LINK) ---
        window.publicarExamenDefinitivo = async () => {
            const btn = document.querySelector('button[onclick="publicarExamenDefinitivo()"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publicando...';
            btn.disabled = true;

            const startVal = document.getElementById('quiz-start').value;
            const endVal = document.getElementById('quiz-end').value;
            sessionConfig.start = startVal ? new Date(startVal) : null;
            sessionConfig.end = endVal ? new Date(endVal) : null;

            if (isFirebaseActive) {
                try {
                    // Guardar definici√≥n del examen
                    const docRef = await addDoc(collection(db, `artifacts/1:701752375464:web:eaab256668b869d026aa9d/users/${userId}/examenes_creados`), {
                        config: sessionConfig,
                        questions: currentQuestions,
                        createdAt: Timestamp.now(),
                        active: true // POR DEFECTO ACTIVO
                    });

                    // Generar Link Corto
                    const baseUrl = window.location.href.split('?')[0]; 
                    const finalLink = `${baseUrl}?q=${docRef.id}`;
                    
                    document.getElementById('generated-link').innerText = finalLink;
                    
                    // QR Code (Menos denso y m√°s grande)
                    document.getElementById('qrcode').innerHTML = "";
                    new QRCode(document.getElementById("qrcode"), {
                        text: finalLink,
                        width: 200,
                        height: 200,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.L
                    });

                    // IR DIRECTAMENTE A LA VISTA DE RESULTADOS/GESTI√ìN
                    currentExamId = docRef.id;
                    openExamResults(currentExamId); // Muestra el panel de control
                    showView('view-link'); // Muestra el link para compartir primero

                } catch (e) {
                    console.error("Error publicando", e);
                    alert("Error al guardar en la nube.");
                }
            } else {
                alert("Error de conexi√≥n con la base de datos.");
            }
            btn.innerHTML = '<i class="fas fa-check-circle"></i> Aprobar y Publicar';
            btn.disabled = false;
        };

        window.verResultadosAhora = () => openExamResults(currentExamId);
        window.copyLink = () => {
            const link = document.getElementById('generated-link').innerText;
            navigator.clipboard.writeText(link).then(() => alert("¬°Enlace copiado!"));
        }

        window.shareWhatsApp = () => {
            const link = document.getElementById('generated-link').innerText;
            const text = `Examen de ${sessionConfig.area.toUpperCase()} (${sessionConfig.grado}¬∞): ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        window.goToRegistration = () => {
            // Validar Horario
            const now = new Date();
            if(sessionConfig.start && now < sessionConfig.start) return alert(`A√∫n no inicia. Hora: ${sessionConfig.start.toLocaleString()}`);
            if(sessionConfig.end && now > sessionConfig.end) return alert(`Examen finalizado. Cierre: ${sessionConfig.end.toLocaleString()}`);

            // Cargar lista
            const list = database[sessionConfig.nivel][sessionConfig.grado];
            const select = document.getElementById('reg-student-select');
            
            document.getElementById('student-context-display').innerText = 
                `${sessionConfig.grado}¬∞ ${sessionConfig.nivel.toUpperCase()} - ${sessionConfig.area.toUpperCase()}`;
            
            select.innerHTML = '<option value="">Selecciona tu nombre...</option>';
            if(list) {
                list.forEach((name, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx; 
                    opt.innerText = name;
                    select.appendChild(opt);
                });
            } else {
                select.innerHTML = '<option>No hay lista cargada</option>';
            }

            showView('view-register');
        };

        // --- START QUIZ (ANTI-FRAUDE: CHECK DB) ---
        window.startQuiz = async () => {
            const idx = document.getElementById('reg-student-select').value;
            if(idx === "") return alert("Selecciona nombre.");
            
            // 1. CHEQUEO LOCAL STORAGE
            if(localStorage.getItem(`exam_done_${currentExamId}_${idx}`)) {
                return alert("‚õî ACCESO DENEGADO\n\nYa has finalizado este examen en este dispositivo.");
            }

            // 2. CHEQUEO NUBE (Un solo intento real)
            const btn = document.getElementById('btn-start-quiz');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
            
            try {
                // Buscamos si existe la respuesta en la subcolecci√≥n con ID 'res_INDEX'
                const resRef = doc(db, `artifacts/1:701752375464:web:eaab256668b869d026aa9d/users/${userId}/examenes_creados/${currentExamId}/respuestas`, `res_${idx}`);
                const snap = await getDoc(resRef);
                
                if(snap.exists()) {
                    alert("‚õî ACCESO DENEGADO\n\nYa existe un env√≠o registrado a tu nombre en la base de datos.");
                    btn.disabled = false; btn.innerHTML = 'Comenzar';
                    return;
                }
            } catch(e) {
                console.error(e); // Si falla red, permitimos entrar (fallback)
            }

            // Si pasa validaciones, inicia
            studentData.index = parseInt(idx);
            studentData.name = database[sessionConfig.nivel][sessionConfig.grado][idx];
            score = 0; currentIdx = 0; userAnswers = new Array(currentQuestions.length).fill(null);
            fraudWarnings = 0; // Reset warnings
            
            // FULLSCREEN TRIGGER
            try { document.documentElement.requestFullscreen().catch(e=>{}); } catch(e){}
            
            showView('view-student');
            loadQuestion();
        };

        function loadQuestion() {
            if(currentIdx >= currentQuestions.length) return endQuiz();
            const q = currentQuestions[currentIdx];
            document.getElementById('question-text').innerText = q.q;
            document.getElementById('q-current').innerText = currentIdx+1;
            document.getElementById('q-total').innerText = currentQuestions.length;
            document.getElementById('progress-bar').style.width = `${(currentIdx/currentQuestions.length)*100}%`;
            const c = document.getElementById('options-container'); c.innerHTML = '';
            q.opts.forEach((o, i) => {
                const b = document.createElement('button'); b.className = "w-full text-left p-4 rounded-xl border border-slate-200 hover:bg-blue-50 mb-2";
                b.innerHTML = `<span class="font-bold mr-2">${String.fromCharCode(65+i)}</span> ${o}`;
                b.onclick = () => checkAnswer(i, b);
                c.appendChild(b);
            });
            clearInterval(interval); timer = timePerQuestion; document.getElementById('timer').innerText = timer;
            interval = setInterval(() => { timer--; document.getElementById('timer').innerText = timer; if(timer<=0) checkAnswer(-1, null); }, 1000);
        }

        function checkAnswer(i, b) {
            clearInterval(interval);
            userAnswers[currentIdx] = i;
            if(i === currentQuestions[currentIdx].a) score++;
            currentIdx++; setTimeout(loadQuestion, 500);
        }

        async function endQuiz() {
            // Remove listeners
            window.removeEventListener('blur', handleFraudWarning);
            
            showView('view-results');
            const total = currentQuestions.length;
            const gradeInfo = getMineduGrade((score/total)*100);
            document.getElementById('minedu-grade').innerText = gradeInfo.letter;
            document.getElementById('minedu-grade').className = `text-5xl font-extrabold mt-1 ${gradeInfo.textColor}`;
            document.getElementById('final-score').innerText = `${score}/${total}`;
            drawChart(score, total);

            if(isFirebaseActive && currentExamId) {
                try {
                    // GUARDAR CON ID PREDECIBLE PARA EVITAR DUPLICADOS (res_INDEX)
                    await setDoc(doc(db, `artifacts/1:701752375464:web:eaab256668b869d026aa9d/users/${userId}/examenes_creados/${currentExamId}/respuestas`, `res_${studentData.index}`), {
                        student: studentData.name,
                        studentIndex: studentData.index,
                        score: score,
                        total: total,
                        percentage: (score/total)*100,
                        timestamp: Timestamp.now()
                    });
                    
                    // Marcar en LocalStorage tambi√©n
                    localStorage.setItem(`exam_done_${currentExamId}_${studentData.index}`, 'true');
                    
                    document.getElementById('save-status').innerText = "Examen entregado y bloqueado correctamente.";
                } catch(e) { console.error(e); }
            }
        }

        function showView(id) {
            ['view-teacher','view-review','view-link','view-register','view-student','view-results','view-dashboard-docente','view-exam-results'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function getMineduGrade(p) {
            if(p >= 85) return { letter: "AD", textColor: "text-blue-700", bgClass: "bg-blue-100" };
            if(p >= 70) return { letter: "A", textColor: "text-green-700", bgClass: "bg-green-100" };
            if(p >= 50) return { letter: "B", textColor: "text-yellow-600", bgClass: "bg-yellow-100" };
            return { letter: "C", textColor: "text-red-600", bgClass: "bg-red-100" };
        }

        function drawChart(s, t) {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            ctx.clearRect(0,0,300,150);
            ctx.fillStyle="#22c55e"; ctx.fillRect(100, 140-((s/t)*120), 40, (s/t)*120);
            ctx.fillStyle="#ef4444"; ctx.fillRect(160, 140-(((t-s)/t)*120), 40, ((t-s)/t)*120);
        }
    </script>
</body>
</html>