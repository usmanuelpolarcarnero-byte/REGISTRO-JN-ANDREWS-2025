<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduGen AI - I.E. JN ANDREWS (Recuperaci√≥n Auth)</title>
    
    <!-- LIBRER√çAS EXTERNAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Lectores de Documentos (Carga protegida) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if(window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f9ff; }
        .glass-header { background: rgba(30, 58, 138, 0.95); backdrop-filter: blur(10px); border-bottom: 4px solid #FACC15; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-primary { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); transition: transform 0.2s; }
        .btn-primary:active { transform: scale(0.98); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilos de impresi√≥n corregidos */
        @media print {
            body * { visibility: hidden; }
            #printable-report, #printable-report * { visibility: visible; }
            #printable-report { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
            @page { margin: 0.5cm; }
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="glass-header text-white p-3 shadow-lg z-50 shrink-0">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-white rounded-lg p-1 border-2 border-yellow-400 overflow-hidden flex items-center justify-center">
                    <img src="unnamed.jpg" alt="Escudo" class="w-full h-full object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <i class="fas fa-university text-blue-900 text-2xl hidden"></i>
                </div>
                <div>
                    <h1 class="text-sm font-bold leading-tight">I.E. J.N. ANDREWS</h1>
                    <p class="text-[10px] text-blue-200">EduGen AI v7.6 (Auth Fix)</p>
                    <p class="text-[9px] text-yellow-300 font-medium flex items-center gap-1">
                        <i class="fas fa-chalkboard-teacher"></i> Prof. Manuel Polar Carnero
                    </p>
                </div>
            </div>
            <!-- SE AGREG√ì EL ID btn-home PARA PODER OCULTARLO EN MODO ALUMNO -->
            <button id="btn-home" onclick="window.location.href = window.app.getBaseUrl()" class="text-white hover:text-yellow-400 transition" title="Ir al Inicio"><i class="fas fa-home text-lg"></i></button>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <main class="flex-1 overflow-y-auto relative bg-slate-50 w-full max-w-md mx-auto shadow-2xl border-x border-slate-200">
        
        <!-- VISTA 1: DASHBOARD DOCENTE -->
        <div id="view-dashboard" class="view-section p-6 space-y-6 hidden">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-bold text-blue-900">Panel Docente</h2>
                <button onclick="app.configIA()" class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full font-bold border border-purple-200 hover:bg-purple-200 flex items-center gap-1 shadow-sm">
                    üîë Configurar IA
                </button>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="app.navTo('view-create')" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:border-blue-500 hover:shadow-md transition text-left group">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mb-2 group-hover:scale-110 transition"><i class="fas fa-plus"></i></div>
                    <p class="font-bold text-sm">Nuevo Examen</p>
                    <p class="text-[10px] text-slate-400">Crear con IA</p>
                </button>
                <button onclick="app.loadExams()" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:border-green-500 hover:shadow-md transition text-left group">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 mb-2 group-hover:scale-110 transition"><i class="fas fa-list"></i></div>
                    <p class="font-bold text-sm">Mis Ex√°menes</p>
                    <p class="text-[10px] text-slate-400">Ver Resultados</p>
                </button>
            </div>

            <div id="exam-list-container" class="hidden">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Historial Reciente</h3>
                <div id="exam-list" class="space-y-2"></div>
            </div>
        </div>

        <!-- VISTA 2: CREAR EXAMEN -->
        <div id="view-create" class="view-section p-6 space-y-4 hidden">
            <div class="flex items-center gap-2 mb-2">
                <button onclick="app.navTo('view-dashboard')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-arrow-left"></i></button>
                <h2 class="text-lg font-bold text-slate-800">Configurar Examen</h2>
            </div>
            
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">T√≠tulo del Examen (Opcional)</label>
                <input type="text" id="exam-title" class="w-full p-3 border rounded-xl text-sm font-bold text-blue-900 border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ej: La Guerra del Pac√≠fico">
            </div>

            <!-- PROGRAMACI√ìN DE FECHAS -->
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-3">
                <p class="text-xs font-bold text-blue-800 flex items-center gap-2"><i class="far fa-calendar-alt"></i> Disponibilidad del Examen</p>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">Inicio</label>
                        <input type="datetime-local" id="cfg-start" class="w-full text-xs p-2 border rounded text-slate-700 bg-white">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">Fin</label>
                        <input type="datetime-local" id="cfg-end" class="w-full text-xs p-2 border rounded text-slate-700 bg-white">
                    </div>
                </div>
            </div>

            <div class="relative group">
                <input type="file" id="file-upload" class="hidden" accept=".pdf,.docx,.txt" onchange="app.handleFile(this)">
                <div onclick="document.getElementById('file-upload').click()" class="border-2 border-dashed border-blue-300 bg-blue-50 rounded-xl p-6 text-center cursor-pointer hover:bg-blue-100 transition">
                    <i class="fas fa-cloud-upload-alt text-3xl text-blue-500 mb-2"></i>
                    <p class="text-xs font-bold text-blue-800">Toca para subir PDF o Word</p>
                    <p class="text-[10px] text-blue-400" id="file-name-display">El texto se extraer√° autom√°ticamente</p>
                </div>
                <div id="file-loader" class="absolute inset-0 bg-white/90 flex flex-col items-center justify-center rounded-xl hidden z-10">
                    <div class="loader mb-2"></div>
                    <p class="text-xs text-blue-600 font-bold">Leyendo archivo...</p>
                </div>
            </div>

            <textarea id="prompt-text" class="w-full border border-slate-200 rounded-xl p-3 text-xs h-24 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="O pega el texto del tema aqu√≠..."></textarea>

            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <select id="cfg-bimestre" class="w-full text-xs p-2 border rounded"><option value="B1">I Bimestre</option><option value="B2">II Bimestre</option><option value="B3">III Bimestre</option><option value="B4">IV Bimestre</option></select>
                    <select id="cfg-area" class="w-full text-xs p-2 border rounded"><option value="arte">Arte y Cultura</option><option value="dpcc">DPCC</option><option value="ept">EPT</option></select>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <select id="cfg-nivel" class="w-full text-xs p-2 border rounded" onchange="app.updateGrades()"><option value="primaria">Primaria</option><option value="secundaria">Secundaria</option></select>
                    <select id="cfg-grado" class="w-full text-xs p-2 border rounded"></select>
                </div>
                <div class="grid grid-cols-2 gap-2 border-t pt-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">Preguntas</label>
                        <select id="cfg-count" class="w-full text-xs font-bold bg-transparent"><option value="3">3</option><option value="5">5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option></select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">Tiempo/Preg</label>
                        <select id="cfg-time" class="w-full text-xs font-bold bg-transparent"><option value="15">15s</option><option value="30" selected>30s</option><option value="60">1m</option><option value="120">2m</option></select>
                    </div>
                </div>
            </div>

            <button onclick="app.generateDraft()" class="btn-primary w-full text-white font-bold py-3 rounded-xl shadow-lg text-sm flex items-center justify-center gap-2">
                <i class="fas fa-robot"></i> Generar Borrador con IA
            </button>
        </div>

        <!-- VISTA 3: REVISI√ìN -->
        <div id="view-review" class="view-section p-6 space-y-4 hidden">
            <div class="flex justify-between items-center">
                 <h2 class="text-lg font-bold text-slate-800">Revisar Preguntas</h2>
                 <button onclick="app.navTo('view-create')" class="text-xs text-red-500 font-bold border border-red-200 px-2 py-1 rounded">Cancelar</button>
            </div>
            
            <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-xs text-yellow-800"><i class="fas fa-edit"></i> Puedes editar las preguntas si la IA se equivoc√≥.</div>
            <div id="review-list" class="space-y-4"></div>
            <div class="grid grid-cols-2 gap-3 pt-4">
                <button onclick="app.generateDraft()" class="border-2 border-slate-200 text-slate-600 font-bold py-3 rounded-xl text-xs">Reintentar</button>
                <button onclick="app.publishExam()" class="bg-green-600 text-white font-bold py-3 rounded-xl text-xs hover:bg-green-700 shadow-lg">Aprobar y Publicar</button>
            </div>
        </div>

        <!-- VISTA 4: LIVE (Link y QR) -->
        <div id="view-live" class="view-section p-6 flex flex-col items-center justify-center h-full hidden">
            <div class="bg-white p-4 rounded-2xl shadow-xl border border-slate-100 text-center w-full">
                <h2 class="text-xl font-bold text-blue-900 mb-1">¬°Examen Listo!</h2>
                <p class="text-xs text-slate-500 mb-4">Escanea para ingresar</p>
                <div id="qr-container" class="flex justify-center mb-4"></div>
                <div class="bg-slate-50 p-2 rounded border border-slate-200 mb-4 break-all cursor-pointer hover:bg-blue-50" onclick="app.copyLink()">
                    <p id="live-link" class="text-[10px] font-mono text-blue-600">...</p>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="app.shareWA()" class="bg-[#25D366] text-white py-2 rounded-lg text-xs font-bold"><i class="fab fa-whatsapp"></i> Enviar</button>
                    <button onclick="app.viewResultsFromLive()" class="bg-blue-600 text-white py-2 rounded-lg text-xs font-bold">Ver Resultados</button>
                </div>
            </div>
            <button onclick="app.simulateStudent()" class="mt-6 text-slate-400 text-xs underline">Simular Vista Alumno</button>
        </div>

        <!-- VISTA 5: RESULTADOS DOCENTE -->
        <div id="view-results-teacher" class="view-section p-6 space-y-4 hidden h-full flex flex-col">
             <div class="flex justify-between items-center">
                <h2 class="text-lg font-bold text-slate-800">Resultados</h2>
                <button onclick="app.navTo('view-dashboard')" class="text-xs border px-2 py-1 rounded">Cerrar</button>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <h3 class="font-bold text-sm text-blue-900" id="res-title">...</h3>
                        <p class="text-[10px] text-slate-500" id="res-meta">...</p>
                    </div>
                    <button id="btn-lock" onclick="app.toggleLock()" class="text-xs bg-red-50 text-red-600 px-2 py-1 rounded font-bold">Bloquear</button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="app.generateGroupReport()" class="bg-[#25D366] text-white py-2 rounded-lg text-xs font-bold shadow-md hover:bg-green-600">üì¢ Reporte Grupal</button>
                    <button onclick="app.syncOfficial()" class="bg-blue-600 text-white py-2 rounded-lg text-xs font-bold shadow-md hover:bg-blue-700">‚òÅÔ∏è Sincronizar</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto bg-white rounded-xl border border-slate-200">
                <table class="w-full text-xs">
                    <thead class="bg-slate-50 text-slate-500 font-bold sticky top-0"><tr><th class="p-2 text-left">Alumno</th><th class="p-2 text-center">Nota</th><th class="p-2 text-center">Detalle</th></tr></thead>
                    <tbody id="res-table" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <button onclick="window.print()" class="text-center text-xs text-slate-400 font-bold py-2 bg-slate-100 rounded-lg">üñ®Ô∏è Imprimir Reporte</button>
        </div>

        <!-- VISTA 6: ALUMNO LOGIN + SELFIE -->
        <div id="view-student-login" class="view-section p-8 flex flex-col justify-center h-full hidden">
            <div class="text-center mb-4">
                <h2 class="text-xl font-bold text-blue-900">Ingreso a Examen</h2>
                <p class="text-xs text-slate-500 mt-1" id="login-exam-info">...</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 ml-1">1. Selecciona tu nombre:</label>
                    <select id="student-select" class="w-full p-3 rounded-xl border-2 border-slate-200 bg-white focus:border-blue-500 outline-none text-sm font-bold"></select>
                </div>
                
                <!-- NUEVO BOT√ìN HISTORIAL -->
                <button onclick="app.checkHistory()" class="w-full bg-blue-100 text-blue-700 font-bold py-3 rounded-xl shadow-sm hover:bg-blue-200 text-xs flex items-center justify-center gap-2">
                    <i class="fas fa-history"></i> üìú Ver Mis Notas Anteriores
                </button>

                <!-- C√ÅMARA PARA SELFIE -->
                <div class="border-2 border-dashed border-slate-300 rounded-xl p-2 bg-slate-50 text-center">
                    <label class="text-xs font-bold text-slate-400 block mb-2">2. Verificaci√≥n Facial (Obligatorio)</label>
                    <div class="relative w-full h-48 bg-black rounded-lg overflow-hidden mb-2">
                        <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline muted></video>
                        <canvas id="camera-canvas" class="hidden"></canvas>
                        <img id="selfie-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                        <div id="camera-overlay" class="absolute inset-0 flex items-center justify-center text-white/50 text-4xl"><i class="fas fa-camera"></i></div>
                    </div>
                    <button id="btn-take-photo" onclick="app.takeSelfie()" class="text-xs bg-slate-800 text-white px-4 py-2 rounded-full font-bold">Capturar Foto</button>
                    <button id="btn-retake-photo" onclick="app.resetCamera()" class="text-xs bg-red-100 text-red-600 px-4 py-2 rounded-full font-bold hidden">Repetir</button>
                </div>

                <button id="btn-start-exam" onclick="app.startExam()" class="btn-primary w-full text-white font-bold py-4 rounded-xl shadow-lg opacity-50 cursor-not-allowed" disabled>COMENZAR EXAMEN</button>
            </div>
        </div>

        <!-- NUEVA VISTA: HISTORIAL DEL ALUMNO -->
        <div id="view-student-history" class="view-section p-6 space-y-4 hidden h-full flex flex-col">
            <div class="flex items-center gap-2 mb-4">
                <button onclick="app.navTo('view-student-login')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-arrow-left"></i></button>
                <h2 class="text-lg font-bold text-blue-900">Mis Notas Anteriores</h2>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 mb-2">
                <p class="text-xs text-blue-800 font-bold" id="hist-student-name">...</p>
            </div>
            <div id="student-history-list" class="flex-1 overflow-y-auto space-y-2">
                <!-- LISTA DE NOTAS -->
            </div>
        </div>

        <!-- VISTA 7: ALUMNO EXAMEN -->
        <div id="view-exam" class="view-section p-6 flex flex-col h-full hidden">
            <div class="w-full bg-slate-200 h-1.5 rounded-full mb-6 overflow-hidden">
                <div id="progress-bar" class="bg-yellow-400 h-full transition-all duration-300 w-0"></div>
            </div>
            <div class="flex justify-between items-center mb-6">
                <span class="text-xs font-bold bg-white px-3 py-1 rounded-full border shadow-sm text-slate-500"><span id="q-idx" class="text-blue-600">1</span> / <span id="q-total"></span></span>
                <div class="text-xs font-mono font-bold bg-red-50 text-red-500 px-3 py-1 rounded-full border border-red-100 animate-pulse"><i class="far fa-clock"></i> <span id="timer"></span>s</div>
            </div>
            <div class="flex-1 overflow-y-auto">
                <p id="q-text" class="text-lg font-bold text-slate-800 mb-6 leading-relaxed"></p>
                <div id="q-options" class="space-y-3"></div>
            </div>
        </div>

        <!-- VISTA 8: RESULTADO -->
        <div id="view-student-result" class="view-section p-8 flex flex-col items-center justify-center h-full hidden text-center">
            <div class="mb-6">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Tu Calificaci√≥n</p>
                <h1 id="final-grade-letter" class="text-6xl font-extrabold text-blue-600 my-2">--</h1>
                <p id="final-score-num" class="text-sm font-bold text-slate-500">0/0</p>
            </div>
            <div class="bg-green-50 text-green-700 p-4 rounded-xl border border-green-200 text-xs mb-6 w-full"><i class="fas fa-check-circle text-lg mb-1 block"></i> Examen enviado correctamente.</div>
            <p class="text-xs text-slate-400">Ya puedes cerrar esta ventana.</p>
        </div>

    </main>

    <!-- REPORTE DE IMPRESI√ìN (OCULTO EN PANTALLA, VISIBLE AL IMPRIMIR) -->
    <div id="printable-report" class="hidden bg-white p-8">
        <div class="border-b-2 border-yellow-400 pb-4 mb-6 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="unnamed.jpg" alt="Logo" style="width: 60px; height: auto;">
                <div>
                    <h1 class="text-2xl font-bold text-blue-900">I.E. J.N. ANDREWS</h1>
                    <p class="text-sm text-gray-500">Reporte de Resultados - Prof. Manuel Polar</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-400">Fecha de Impresi√≥n</p>
                <p class="font-mono text-sm" id="rep-date">--/--/----</p>
            </div>
        </div>
        
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
            <h3 class="font-bold text-lg text-slate-800" id="rep-title">Examen de...</h3>
            <p class="text-sm text-slate-500" id="rep-subtitle">Grado - Nivel - √Årea</p>
        </div>

        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="border-b-2 border-slate-800">
                    <th class="py-2 text-xs uppercase">Estudiante</th>
                    <th class="py-2 text-xs uppercase text-center">Nota</th>
                    <th class="py-2 text-xs uppercase text-center">Nivel</th>
                    <th class="py-2 text-xs uppercase text-right">Identidad</th>
                </tr>
            </thead>
            <tbody id="rep-body" class="text-sm"></tbody>
        </table>

        <div class="mt-12 text-center text-xs text-gray-400 border-t border-gray-200 pt-4">
            <p>Documento generado por EduGen AI - Sistema de Gesti√≥n Pedag√≥gica</p>
        </div>
    </div>

    <!-- LOGICA APP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // IMPORTANTE: signInWithCustomToken
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, updateDoc, deleteDoc, Timestamp, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === CONFIGURACI√ìN ===
        const firebaseConfig = {
            apiKey: "AIzaSyClWwYzro_avn1pK0DvD4x1r4v1grSAoE0",
            authDomain: "registro-jn-andrews-mpc.firebaseapp.com",
            projectId: "registro-jn-andrews-mpc",
            storageBucket: "registro-jn-andrews-mpc.firebasestorage.app",
            messagingSenderId: "701752375464",
            appId: "1:701752375464:web:eaab256668b869d026aa9d"
        };
        
        // --- RECUPERACI√ìN DE DATOS ---
        // IMPORTANTE: Usamos el ID exacto original para garantizar que se lean los datos antiguos.
        const APP_ID = "1:701752375464:web:eaab256668b869d026aa9d"; 
        
        const BASE_URL = "https://usmanuelpolarcarnero-byte.github.io/REGISTRO-JN-ANDREWS-2025/EduGen.html";

        const database = {
            primaria: { "1": ["BOLIVAR HILARIO, Jazmin", "ESTRADA ANCASI, Alisson", "GASPAR VIZCARDO, Alessandro", "HUITTOCCOLLO HUARACCONE, Tania", "LEGUIA VEGA Jairo Isai", "LOZANO COAQUIRA, Jerry Matt", "MAMANI VILLAFUERTE, Estrellita Luz Celeste", "MESCCO OLMEDA, Lucia Camila", "MIRAMIRA GUTIERREZ Emily Valeria", "MOLLEAPAZA VALERIANO, Isabella Romina", "MONTEZA FLORIAN, Jheyli Katherine", "MORAN GOZME, Brenda Nicol", "MOROCHARA HUACCHA, Arthur Dylan", "PUERTAS AGUILAR Kalet Gael", "QUISPE MARIN, Stefano Fabi√°n", "RAMOS TICONA, Liam Caleb", "TORRES CHISI, Luciana Michelle", "ZEGARA ANDRADE Maritza Noem√≠"], "2": ["CALCINA QUISPE Nicole Kiara", "CHAMBI CHAMBI Lucy Cristel", "CHOQUEPATA MAMANI Ayddam Mateo", "DIAZ CAPACOILA, Greissy Camila", "GUZMAN CCAMA Dorud Emir", "HUAMANI HUALLA Sof√≠a Guadalupe", "HUAYCHO HUACANI, Lucero Krissia", "MAMANI APAZA Leonard Jos√≠as", "MONTEZA RIVAS Geral Mihael", "OCSA LLANQUIRE Thiago Hern√°n", "ORTEGA QUISPE Kaleb Richard", "PONCE CARDENAS L√≠a Antonella", "RAVELO PACCO, Arjen Thyago", "SACSI QUISPE Yelina Maite", "SALAZAR P√âREZ Juan David", "TAIPE DE LA CRUZ Vasthy Andrea", "TORRES PAUCCARA Marcos Sebasti√°n", "VILLAFUERTE TICONA Luis √Ångel"], "3": ["AMANQUI YANARICO, Ana Divora", "ARIZA CASTRO Antonela Kendall", "AROCUTIPA MAMANI, Roci√≥ Yamileth", "CALCINA MURILLO, Thiago Jhunior", "CCANCHILLO TORRES, Jes√∫s Franco", "CHAMBI VILCA Nicol Abigail", "CONDORI QUISPE, Raquel Amira", "HUITTOCCOLLO HUARACCONE, Jhans Roly", "MAMANI QUISPE, Dayana Nicol", "MAMANI QUISPE, Shirley Abigail", "MAMANI RAMOS, Lesly Abigail", "MAQUERA ROMERO, Esteyci Alejandra", "MELENDEZ PE√ëAFIEL, Dayiro Albert", "MELENDEZ PE√ëAFIEL, Mois√©s Leonel", "MOLLEAPAZA VALERIANO, Evangelina Shamara", "OSORIO IMATA, Keyla", "PACCO LOPE, Lionard Griezmann", "QUELLCA CHOQUEPATA, Thiago Luan", "QUISPE CAMALA, Jos√© Manuel", "QUISPE CAMALA, Juan Manuel", "QUISPE CHAUPI, Misael Mat√≠as"], "4": ["ANCCALLE MERMA, Jes√∫s", "APAZA GIRALDO NICOLAS NEYMAR", "CHOQUENAIRA PONTECIL, Neymar", "CORDERO MONTEZ, Williannys Anabella", "CUTIMBO TACUMA, Esa√∫ Alvaro", "GUZMAN SEVILLANO, Sebasti√°n Lian", "HUARICCALLO HUACHO Clhoe Allison", "MAMANI PAUCCAR, Zaza Jeison", "PHALA TORRES, Israel Jos√©", "QUISPE HUAMANI, Angie Medeley", "QUISPE QUISPE, Luz Kiara", "VALDEZ SUNI, Evelyn Adaluz", "YAULI QUISPE, Zebasthian Luis"], "5": ["ANCASI VILLAFUETE Andrea Edith", "APAZA MAMANI Mateo Jacob", "AROCUTIPA MAMANI Dayiro Jheampol", "BATALLANOS SALHUA Al√≠a Luz", "BEL√ìN AQUINO Joaqu√≠n Jhared", "CAPRISTANO AYNAYA Yamilett lucero", "CHORA COAQUIRA Tiago Mateo", "CRUZ ROJAS Nicole", "GUZMAN CCAMA Sebasti√°n Rodrigo", "HUITTOCCOLLO HUARACCONE Leydi Nicol", "LAURA SUPA Hebert Antony", "LIZARRAGA TICONA Dylan Caleb", "MACHUCA CRUZ Ghislaine", "MAMANI ROJAS Alejandra Celeste", "MANCHA COAQUIRA Wilmar Junior", "MIRAMIRA GUTIERREZ El√≠as Samuel", "OCSA LLANQUIRE Brianna jazmin", "PACCO LOPE Naydelyn Candy", "QUISPE MARAS Eymi Alondra", "QUISPE QUISPE Eduardo Sebasti√°n", "RUIZ TITO Arjen Brenner", "SACSI QUISPE Romina Yamilet", "TAIPE DE LA CRUZ Nerina", "YNOFUENTE CANAHUIRI Sheyla Nicole", "YUCRA SULLA Ian Luis Eidan"], "6": ["BARRIONUEVO CASTRO, Jeyko Paul", "BRINGAS JUAREZ, Bryams Jhamilth", "CALCINA MURILLO, Nicol Nataly", "CALDERON CARDENAS, Kiara Samira", "CAMI VILLAVICENCIO, Yhojan Yoset", "COAQUIRA CONDO, Briseth Ashlee", "DE LA CRUZ CONDORI, Jorvic Steeven", "ESTRADA ANCASI, Joshemir Anthony", "GASPAR VIZCARDO, Randy Oscar", "LIPA CASCAMAYTA, Rouse Perla Nicole", "LLANQUE ALMIRON, Hassiel Brigitte", "MANCHA MAMANI, Yidda Abigail", "MANCHA ROJAS, Dheivy Maycol", "OSORIO IMATA, Liz", "PALOMINO REYES, Naomi Eliana", "PE√ëA ARANIBAR, Rihana Franshesca", "QUISPE CAMALA, Ana Gabriela", "SANTILLAN NEYRA, Cristhoper Luis √Ångel", "TICONA RIOS, Jhon Joshiro", "VARGAS CHOQUE, Patrick Rodrigo", "YAULI QUISPE, Juan Diego"] },
            secundaria: { "1": ["ARUCUTIPA CALISAYA Yuliet Luanna", "CISA SAHUAYANAY Miguel √Ångel", "COLQUE CHAMBI Jhems Kevin", "CRUZ ROJAS Jhon Alex", "CUYO CHOQUE Will Adriano", "GALLEGOS ZEA, James Jamir", "GUETTI RUIZ Johana Nicol", "GUTIERREZ OSORIO, Rony Alex", "GUTIERREZ ZAMATA, Gianela Ninel", "MENDOZA MAMANI, V√≠ctor Manuel", "MONTEZA RIVAS Yair Alexander", "SANGUINO MARQUEZ Carlos Santiago", "TICONA CONDORI Heidy Milena", "VI√ëA HUAMAN Esteban Andreus Caleb", "ZEVALLOS MAMANI Alisom Kimberly"], "2": ["AGUILAR TILCA, Midwad Harison", "ARMAS PE√ëA, Mois√©s Jubal", "ARUCUTIPA CALISAYA, Emerson garry", "BEL√ìN AQUINO, Dayiro Andree", "CALDERON LEANDRO, Yhong Puyol.", "CALLOAPAZA CONDORCAHUANA Jhamile Sadira", "CCANCHILLO TORRES, Yulissam Priyanka", "CHOQUE LIZARRAGA, Piero Valentino", "CHOQUEHUANCA CARI, Nicole Mia Marey", "COAQUIRA CONDO, Llandhel Roberth", "CONDORI QUISPE, Mayli Yasu", "CORIMANYA ARISACA, Branco Adriano", "DIAZ CAPACOILA, Anely Yesica", "HUAYHUA HUITTOCCOLLO Alonso Delbir", "LUNA QUISPE, Jimmy No√©", "LUQUE VILCAPAZA, Eva Luz", "MANCHA COAQUIRA, George Luis", "PEREIRA VILCA Neymar Piero", "PEREZ LUPO, Gerald Abd√≠as", "PHALA TORRES, Benjam√≠n Franco", "QUISPE CAMALA, Jos√© Daniel", "QUISPE GUTIERREZ, Ana Cristina", "QUISPE QUISPE, Thal√≠a √örsula", "RIVEROS SUPA, Mathias Leonardo", "VILCA GUTIERREZ, Jandy Betzabe"], "3": ["AMANQUI YANARICO, Jean Paul", "ANCCALLE MERMA, Danna Magdiell", "APAZA MAMANI, Eduardo Nicol√°s", "AROCUTIPA ROMERO, Zamir Yhonncy", "BEL√ìN AQUINO, Fabrizio Andr√©", "CHOQUEHUANCA CARI, David Yair", "FALCON PUMA, Enoc El√≠as", "GARCIA CISA SANTIAGO BENJAMIN", "GARCIA TICONA Emanuel Mat√≠as", "HANAMPA QUISPE, Erick Jonathan", "MACHUCA CRUZ Baurulet", "MALPARTIDA ALE Alvaro Joaqu√≠n", "MAMANI ANAYA Sebasti√°n Mateo", "MARQUEZ TACURI, Jes√∫s", "MERMA MENDOZA, Roberto Maradona", "MIRAMIRA GUTIERREZ, Jos√≠as Daniel", "ORTEGA BENAVENTE, Nill Antony", "OSORIO CCACCA Marisol", "ROQUE HUARCA, Dianeth Nicol", "TOTORA CUCHO Yuliana Nery", "VALDEZ SUNI, Luz Maricielo", "VARGAS CARI Marylin Elena Josenit"], "4": ["BRINGAS JUAREZ Brandon", "CANAZA QUISPE Luis Eduardo", "CARDENAS CARDENAS Vivian Maryel", "CONDORI QUISPE Abel Benjam√≠n", "GARCIA TICONA Angie Ruth", "GUTIERREZ ALVAREZ Lisandro", "JANAMPA LIMA Jeff Dacio", "LLANQUE ALMIRON Yader Jocsan", "MOLLEAPAZA VALERIANO Yesybell Analia", "SALAZAR PEREZ Juan Hersy", "SANGUINO MARQUEZ Daylen", "VILCA ALVAREZ Rodrigo Alejandro", "VI√ëA HUAMAN Brayan Andr√©s"], "5": ["APAZA GAMARRA German Enrique", "AYALA PE√ëAFIEL Diego Gabriel", "CALCINA QUISPE Lizeth Sheyla", "CAMI VILLAVICENCIO Olger Eliel", "CONDORI ANAHUA Abigail Dorkas", "CONDORI ANAHUA Jetzabe Mar√≠a del Pilar", "CORDOVA OVADA Gabriel Gede√≥n", "CUTIMBO TACUMA David Alexander", "HANAMPA QUISPE Rub√≠ Alejandra", "HUAMAN CANAHUIRI, Frank Antony", "HUARCAYA COILA STEFANY", "MARIN CHOQUE Fredy Erick", "ORCOAPAZA MAMANI Johan Joel", "PALO AGUILAR Yanira Brendaly", "QUISPE CAMALA Kevin Andi", "QUISPE CHOQUE Oliver Omar", "SANCHEZ PEROZO Oriana Valentina", "SANO MAMANI Jenny Abigail", "SUPANTA HUACHANI Angely", "VARGAS ALANOCA Maryori Nayomi"] }
        };

        const USER_ID = "PROFESOR_MANUEL";

        const state = {
            db: null, auth: null,
            config: {}, questions: [], currentExamId: null, currentStudent: null,
            studentResults: [], fraudWarnings: 0, timer: null, questionIdx: 0, score: 0,
            selfie: null, stream: null
        };

        // --- SISTEMA DE NAVEGACI√ìN ---
        function navTo(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // --- FUNCIONES IA ---
        function getAIKey() {
            let key = localStorage.getItem('gemini_api_key');
            if(!key) {
                key = prompt("Ingrese su API Key de Google Gemini (AI Studio):");
                if(key) {
                    key = key.trim();
                    localStorage.setItem('gemini_api_key', key);
                }
            }
            return key;
        }

        async function fetchGemini(apiKey, prompt) {
            const models = ['gemini-2.5-flash-preview-09-2025', 'gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-1.0-pro'];
            let lastError = null;

            for (const model of models) {
                try {
                    const btn = document.querySelector('button[onclick="app.generateDraft()"]');
                    if(btn) btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Probando ${model}...`;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            contents:[{parts:[{text:prompt}]}], 
                            generationConfig:{ responseMimeType:"application/json", temperature: 0.3 }
                        })
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    return data; 

                } catch (e) {
                    lastError = e;
                    if(e.message.includes("api key") || e.message.includes("403")) throw e;
                    continue; 
                }
            }
            throw lastError || new Error("No se pudo conectar con ning√∫n modelo de IA.");
        }

        // --- APP LOGIC ---
        window.app = {
            navTo: navTo,
            getBaseUrl: () => BASE_URL,
            goHome: () => window.location.href = BASE_URL,
            
            configIA: () => {
                const k = prompt("API Key de Gemini:", localStorage.getItem('gemini_api_key') || "");
                if (k !== null) localStorage.setItem('gemini_api_key', k);
            },

            startTeacherMode: () => {
                navTo('view-dashboard');
                window.app.updateGrades(); 
            },

            updateGrades: () => {
                const n = document.getElementById('cfg-nivel').value;
                const g = document.getElementById('cfg-grado');
                g.innerHTML = '';
                const max = n === 'primaria' ? 6 : 5;
                for(let i=1; i<=max; i++) {
                    const opt = document.createElement('option');
                    opt.value = i; opt.innerText = i + '¬∞';
                    g.appendChild(opt);
                }
            },

            handleFile: async (input) => {
                const file = input.files[0];
                if (!file) return;
                document.getElementById('file-loader').classList.remove('hidden');
                try {
                    let text = "";
                    if (file.type === "application/pdf") {
                        const ab = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(ab).promise;
                        for (let i = 1; i <= Math.min(pdf.numPages, 5); i++) {
                            const page = await pdf.getPage(i);
                            const tc = await page.getTextContent();
                            text += tc.items.map(item => item.str).join(' ') + "\n";
                        }
                    } else if (file.type.includes("word")) {
                        const ab = await file.arrayBuffer();
                        const res = await mammoth.extractRawText({arrayBuffer: ab});
                        text = res.value;
                    } else {
                        text = await file.text();
                    }
                    document.getElementById('prompt-text').value = text.substring(0, 15000);
                    document.getElementById('file-name-display').innerText = file.name;
                } catch (e) {
                    alert("Error leyendo archivo: " + e.message);
                } finally {
                    document.getElementById('file-loader').classList.add('hidden');
                }
            },

            generateDraft: async () => {
                const promptText = document.getElementById('prompt-text').value;
                const titleText = document.getElementById('exam-title').value.trim();
                const startTime = document.getElementById('cfg-start').value;
                const endTime = document.getElementById('cfg-end').value;
                
                if (promptText.length < 10) return alert("Por favor ingrese un tema o suba un archivo.");
                
                let key = getAIKey();
                if (!key) return;

                state.config = {
                    title: titleText || "Examen Generado por IA",
                    bimestre: document.getElementById('cfg-bimestre').value,
                    area: document.getElementById('cfg-area').value,
                    nivel: document.getElementById('cfg-nivel').value,
                    grado: document.getElementById('cfg-grado').value,
                    qCount: parseInt(document.getElementById('cfg-count').value),
                    time: parseInt(document.getElementById('cfg-time').value),
                    prompt: promptText,
                    startAt: startTime || null, // Guardar fecha inicio
                    endAt: endTime || null      // Guardar fecha fin
                };

                const btn = document.querySelector('button[onclick="app.generateDraft()"]');
                const prevHtml = btn.innerHTML;
                btn.innerHTML = `<div class="loader inline-block"></div> Generando...`;
                btn.disabled = true;

                try {
                    const sysPrompt = `Genera ${state.config.qCount} preguntas de opci√≥n m√∫ltiple sobre el texto proporcionado. Nivel escolar. JSON Array estricto: [{"q":"...","opts":["A","B","C","D"],"a":indice_0_3}]`;
                    const data = await fetchGemini(key, sysPrompt + "\nTEXTO: " + promptText);
                    
                    if(!data.candidates || !data.candidates[0].content) throw new Error("Respuesta IA vac√≠a.");
                    
                    state.questions = JSON.parse(data.candidates[0].content.parts[0].text);
                    renderReview();
                    navTo('view-review');

                } catch (e) {
                    console.error(e);
                    if (e.message.includes("key") || e.message.includes("403")) {
                        localStorage.removeItem('gemini_api_key');
                        alert("‚õî Llave API inv√°lida o expirada. Se ha borrado. Intente de nuevo.");
                    } else {
                        alert("‚ö†Ô∏è Error generando examen: " + e.message);
                    }
                }

                btn.innerHTML = prevHtml;
                btn.disabled = false;
            },

            publishExam: async () => {
                try {
                    const docRef = await addDoc(collection(state.db, `artifacts/${APP_ID}/users/${USER_ID}/examenes_creados`), {
                        config: state.config,
                        questions: state.questions,
                        active: true,
                        createdAt: Timestamp.now()
                    });
                    
                    state.currentExamId = docRef.id;
                    const link = `${BASE_URL}?q=${docRef.id}`;
                    
                    document.getElementById('qr-container').innerHTML = "";
                    new QRCode(document.getElementById("qr-container"), { text: link, width: 180, height: 180 });
                    document.getElementById('live-link').innerText = link;
                    
                    navTo('view-live');
                } catch (e) {
                    alert("Error al publicar: " + e.message);
                }
            },

            loadExams: async () => {
                const list = document.getElementById('exam-list');
                list.innerHTML = '<div class="flex justify-center p-4"><div class="loader"></div></div>'; // Loader visual
                document.getElementById('exam-list-container').classList.remove('hidden');
                
                try {
                    const q = collection(state.db, `artifacts/${APP_ID}/users/${USER_ID}/examenes_creados`);
                    const snap = await getDocs(q);
                    
                    // VALIDACI√ìN: LISTA VAC√çA
                    if (snap.empty) {
                        list.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">No hay ex√°menes creados a√∫n.</p>';
                        return;
                    }

                    list.innerHTML = "";
                    snap.forEach(doc => {
                        const d = doc.data();
                        
                        // PROTECCI√ìN CONTRA DATOS CORRUPTOS: Si no tiene config, saltar
                        if (!d.config) return;

                        const date = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toLocaleDateString() : 'Sin fecha';
                        const status = d.active ? '<span class="text-green-500">Activo</span>' : '<span class="text-red-500">Cerrado</span>';
                        const titleDisplay = d.config.title ? d.config.title : `${d.config.area ? d.config.area.toUpperCase() : 'SIN AREA'} - ${d.config.grado}¬∞`;
                        
                        list.innerHTML += `
                        <div class="bg-white p-3 rounded-lg border border-slate-200 flex justify-between items-center hover:bg-slate-50 transition">
                            <div onclick="app.loadResults('${doc.id}')" class="flex-1 cursor-pointer">
                                <p class="text-xs font-bold text-blue-900">${titleDisplay}</p>
                                <p class="text-[10px] text-slate-400">${d.config.area ? d.config.area.toUpperCase() : ''} ${d.config.grado}¬∞ ‚Ä¢ ${date} ‚Ä¢ ${status}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                 <button onclick="app.deleteExam('${doc.id}', event)" class="text-red-400 hover:text-red-600 p-2"><i class="fas fa-trash"></i></button>
                                 <i class="fas fa-chevron-right text-slate-300"></i>
                            </div>
                        </div>`;
                    });
                } catch (e) { 
                    console.error(e); 
                    // MOSTRAR ERROR EN PANTALLA EN LUGAR DE COLGARSE
                    list.innerHTML = `<div class="bg-red-50 p-4 rounded-lg text-center">
                        <p class="text-red-600 font-bold text-xs mb-2">Error cargando lista</p>
                        <p class="text-[10px] text-red-400">${e.message}</p>
                        <button onclick="app.loadExams()" class="mt-2 text-xs bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200">Reintentar</button>
                    </div>`;
                }
            },
            
            deleteExam: async (id, event) => {
                event.stopPropagation();
                if(!confirm("¬øEst√°s seguro de eliminar este examen y todos sus resultados? Esta acci√≥n no se puede deshacer.")) return;
                
                try {
                    await deleteDoc(doc(state.db, `artifacts/${APP_ID}/users/${USER_ID}/examenes_creados`, id));
                    alert("Examen eliminado correctamente.");
                    app.loadExams();
                } catch (e) {
                    alert("Error al eliminar: " + e.message);
                }
            },

            loadResults: async (id) => {
                state.currentExamId = id;
                navTo('view-results-teacher');
                const tbody = document.getElementById('res-table');
                const repBody = document.getElementById('rep-body');
                tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4">Cargando...</td></tr>';
                
                try {
                    // 1. OBTENER DATOS DEL EXAMEN
                    const examSnap = await getDoc(doc(state.db, `artifacts/${APP_ID}/users/${USER_ID}/examenes_creados`, id));
                    const examData = examSnap.data();
                    state.config = examData.config;
                    state.questions = examData.questions;
                    
                    // 2. DETERMINAR SI EST√Å CERRADO (Manual o por fecha)
                    let isClosed = !examData.active;
                    if(state.config.endAt && new Date() > new Date(state.config.endAt)) {
                        isClosed = true;
                    }

                    document.getElementById('res-title').innerText = state.config.title || `${state.config.area} ${state.config.grado}¬∞`;
                    document.getElementById('res-meta').innerText = isClosed ? "Finalizado (Cerrado)" : "En curso (Abierto)";
                    
                    const btn = document.getElementById('btn-lock');
                    btn.innerText = examData.active ? "Bloquear" : "Abrir";
                    btn.className = examData.active ? "text-xs bg-red-50 text-red-600 px-2 py-1 rounded font-bold" : "text-xs bg-green-50 text-green-600 px-2 py-1 rounded font-bold";

                    // 3. OBTENER RESPUESTAS
                    const resSnap = await getDocs(collection(state.db, `artifacts/${APP_ID}/users/${USER_ID}/examenes_creados/${id}/respuestas`));
                    
                    const responsesMap = {};
                    resSnap.forEach(doc => {
                        const r = doc.data();
                        responsesMap[r.studentIndex] = r;
                    });

                    // 4. COMBINAR CON LISTA DE CLASE COMPLETA
                    // PROTECCI√ìN CONTRA CA√çDAS: Verificar que nivel y grado existan
                    const levelData = database[state.config.nivel];
                    if (!levelData) {
                         alert("Error: El nivel de este examen no coincide con la base de datos actual.");
                         tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-red-500">Error de Datos (Nivel)</td></tr>';
                         return;
                    }
                    const fullClassList = levelData[state.config.grado];
                    if (!fullClassList) {
                         alert("Error: El grado de este examen no coincide con la base de datos actual.");
                         tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-red-500">Error de Datos (Grado)</td></tr>';
                         return;
                    }

                    state.studentResults = []; // Lista unificada para reporte y sync

                    tbody.innerHTML = "";
                    repBody.innerHTML = ""; 

                    fullClassList.forEach((studentName, idx) => {
                        let data = responsesMap[idx];
                        let nota, statusHtml, actionsHtml;
                        let isPresent = false;

                        if (data) {
                            // ALUMNO S√ç RINDI√ì EXAMEN
                            isPresent = true;
                            nota = getMinedu(data.score, data.total);
                            
                            // Detalle WA individual
                            let detalleReporte = "";
                            if (data.answers && state.questions) {
                                state.questions.forEach((q, qIdx) => {
                                    const uAns = data.answers[qIdx];
                                    const uTxt = (uAns!=null && uAns>=0) ? q.opts[uAns] : "---";
                                    const isOk = uAns === q.a;
                                    detalleReporte += `\n${qIdx+1}. ${q.q}\n   R: ${uTxt} ${isOk?'‚úÖ':'‚ùå'}`;
                                    if(!isOk) detalleReporte += `\n   (Correcta: ${q.opts[q.a]})`;
                                    detalleReporte += `\n`;
                                });
                            }
                            const waMsg = `*REPORTE INDIVIDUAL*\nAlumno: ${studentName}\nNota: ${nota.L}\n\n${detalleReporte}`;
                            
                            // Selfie
                            const selfieHtml = data.selfie 
                                ? `<img src="${data.selfie}" class="w-8 h-8 rounded-full border object-cover cursor-pointer" onclick="window.open('${data.selfie}')">` 
                                : `<span class="text-[10px] text-gray-300">No Foto</span>`;

                            statusHtml = `<span class="${nota.C} font-bold px-2 rounded bg-slate-100">${nota.L}</span>`;
                            actionsHtml = `${selfieHtml} <a href="https://wa.me/?text=${encodeURIComponent(waMsg)}" target="_blank" class="text-green-500"><i class="fab fa-whatsapp"></i></a>`;
                            
                            // Guardar en estado global unificado
                            state.studentResults.push({
                                student: studentName, studentIndex: idx, notaLetra: nota.L, status: 'Presente'
                            });

                            // IMPRESI√ìN
                            repBody.innerHTML += `
                            <tr class="border-b border-gray-200">
                                <td class="py-2 text-slate-800">${studentName}</td>
                                <td class="py-2 text-center font-bold">${nota.L}</td>
                                <td class="py-2 text-center text-xs text-gray-500">${data.score}/${data.total}</td>
                                <td class="py-2 text-right text-xs">Presente</td>
                            </tr>`;

                        } else {
                            // ALUMNO NO RINDI√ì
                            if (isClosed) {
                                // Examen CERRADO -> Autom√°ticamente tiene C
                                statusHtml = `<span class="text-red-500 font-bold bg-red-50 px-2 rounded text-[10px]">No Present√≥ (C)</span>`;
                                state.studentResults.push({
                                    student: studentName, studentIndex: idx, notaLetra: 'C', status: 'Ausente'
                                });
                                // IMPRESI√ìN
                                repBody.innerHTML += `
                                <tr class="border-b border-gray-200 bg-red-50/50">
                                    <td class="py-2 text-slate-500">${studentName}</td>
                                    <td class="py-2 text-center font-bold text-red-500">C</td>
                                    <td class="py-2 text-center text-xs text-red-400">NP</td>
                                    <td class="py-2 text-right text-xs text-red-400">Ausente</td>
                                </tr>`;
                            } else {
                                // Examen ABIERTO -> Pendiente
                                statusHtml = `<span class="text-slate-400 text-[10px] italic">Pendiente...</span>`;
                            }
                            actionsHtml = `<span class="text-slate-200">---</span>`;
                        }

                        // PANTALLA
                        tbody.innerHTML += `
                        <tr class="border-b hover:bg-slate-50">
                            <td class="p-2 text-slate-700 text-xs ${!isPresent && isClosed ? 'text-red-400':''}">${studentName}</td>
                            <td class="p-2 text-center">${statusHtml}</td>
                            <td class="p-2 text-center flex items-center justify-center gap-2">${actionsHtml}</td>
                        </tr>`;
                    });

                } catch(e) { 
                    console.error(e);
                    alert("Error cargando resultados: " + e.message); 
                }
            },

            generateGroupReport: () => {
                if(!state.studentResults || state.studentResults.length === 0) return alert("No hay datos para generar el reporte.");
                
                const title = state.config.title || "Examen de " + state.config.area;
                const date = new Date().toLocaleDateString();
                
                let asistieron = [];
                let faltaron = [];

                state.studentResults.forEach(r => {
                    if (r.status === 'Presente') {
                        asistieron.push(`- ${r.student}: *${r.notaLetra}*`);
                    } else {
                        // Solo listar faltas si tienen C (examen cerrado)
                        if(r.notaLetra === 'C') faltaron.push(`- ${r.student}`);
                    }
                });

                let msg = `üì¢ *REPORTE GRUPAL: ${title}*\nüìÖ Fecha: ${date}\n\n`;
                
                if (asistieron.length > 0) {
                    msg += `‚úÖ *RESULTADOS PUBLICADOS:*\n${asistieron.join('\n')}\n\n`;
                }
                
                if (faltaron.length > 0) {
                    msg += `‚ùå *NO PRESENTARON (Nota C):*\n${faltaron.join('\n')}\n\n`;
                }
                
                msg += `Atte. Prof. Manuel Polar`;

                // Intentar copiar al portapapeles porque el link puede ser muy largo
                if (msg.length > 2000) {
                     navigator.clipboard.writeText(msg).then(() => {
                         alert("El reporte es muy largo para un enlace directo. ¬°Se ha copiado al portapapeles! P√©galo en WhatsApp.");
                         window.open('https://web.whatsapp.com', '_blank');
                     });
                } else {
                     window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                }
            },

            syncOfficial: async () => {
                if(!confirm("¬øEnviar notas (incluyendo C a los ausentes si est√° cerrado) al Registro Oficial?")) return;
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const docId = `registro-${state.config.bimestre}-${state.config.nivel}-${state.config.grado}-${state.config.area}-${today}`;
                    const docRef = doc(state.db, `artifacts/${APP_ID}/users/${USER_ID}/registros_auxiliares`, docId);
                    
                    const snap = await getDoc(docRef);
                    let data = snap.exists() ? snap.data() : { notas: {}, headers: { "header-C1-0": "Examen EduGen" }, prompt: "Examen Virtual" };
                    
                    // Ahora usa state.studentResults que YA TIENE la lista completa (presentes + ausentes con C)
                    state.studentResults.forEach(r => {
                        // Solo sincronizamos si tiene nota (Presente o Ausente con C)
                        if(r.notaLetra) {
                            data.notas[`nota-${r.studentIndex}-C1-0`] = r.notaLetra;
                            data.notas[`asistencia-${r.studentIndex}`] = r.status === 'Presente' ? "A" : "F";
                        }
                    });
                    
                    await setDoc(docRef, data, { merge: true });
                    alert("‚úÖ Notas sincronizadas correctamente con el Registro Auxiliar.");
                } catch(e) {
                    alert("Error al sincronizar: " + e.message);
                }
            },

            toggleLock: async () => {
                const ref = doc(state.db, `artifacts/${APP_ID}/users/${USER_ID}/examenes_creados`, state.currentExamId);
                const snap = await getDoc(ref);
                await updateDoc(ref, { active: !snap.data().active });
                app.loadResults(state.currentExamId);
            },

            // --- FUNCI√ìN NUEVA: VER NOTAS ANTERIORES ---
            checkHistory: async () => {
                const studentIdx = document.getElementById('student-select').value;
                if(!studentIdx) return alert("Por favor selecciona tu nombre primero.");
                
                const studentName = database[state.config.nivel][state.config.grado][studentIdx];
                document.getElementById('hist-student-name').innerText = `Estudiante: ${studentName}`;
                
                const listDiv = document.getElementById('student-history-list');
                listDiv.innerHTML = '<div class="flex justify-center p-4"><div class="loader"></div></div>';
                
                navTo('view-student-history');
                
                try {
                    // 1. Obtener TODOS los ex√°menes creados por el profesor
                    const examsSnap = await getDocs(collection(state.db, `artifacts/${APP_ID}/users/${USER_ID}/examenes_creados`));
                    let historyHtml = "";
                    let foundCount = 0;

                    // 2. Iterar y buscar si este alumno tiene respuesta en cada uno
                    for (const examDoc of examsSnap.docs) {
                        const examData = examDoc.data();
                        
                        // Solo buscar si el examen es del mismo nivel/grado para optimizar (opcional, pero recomendado)
                        if(examData.config && examData.config.nivel === state.config.nivel && examData.config.grado === state.config.grado) {
                            
                            // Buscar la respuesta espec√≠fica de este alumno
                            const resRef = doc(state.db, `artifacts/${APP_ID}/users/${USER_ID}/examenes_creados/${examDoc.id}/respuestas`, `res_${studentIdx}`);
                            const resSnap = await getDoc(resRef);
                            
                            if (resSnap.exists()) {
                                foundCount++;
                                const resData = resSnap.data();
                                const note = getMinedu(resData.score, resData.total);
                                const date = resData.timestamp ? resData.timestamp.toDate().toLocaleDateString() : "---";
                                const title = examData.config.title || examData.config.area;

                                historyHtml += `
                                <div class="bg-white p-3 rounded-lg border border-slate-200 flex justify-between items-center shadow-sm">
                                    <div>
                                        <p class="text-xs font-bold text-slate-800">${title}</p>
                                        <p class="text-[10px] text-slate-400">${date}</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="${note.C} font-bold text-lg">${note.L}</span>
                                        <p class="text-[9px] text-slate-400">${resData.score}/${resData.total}</p>
                                    </div>
                                </div>`;
                            }
                        }
                    }

                    if(foundCount === 0) {
                        listDiv.innerHTML = `<div class="text-center py-8 text-slate-400 text-xs">No se encontraron ex√°menes anteriores para este alumno.</div>`;
                    } else {
                        listDiv.innerHTML = historyHtml;
                    }

                } catch(e) {
                    console.error(e);
                    alert("Error cargando historial: " + e.message);
                    navTo('view-student-login');
                }
            },

            startStudentMode: async (examId) => {
                state.currentExamId = examId;
                const snap = await getDoc(doc(state.db, `artifacts/${APP_ID}/users/${USER_ID}/examenes_creados`, examId));
                if (!snap.exists()) return document.body.innerHTML = "<h1 class='p-10'>Examen no encontrado</h1>";
                
                const data = snap.data();
                state.config = data.config;

                // VALIDACI√ìN DE FECHA Y HORA
                const now = new Date();
                if (state.config.startAt) {
                    const start = new Date(state.config.startAt);
                    if (now < start) return document.body.innerHTML = `<div class='p-10 text-center'><h1 class='text-2xl font-bold text-blue-900'>El examen a√∫n no inicia</h1><p>Fecha de inicio: ${start.toLocaleString()}</p></div>`;
                }
                if (state.config.endAt) {
                    const end = new Date(state.config.endAt);
                    if (now > end) return document.body.innerHTML = `<div class='p-10 text-center'><h1 class='text-2xl font-bold text-red-600'>El examen ha finalizado</h1><p>Cierre: ${end.toLocaleString()}</p></div>`;
                }
                
                if (!data.active) return document.body.innerHTML = "<h1 class='p-10 text-center text-red-600 font-bold'>Este examen ha sido cerrado por el docente.</h1>";
                
                state.questions = data.questions;
                
                const list = database[state.config.nivel][state.config.grado];
                const sel = document.getElementById('student-select');
                sel.innerHTML = '<option value="">Selecciona tu nombre...</option>';
                list.forEach((n, i) => {
                    const opt = document.createElement('option');
                    opt.value = i; opt.innerText = n;
                    sel.appendChild(opt);
                });
                
                document.getElementById('login-exam-info').innerText = state.config.title || `${state.config.area} - ${state.config.grado}¬∞`;
                navTo('view-student-login');
                
                // INICIAR C√ÅMARA AUTOM√ÅTICAMENTE
                app.initCamera();
            },

            // --- L√ìGICA DE C√ÅMARA ---
            initCamera: async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                    state.stream = stream;
                    const video = document.getElementById('camera-feed');
                    video.srcObject = stream;
                    document.getElementById('camera-overlay').classList.add('hidden');
                } catch (e) {
                    alert("‚ö†Ô∏è No se pudo acceder a la c√°mara. Es obligatoria para rendir el examen.");
                    console.error(e);
                }
            },

            takeSelfie: () => {
                const video = document.getElementById('camera-feed');
                const canvas = document.getElementById('camera-canvas');
                const preview = document.getElementById('selfie-preview');
                const btnTake = document.getElementById('btn-take-photo');
                const btnRetake = document.getElementById('btn-retake-photo');
                const btnStart = document.getElementById('btn-start-exam');

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                // Comprimir imagen para no saturar Firestore
                const dataUrl = canvas.toDataURL('image/jpeg', 0.5); 
                state.selfie = dataUrl;
                
                preview.src = dataUrl;
                preview.classList.remove('hidden');
                btnTake.classList.add('hidden');
                btnRetake.classList.remove('hidden');
                
                // Habilitar bot√≥n comenzar
                btnStart.disabled = false;
                btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
                btnStart.classList.add('animate-pulse');
            },

            resetCamera: () => {
                state.selfie = null;
                document.getElementById('selfie-preview').classList.add('hidden');
                document.getElementById('btn-take-photo').classList.remove('hidden');
                document.getElementById('btn-retake-photo').classList.add('hidden');
                
                const btnStart = document.getElementById('btn-start-exam');
                btnStart.disabled = true;
                btnStart.classList.add('opacity-50', 'cursor-not-allowed');
                btnStart.classList.remove('animate-pulse');
            },

            startExam: async () => {
                const idx = document.getElementById('student-select').value;
                if (!idx) return alert("Selecciona tu nombre");
                if (!state.selfie) return alert("Debes tomarte una foto para verificar tu identidad.");
                
                if(localStorage.getItem(`done_${state.currentExamId}_${idx}`)) return alert("Ya enviaste este examen.");

                const resRef = doc(state.db, `artifacts/${APP_ID}/users/${USER_ID}/examenes_creados/${state.currentExamId}/respuestas`, `res_${idx}`);
                const snap = await getDoc(resRef);
                if(snap.exists()) return alert("Ya existe un registro de tu examen.");

                state.currentStudent = { 
                    name: database[state.config.nivel][state.config.grado][idx], 
                    idx: idx 
                };
                
                // DETENER C√ÅMARA
                if (state.stream) {
                    state.stream.getTracks().forEach(track => track.stop());
                }
                
                window.addEventListener('blur', () => {
                    state.fraudWarnings++;
                    if(state.fraudWarnings >= 3) {
                        alert("Has salido de la pantalla demasiadas veces. El examen se enviar√° ahora.");
                        app.finishExam();
                    } else {
                        alert(`‚ö†Ô∏è ¬°ADVERTENCIA ${state.fraudWarnings}/3! No salgas de la pantalla.`);
                    }
                });

                navTo('view-exam');
                app.loadQuestion(0);
                state.userAnswers = new Array(state.questions.length).fill(null);
            },

            loadQuestion: (idx) => {
                if (idx >= state.questions.length) return app.finishExam();
                
                state.questionIdx = idx;
                const q = state.questions[idx];
                
                document.getElementById('q-idx').innerText = idx + 1;
                document.getElementById('q-total').innerText = state.questions.length;
                document.getElementById('q-text').innerText = q.q;
                document.getElementById('progress-bar').style.width = `${(idx / state.questions.length) * 100}%`;
                
                const optsDiv = document.getElementById('q-options');
                optsDiv.innerHTML = "";
                
                q.opts.forEach((opt, i) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-4 rounded-xl border border-slate-200 bg-white hover:bg-blue-50 transition mb-2";
                    btn.innerText = opt;
                    btn.onclick = () => app.answer(i);
                    optsDiv.appendChild(btn);
                });

                let t = state.config.time || 30;
                clearInterval(state.timer);
                document.getElementById('timer').innerText = t;
                state.timer = setInterval(() => {
                    t--;
                    document.getElementById('timer').innerText = t;
                    if(t <= 0) app.answer(-1); 
                }, 1000);
            },

            answer: (ansIdx) => {
                clearInterval(state.timer);
                state.userAnswers[state.questionIdx] = ansIdx;
                
                const correct = state.questions[state.questionIdx].a;
                const optsDiv = document.getElementById('q-options');
                const buttons = optsDiv.querySelectorAll('button');

                buttons.forEach(b => b.disabled = true);

                // SEM√ÅFORO
                if (ansIdx === correct) {
                    state.score++;
                    buttons[ansIdx].classList.remove('bg-white', 'border-slate-200');
                    buttons[ansIdx].classList.add('bg-green-100', 'border-green-500', 'text-green-700', 'font-bold');
                } else {
                    if (ansIdx !== -1) {
                         buttons[ansIdx].classList.remove('bg-white', 'border-slate-200');
                         buttons[ansIdx].classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                    }
                    buttons[correct].classList.remove('bg-white', 'border-slate-200');
                    buttons[correct].classList.add('bg-green-100', 'border-green-500', 'text-green-700', 'font-bold');
                }

                setTimeout(() => {
                    app.loadQuestion(state.questionIdx + 1);
                }, 1500);
            },

            finishExam: async () => {
                const total = state.questions.length;
                const note = getMinedu(state.score, total);
                
                document.getElementById('final-grade-letter').innerText = note.L;
                document.getElementById('final-grade-letter').className = `text-6xl font-extrabold my-2 ${note.C}`;
                document.getElementById('final-score-num').innerText = `${state.score}/${total}`;
                
                navTo('view-student-result');
                
                try {
                    await setDoc(doc(state.db, `artifacts/${APP_ID}/users/${USER_ID}/examenes_creados/${state.currentExamId}/respuestas`, `res_${state.currentStudent.idx}`), {
                        student: state.currentStudent.name,
                        studentIndex: state.currentStudent.idx,
                        score: state.score,
                        total: total,
                        percentage: (state.score/total)*100,
                        timestamp: Timestamp.now(),
                        answers: state.userAnswers,
                        selfie: state.selfie // GUARDAMOS LA FOTO AQU√ç
                    });
                    localStorage.setItem(`done_${state.currentExamId}_${state.currentStudent.idx}`, 'true');
                } catch(e) { console.error(e); }
            },

            copyLink: () => {
                navigator.clipboard.writeText(document.getElementById('live-link').innerText);
                alert("Copiado!");
            },
            shareWA: () => {
                const link = document.getElementById('live-link').innerText;
                window.open(`https://wa.me/?text=Examen: ${link}`, '_blank');
            },
            simulateStudent: () => app.startStudentMode(state.currentExamId),
            viewResultsFromLive: () => app.loadResults(state.currentExamId)
        };

        function renderReview() {
            const l = document.getElementById('review-list');
            l.innerHTML = "";
            state.questions.forEach((q, i) => {
                l.innerHTML += `
                <div class="bg-white p-3 rounded border">
                    <input class="w-full font-bold mb-2 border-b" value="${q.q}" onchange="app.updateQ(${i},'q',this.value)">
                    <div class="grid grid-cols-2 gap-2">
                        ${q.opts.map((o, oi) => `<input class="text-xs border rounded p-1" value="${o}" onchange="app.updateOpt(${i},${oi},this.value)">`).join('')}
                    </div>
                </div>`;
            });
            app.updateQ = (i, f, v) => state.questions[i][f] = v;
            app.updateOpt = (q, o, v) => state.questions[q].opts[o] = v;
        }

        function getMinedu(s, t) {
            const p = (s/t)*100;
            if(p >= 85) return {L:'AD', C:'text-blue-600'};
            if(p >= 70) return {L:'A', C:'text-green-600'};
            if(p >= 50) return {L:'B', C:'text-yellow-600'};
            return {L:'C', C:'text-red-600'};
        }

        async function init() {
            try {
                const appInstance = initializeApp(firebaseConfig);
                state.auth = getAuth(appInstance);
                state.db = getFirestore(appInstance);

                // --- AUTENTICACI√ìN MEJORADA ---
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Intentando Auth con Token...");
                    await signInWithCustomToken(state.auth, __initial_auth_token);
                } else {
                    console.log("Intentando Auth An√≥nima...");
                    await signInAnonymously(state.auth);
                }
                
                // DIAGN√ìSTICO
                console.log("Firebase Conectado. UID:", state.auth.currentUser ? state.auth.currentUser.uid : "No User");

                const params = new URLSearchParams(window.location.search);
                if (params.get('q')) {
                    // MODO ALUMNO DETECTADO: OCULTAR BOT√ìN DE INICIO
                    document.getElementById('btn-home').style.display = 'none';
                    window.app.startStudentMode(params.get('q'));
                } else {
                    window.app.startTeacherMode();
                }
            } catch (e) {
                console.error("Error cr√≠tico de inicio:", e);
                let msg = "Error de conexi√≥n. Verifica tu internet.";
                if(e.code && e.code.includes('permission')) msg = "Error de Permisos: Las reglas de la base de datos pueden haber caducado.";
                
                document.body.innerHTML += `<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 text-white p-6 text-center">
                    <div>
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <h2 class="text-xl font-bold text-red-400 mb-2">Error de Sistema</h2>
                        <p class="text-sm mb-4 text-gray-300">${msg}</p>
                        <p class="text-[10px] text-gray-500 font-mono mb-4 bg-black p-2 rounded border border-gray-800">${e.message}</p>
                        <button onclick="location.reload()" class="bg-white text-black px-6 py-3 rounded-xl font-bold hover:bg-gray-200 transition">Reintentar</button>
                    </div>
                </div>`;
            }
        }

        init();
    </script>
</body>
</html>