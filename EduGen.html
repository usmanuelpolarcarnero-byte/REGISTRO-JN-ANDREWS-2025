import React, { useState, useEffect } from 'react';
import { 
  CheckCircle, 
  XCircle, 
  Share2, 
  Save, 
  Plus, 
  Trash2, 
  Play, 
  History, 
  ArrowRight,
  Home,
  FileText
} from 'lucide-react';

// --- Componente Principal ---
export default function App() {
  const [view, setView] = useState('menu'); // menu, create, quiz, results, history
  const [examList, setExamList] = useState([]); // Historial de ex√°menes guardados
  const [currentExam, setCurrentExam] = useState(null); // Examen actual en curso/creaci√≥n

  // Cargar historial al iniciar
  useEffect(() => {
    const saved = localStorage.getItem('examHistory');
    if (saved) {
      setExamList(JSON.parse(saved));
    }
  }, []);

  // Guardar historial cuando cambia
  useEffect(() => {
    localStorage.setItem('examHistory', JSON.stringify(examList));
  }, [examList]);

  const startCreation = () => {
    setCurrentExam({
      id: Date.now(),
      title: '',
      questions: []
    });
    setView('create');
  };

  const saveExamToHistory = (completedExam) => {
    const newHistory = [completedExam, ...examList];
    setExamList(newHistory);
  };

  const deleteFromHistory = (id) => {
    setExamList(examList.filter(ex => ex.id !== id));
  };

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-800">
      <div className="max-w-md mx-auto bg-white min-h-screen shadow-xl overflow-hidden flex flex-col">
        
        {/* Header */}
        <header className="bg-blue-600 text-white p-4 shadow-md z-10">
          <div className="flex justify-between items-center">
            <h1 className="text-xl font-bold flex items-center gap-2">
              <FileText size={24} />
              Evaluador Pro
            </h1>
            {view !== 'menu' && (
              <button 
                onClick={() => setView('menu')}
                className="text-white/80 hover:text-white"
              >
                <Home size={24} />
              </button>
            )}
          </div>
        </header>

        {/* Content Area */}
        <main className="flex-1 p-4 overflow-y-auto">
          {view === 'menu' && (
            <MenuView 
              onStartCreate={startCreation} 
              onViewHistory={() => setView('history')}
            />
          )}

          {view === 'create' && (
            <CreateExamView 
              exam={currentExam} 
              setExam={setCurrentExam} 
              onStartQuiz={() => setView('quiz')} 
            />
          )}

          {view === 'quiz' && (
            <QuizView 
              exam={currentExam} 
              onFinish={(results) => {
                setCurrentExam({...currentExam, results});
                setView('results');
              }} 
            />
          )}

          {view === 'results' && (
            <ResultsView 
              exam={currentExam} 
              onSave={() => {
                saveExamToHistory({...currentExam, date: new Date().toLocaleString()});
                setView('menu');
              }}
            />
          )}

          {view === 'history' && (
            <HistoryView 
              list={examList} 
              onDelete={deleteFromHistory}
              onBack={() => setView('menu')}
            />
          )}
        </main>
      </div>
    </div>
  );
}

// --- Vistas ---

function MenuView({ onStartCreate, onViewHistory }) {
  return (
    <div className="flex flex-col gap-6 mt-10">
      <div className="text-center space-y-2">
        <h2 className="text-2xl font-bold text-gray-700">Bienvenido</h2>
        <p className="text-gray-500">Crea un examen o revisa tus resultados anteriores.</p>
      </div>

      <button 
        onClick={onStartCreate}
        className="bg-blue-600 hover:bg-blue-700 text-white p-6 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-transform active:scale-95"
      >
        <Plus size={32} />
        <span className="text-xl font-semibold">Crear Nuevo Examen</span>
      </button>

      <button 
        onClick={onViewHistory}
        className="bg-white border-2 border-gray-200 hover:border-blue-300 text-gray-700 p-6 rounded-xl shadow-sm flex items-center justify-center gap-3 transition-colors"
      >
        <History size={32} className="text-blue-500" />
        <span className="text-xl font-semibold">Ver Historial</span>
      </button>
    </div>
  );
}

function CreateExamView({ exam, setExam, onStartQuiz }) {
  const [qText, setQText] = useState('');
  const [options, setOptions] = useState(['', '', '']);
  const [correctIndex, setCorrectIndex] = useState(0);

  const addQuestion = () => {
    if (!qText.trim() || options.some(o => !o.trim())) {
      alert("Por favor completa la pregunta y todas las opciones.");
      return;
    }
    const newQ = {
      id: Date.now(),
      question: qText,
      options: [...options],
      correctIndex
    };
    setExam({ ...exam, questions: [...exam.questions, newQ] });
    setQText('');
    setOptions(['', '', '']);
    setCorrectIndex(0);
  };

  const updateOption = (idx, val) => {
    const newOpts = [...options];
    newOpts[idx] = val;
    setOptions(newOpts);
  };

  return (
    <div className="space-y-6">
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">T√≠tulo del Examen / Tema</label>
        <input 
          type="text" 
          value={exam.title}
          onChange={(e) => setExam({...exam, title: e.target.value})}
          placeholder="Ej: Matem√°ticas B√°sicas"
          className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-lg"
        />
      </div>

      <div className="bg-white p-4 rounded-lg border shadow-sm space-y-4">
        <h3 className="font-semibold text-gray-600">Agregar Pregunta {exam.questions.length + 1}</h3>
        <textarea 
          value={qText}
          onChange={(e) => setQText(e.target.value)}
          placeholder="Escribe la pregunta aqu√≠..."
          className="w-full p-2 border rounded resize-none focus:ring-1 focus:ring-blue-500"
        />
        
        <div className="space-y-2">
          {options.map((opt, idx) => (
            <div key={idx} className="flex items-center gap-2">
              <input 
                type="radio" 
                name="correct" 
                checked={correctIndex === idx} 
                onChange={() => setCorrectIndex(idx)}
                className="w-5 h-5 text-green-600 focus:ring-green-500"
              />
              <input 
                type="text" 
                value={opt}
                onChange={(e) => updateOption(idx, e.target.value)}
                placeholder={`Opci√≥n ${idx + 1}`}
                className={`flex-1 p-2 border rounded ${correctIndex === idx ? 'border-green-500 bg-green-50' : ''}`}
              />
            </div>
          ))}
        </div>

        <button 
          onClick={addQuestion}
          className="w-full bg-gray-800 text-white py-2 rounded hover:bg-gray-900 flex items-center justify-center gap-2"
        >
          <Plus size={18} /> Agregar Pregunta
        </button>
      </div>

      {exam.questions.length > 0 && (
        <div className="pt-4 border-t">
          <p className="text-center text-sm text-gray-500 mb-4">{exam.questions.length} preguntas a√±adidas</p>
          <button 
            onClick={() => {
              if(!exam.title) return alert("Ponle un t√≠tulo al examen antes de comenzar.");
              onStartQuiz();
            }}
            className="w-full bg-blue-600 text-white py-3 rounded-lg text-lg font-bold hover:bg-blue-700 shadow-lg flex items-center justify-center gap-2"
          >
            <Play size={24} /> COMENZAR EXAMEN
          </button>
        </div>
      )}
    </div>
  );
}

function QuizView({ exam, onFinish }) {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [selectedOption, setSelectedOption] = useState(null); // √çndice seleccionado
  const [isChecked, setIsChecked] = useState(false); // ¬øYa se valid√≥ (sem√°foro)?
  const [userAnswers, setUserAnswers] = useState([]);

  const currentQ = exam.questions[currentIndex];

  const handleSelect = (idx) => {
    if (isChecked) return; // No permitir cambios si ya se valid√≥
    setSelectedOption(idx);
  };

  const handleCheck = () => {
    if (selectedOption === null) return;
    setIsChecked(true); // Activa el sem√°foro
  };

  const handleNext = () => {
    // Guardar respuesta
    const isCorrect = selectedOption === currentQ.correctIndex;
    const answerRecord = {
      questionId: currentQ.id,
      questionText: currentQ.question,
      selectedText: currentQ.options[selectedOption],
      correctText: currentQ.options[currentQ.correctIndex],
      isCorrect: isCorrect
    };

    const newAnswers = [...userAnswers, answerRecord];
    setUserAnswers(newAnswers);

    if (currentIndex + 1 < exam.questions.length) {
      setCurrentIndex(currentIndex + 1);
      setSelectedOption(null);
      setIsChecked(false);
    } else {
      onFinish(newAnswers);
    }
  };

  return (
    <div className="flex flex-col h-full justify-between">
      <div>
        <div className="flex justify-between items-end mb-4 border-b pb-2">
          <h2 className="text-xl font-bold text-blue-900">{exam.title}</h2>
          <span className="text-sm font-medium text-gray-500">
            {currentIndex + 1}/{exam.questions.length}
          </span>
        </div>

        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6">
          <p className="text-lg font-medium text-gray-800">{currentQ.question}</p>
        </div>

        <div className="space-y-3">
          {currentQ.options.map((opt, idx) => {
            // L√≥gica del Sem√°foro
            let btnClass = "w-full p-4 rounded-xl border-2 text-left transition-all duration-200 flex justify-between items-center ";
            let icon = null;

            if (isChecked) {
              if (idx === currentQ.correctIndex) {
                // VERDE: Es la correcta (siempre se muestra verde al validar)
                btnClass += "bg-green-100 border-green-500 text-green-800 font-bold";
                icon = <CheckCircle size={20} className="text-green-600" />;
              } else if (idx === selectedOption && idx !== currentQ.correctIndex) {
                // ROJO: El usuario la eligi√≥ y estaba mal
                btnClass += "bg-red-100 border-red-500 text-red-800";
                icon = <XCircle size={20} className="text-red-600" />;
              } else {
                // El resto de opciones
                btnClass += "bg-gray-50 border-gray-200 text-gray-400 opacity-60";
              }
            } else {
              // Estado normal antes de validar
              if (selectedOption === idx) {
                btnClass += "border-blue-500 bg-blue-50 text-blue-900 ring-1 ring-blue-500";
              } else {
                btnClass += "border-gray-200 hover:border-blue-200 hover:bg-gray-50 text-gray-700";
              }
            }

            return (
              <button 
                key={idx}
                onClick={() => handleSelect(idx)}
                disabled={isChecked}
                className={btnClass}
              >
                <span>{opt}</span>
                {icon}
              </button>
            );
          })}
        </div>
      </div>

      <div className="mt-8">
        {!isChecked ? (
          <button 
            onClick={handleCheck}
            disabled={selectedOption === null}
            className={`w-full py-4 rounded-xl text-lg font-bold shadow-md transition-all ${
              selectedOption === null 
                ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                : 'bg-blue-600 text-white hover:bg-blue-700 active:scale-95'
            }`}
          >
            Comprobar Respuesta
          </button>
        ) : (
          <button 
            onClick={handleNext}
            className="w-full bg-gray-900 text-white py-4 rounded-xl text-lg font-bold shadow-md hover:bg-black active:scale-95 flex items-center justify-center gap-2"
          >
            {currentIndex + 1 === exam.questions.length ? 'Finalizar Examen' : 'Siguiente Pregunta'}
            <ArrowRight size={20} />
          </button>
        )}
      </div>
    </div>
  );
}

function ResultsView({ exam, onSave }) {
  const correctCount = exam.results.filter(r => r.isCorrect).length;
  const score = (correctCount / exam.questions.length) * 100;

  const shareViaWhatsApp = () => {
    // Construcci√≥n del reporte detallado
    let text = `üìù *REPORTE DE EXAMEN*\n`;
    text += `üìö *Tema:* ${exam.title}\n`;
    text += `üìà *Puntaje:* ${correctCount}/${exam.questions.length} (${score.toFixed(0)}%)\n\n`;
    text += `*--- DETALLES ---*\n\n`;

    exam.results.forEach((res, i) => {
      const statusIcon = res.isCorrect ? '‚úÖ' : '‚ùå';
      text += `*P${i + 1}: ${res.questionText}*\n`;
      text += `Tu respuesta: ${res.selectedText} ${statusIcon}\n`;
      
      // Si se equivoc√≥, mostrar la respuesta correcta
      if (!res.isCorrect) {
        text += `üí° *Respuesta correcta:* ${res.correctText}\n`;
      }
      text += `\n`;
    });

    text += `_Generado con Evaluador Pro_`;

    const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
  };

  return (
    <div className="text-center space-y-6 animate-in fade-in zoom-in duration-300">
      <div className="bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
        <h2 className="text-gray-500 uppercase tracking-wide text-sm font-bold mb-2">Resultados Finales</h2>
        <div className="text-3xl font-bold text-gray-800 mb-4">{exam.title}</div>
        
        <div className={`inline-flex items-center justify-center w-32 h-32 rounded-full border-8 mb-4 ${score >= 60 ? 'border-green-500 text-green-600' : 'border-red-500 text-red-600'}`}>
          <span className="text-4xl font-bold">{score.toFixed(0)}%</span>
        </div>
        
        <p className="text-gray-600">
          Has acertado <strong className="text-gray-900">{correctCount}</strong> de <strong className="text-gray-900">{exam.questions.length}</strong> preguntas.
        </p>
      </div>

      <div className="grid grid-cols-1 gap-4">
        <button 
          onClick={shareViaWhatsApp}
          className="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95"
        >
          <Share2 size={20} />
          Enviar Reporte por WhatsApp
        </button>

        <button 
          onClick={onSave}
          className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95"
        >
          <Save size={20} />
          Guardar y Salir
        </button>
      </div>
    </div>
  );
}

function HistoryView({ list, onDelete, onBack }) {
  return (
    <div className="space-y-4">
      <div className="flex items-center gap-2 mb-4">
        <h2 className="text-xl font-bold text-gray-700">Historial de Ex√°menes</h2>
      </div>

      {list.length === 0 ? (
        <div className="text-center py-10 text-gray-400">
          <History size={48} className="mx-auto mb-2 opacity-50" />
          <p>No hay ex√°menes guardados a√∫n.</p>
        </div>
      ) : (
        <div className="space-y-3">
          {list.map((item) => {
            const correct = item.results.filter(r => r.isCorrect).length;
            const total = item.questions.length;
            const percentage = Math.round((correct/total)*100);
            
            return (
              <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                <div className="flex-1">
                  {/* Aqu√≠ mostramos expl√≠citamente el T√çTULO que antes faltaba */}
                  <h3 className="font-bold text-lg text-blue-900 leading-tight mb-1">{item.title || "Examen sin t√≠tulo"}</h3>
                  <div className="text-xs text-gray-500 flex gap-2">
                    <span>{item.date}</span>
                    <span>‚Ä¢</span>
                    <span className={percentage >= 60 ? 'text-green-600 font-bold' : 'text-red-500 font-bold'}>
                      Nota: {percentage}%
                    </span>
                  </div>
                </div>
                
                <button 
                  onClick={() => onDelete(item.id)}
                  className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"
                  title="Eliminar"
                >
                  <Trash2 size={20} />
                </button>
              </div>
            );
          })}
        </div>
      )}

      <button 
        onClick={onBack}
        className="w-full mt-4 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300"
      >
        Volver al Men√∫
      </button>
    </div>
  );
}