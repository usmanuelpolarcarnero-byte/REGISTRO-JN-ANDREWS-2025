<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduGen AI - I.E. JN ANDREWS</title>
    
    <!-- LIBRER√çAS EXTERNAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Lectores de Documentos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f9ff; }
        .glass-header { background: rgba(30, 58, 138, 0.95); backdrop-filter: blur(10px); border-bottom: 4px solid #FACC15; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Utilidades */
        .btn-primary { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); transition: transform 0.2s; }
        .btn-primary:active { transform: scale(0.98); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Ocultar en impresi√≥n */
        @media print {
            body * { visibility: hidden; }
            #printable-report, #printable-report * { visibility: visible; }
            #printable-report { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- HEADER GLOBAL -->
    <header class="glass-header text-white p-3 shadow-lg z-50 shrink-0">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-white rounded-lg p-1 border-2 border-yellow-400">
                    <img src="image_9d4f3d.jpg" alt="Escudo" class="w-full h-full object-contain">
                </div>
                <div>
                    <h1 class="text-sm font-bold leading-tight">I.E. J.N. ANDREWS</h1>
                    <p class="text-[10px] text-blue-200">EduGen AI v5.1</p>
                </div>
            </div>
            <button onclick="app.goHome()" class="text-white hover:text-yellow-400 transition"><i class="fas fa-home text-lg"></i></button>
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <main class="flex-1 overflow-y-auto relative bg-slate-50 w-full max-w-md mx-auto shadow-2xl border-x border-slate-200">
        
        <!-- VISTA 1: DASHBOARD DOCENTE -->
        <div id="view-dashboard" class="view-section p-6 space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-bold text-blue-900">Panel Docente</h2>
                <button onclick="app.configIA()" class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full font-bold border border-purple-200">üîë Config IA</button>
            </div>

            <!-- Botones Principales -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="app.navTo('view-create')" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:border-blue-500 hover:shadow-md transition text-left group">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mb-2 group-hover:scale-110 transition"><i class="fas fa-plus"></i></div>
                    <p class="font-bold text-sm">Nuevo Examen</p>
                    <p class="text-[10px] text-slate-400">Crear con IA</p>
                </button>
                <button onclick="app.loadExams()" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:border-green-500 hover:shadow-md transition text-left group">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 mb-2 group-hover:scale-110 transition"><i class="fas fa-list"></i></div>
                    <p class="font-bold text-sm">Mis Ex√°menes</p>
                    <p class="text-[10px] text-slate-400">Ver Resultados</p>
                </button>
            </div>

            <!-- Lista de Ex√°menes -->
            <div id="exam-list-container" class="hidden">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Historial Reciente</h3>
                <div id="exam-list" class="space-y-2"></div>
            </div>
        </div>

        <!-- VISTA 2: CREAR EXAMEN -->
        <div id="view-create" class="view-section p-6 space-y-4 hidden">
            <div class="flex items-center gap-2 mb-2">
                <button onclick="app.navTo('view-dashboard')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-arrow-left"></i></button>
                <h2 class="text-lg font-bold text-slate-800">Configurar Examen</h2>
            </div>

            <!-- Subida de Archivo -->
            <div class="relative group">
                <input type="file" id="file-upload" class="hidden" accept=".pdf,.docx,.txt" onchange="app.handleFile(this)">
                <div onclick="document.getElementById('file-upload').click()" class="border-2 border-dashed border-blue-300 bg-blue-50 rounded-xl p-6 text-center cursor-pointer hover:bg-blue-100 transition">
                    <i class="fas fa-cloud-upload-alt text-3xl text-blue-500 mb-2"></i>
                    <p class="text-xs font-bold text-blue-800">Toca para subir PDF o Word</p>
                    <p class="text-[10px] text-blue-400" id="file-name-display">El texto se extraer√° autom√°ticamente</p>
                </div>
                <!-- Loader Overlay -->
                <div id="file-loader" class="absolute inset-0 bg-white/90 flex-col items-center justify-center rounded-xl hidden">
                    <div class="loader"></div>
                    <p class="text-xs text-blue-600 font-bold mt-2">Leyendo...</p>
                </div>
            </div>

            <textarea id="prompt-text" class="w-full border border-slate-200 rounded-xl p-3 text-xs h-24 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="O pega el texto del tema aqu√≠..."></textarea>

            <!-- Configuraci√≥n -->
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <select id="cfg-bimestre" class="w-full text-xs p-2 border rounded"><option value="B1">I Bimestre</option><option value="B2">II Bimestre</option><option value="B3">III Bimestre</option><option value="B4">IV Bimestre</option></select>
                    <select id="cfg-area" class="w-full text-xs p-2 border rounded"><option value="arte">Arte y Cultura</option><option value="dpcc">DPCC</option><option value="ept">EPT</option></select>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <select id="cfg-nivel" class="w-full text-xs p-2 border rounded" onchange="app.updateGrades()"><option value="primaria">Primaria</option><option value="secundaria">Secundaria</option></select>
                    <select id="cfg-grado" class="w-full text-xs p-2 border rounded"></select>
                </div>
                <div class="grid grid-cols-2 gap-2 border-t pt-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">Preguntas</label>
                        <select id="cfg-count" class="w-full text-xs font-bold bg-transparent"><option value="3">3</option><option value="5">5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option></select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">Tiempo</label>
                        <select id="cfg-time" class="w-full text-xs font-bold bg-transparent"><option value="15">15s</option><option value="30" selected>30s</option><option value="60">1m</option><option value="120">2m</option></select>
                    </div>
                </div>
            </div>

            <button onclick="app.generateDraft()" class="btn-primary w-full text-white font-bold py-3 rounded-xl shadow-lg text-sm flex items-center justify-center gap-2">
                <i class="fas fa-robot"></i> Generar Borrador
            </button>
        </div>

        <!-- VISTA 3: REVISI√ìN (Antes de Publicar) -->
        <div id="view-review" class="view-section p-6 space-y-4 hidden">
            <h2 class="text-lg font-bold text-slate-800">Revisar Preguntas</h2>
            <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-xs text-yellow-800">
                <i class="fas fa-edit"></i> Edita si es necesario.
            </div>
            <div id="review-list" class="space-y-4"></div>
            <div class="grid grid-cols-2 gap-3 pt-4">
                <button onclick="app.generateDraft()" class="border-2 border-slate-200 text-slate-600 font-bold py-3 rounded-xl text-xs">Reintentar</button>
                <button onclick="app.publishExam()" class="bg-green-600 text-white font-bold py-3 rounded-xl text-xs hover:bg-green-700 shadow-lg">Publicar</button>
            </div>
        </div>

        <!-- VISTA 4: EXAMEN LIVE (Link/QR) -->
        <div id="view-live" class="view-section p-6 flex flex-col items-center justify-center h-full hidden">
            <div class="bg-white p-4 rounded-2xl shadow-xl border border-slate-100 text-center w-full">
                <h2 class="text-xl font-bold text-blue-900 mb-1">¬°Examen Listo!</h2>
                <p class="text-xs text-slate-500 mb-4">Escanea para ingresar</p>
                <div id="qr-container" class="flex justify-center mb-4"></div>
                
                <div class="bg-slate-50 p-2 rounded border border-slate-200 mb-4 break-all cursor-pointer hover:bg-blue-50" onclick="app.copyLink()">
                    <p id="live-link" class="text-[10px] font-mono text-blue-600">...</p>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <button onclick="app.shareWA()" class="bg-[#25D366] text-white py-2 rounded-lg text-xs font-bold"><i class="fab fa-whatsapp"></i> Enviar</button>
                    <button onclick="app.viewResultsFromLive()" class="bg-blue-600 text-white py-2 rounded-lg text-xs font-bold">Ver Resultados</button>
                </div>
            </div>
            <button onclick="app.simulateStudent()" class="mt-6 text-slate-400 text-xs underline">Simular Vista Alumno</button>
        </div>

        <!-- VISTA 5: RESULTADOS DOCENTE -->
        <div id="view-results-teacher" class="view-section p-6 space-y-4 hidden h-full flex flex-col">
             <div class="flex justify-between items-center">
                <h2 class="text-lg font-bold text-slate-800">Resultados</h2>
                <button onclick="app.navTo('view-dashboard')" class="text-xs border px-2 py-1 rounded">Cerrar</button>
            </div>
            
            <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <h3 class="font-bold text-sm text-blue-900" id="res-title">...</h3>
                        <p class="text-[10px] text-slate-500" id="res-meta">...</p>
                    </div>
                    <button id="btn-lock" onclick="app.toggleLock()" class="text-xs bg-red-50 text-red-600 px-2 py-1 rounded font-bold">Bloquear</button>
                </div>
                <button onclick="app.syncOfficial()" class="w-full bg-blue-600 text-white py-2 rounded-lg text-xs font-bold shadow-md hover:bg-blue-700">
                    ‚òÅÔ∏è Sincronizar Registro Oficial
                </button>
            </div>

            <div class="flex-1 overflow-y-auto bg-white rounded-xl border border-slate-200">
                <table class="w-full text-xs">
                    <thead class="bg-slate-50 text-slate-500 font-bold sticky top-0">
                        <tr><th class="p-2 text-left">Alumno</th><th class="p-2">Nota</th><th class="p-2">Acci√≥n</th></tr>
                    </thead>
                    <tbody id="res-table" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <button onclick="window.print()" class="text-center text-xs text-slate-400 font-bold py-2">Imprimir Reporte</button>
        </div>

        <!-- VISTA 6: ALUMNO LOGIN -->
        <div id="view-student-login" class="view-section p-8 flex flex-col justify-center h-full hidden">
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold text-blue-900">Ingreso a Examen</h2>
                <p class="text-xs text-slate-500 mt-1" id="login-exam-info">...</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 ml-1">Selecciona tu nombre:</label>
                    <select id="student-select" class="w-full p-3 rounded-xl border-2 border-slate-200 bg-white focus:border-blue-500 outline-none text-sm font-bold"></select>
                </div>
                <button onclick="app.startExam()" class="btn-primary w-full text-white font-bold py-4 rounded-xl shadow-lg">COMENZAR</button>
            </div>
        </div>

        <!-- VISTA 7: ALUMNO EXAMEN -->
        <div id="view-exam" class="view-section p-6 flex flex-col h-full hidden">
            <div class="w-full bg-slate-200 h-1.5 rounded-full mb-6 overflow-hidden">
                <div id="progress-bar" class="bg-yellow-400 h-full transition-all duration-300 w-0"></div>
            </div>
            
            <div class="flex justify-between items-center mb-6">
                <span class="text-xs font-bold bg-white px-3 py-1 rounded-full border shadow-sm text-slate-500"><span id="q-idx" class="text-blue-600">1</span> / <span id="q-total"></span></span>
                <div class="text-xs font-mono font-bold bg-red-50 text-red-500 px-3 py-1 rounded-full border border-red-100 animate-pulse">
                    <i class="far fa-clock"></i> <span id="timer"></span>s
                </div>
            </div>

            <div class="flex-1 overflow-y-auto">
                <p id="q-text" class="text-lg font-bold text-slate-800 mb-6 leading-relaxed"></p>
                <div id="q-options" class="space-y-3"></div>
            </div>
        </div>

        <!-- VISTA 8: RESULTADO ALUMNO -->
        <div id="view-student-result" class="view-section p-8 flex flex-col items-center justify-center h-full hidden text-center">
            <div class="mb-6">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Tu Calificaci√≥n</p>
                <h1 id="final-grade-letter" class="text-6xl font-extrabold text-blue-600 my-2">--</h1>
                <p id="final-score-num" class="text-sm font-bold text-slate-500">0/0</p>
            </div>
            <div class="bg-green-50 text-green-700 p-4 rounded-xl border border-green-200 text-xs mb-6 w-full">
                <i class="fas fa-check-circle text-lg mb-1 block"></i>
                Examen enviado correctamente al profesor.
            </div>
            <button onclick="location.reload()" class="bg-slate-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg text-xs">FINALIZAR</button>
        </div>

    </main>

    <!-- REPORTE DE IMPRESI√ìN -->
    <div id="printable-report" class="hidden bg-white p-8">
        <h1 class="text-2xl font-bold mb-4">Reporte de Notas - EduGen AI</h1>
        <div id="print-content"></div>
    </div>

    <!-- LOGICA APP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, updateDoc, Timestamp, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === CONFIGURACI√ìN ===
        const firebaseConfig = {
            apiKey: "AIzaSyClWwYzro_avn1pK0DvD4x1r4v1grSAoE0",
            authDomain: "registro-jn-andrews-mpc.firebaseapp.com",
            projectId: "registro-jn-andrews-mpc",
            storageBucket: "registro-jn-andrews-mpc.firebasestorage.app",
            messagingSenderId: "701752375464",
            appId: "1:701752375464:web:eaab256668b869d026aa9d"
        };

        const database = {
            primaria: { "1": ["BOLIVAR HILARIO, Jazmin", "ESTRADA ANCASI, Alisson", "GASPAR VIZCARDO, Alessandro", "HUITTOCCOLLO HUARACCONE, Tania", "LEGUIA VEGA Jairo Isai", "LOZANO COAQUIRA, Jerry Matt", "MAMANI VILLAFUERTE, Estrellita Luz Celeste", "MESCCO OLMEDA, Lucia Camila", "MIRAMIRA GUTIERREZ Emily Valeria", "MOLLEAPAZA VALERIANO, Isabella Romina", "MONTEZA FLORIAN, Jheyli Katherine", "MORAN GOZME, Brenda Nicol", "MOROCHARA HUACCHA, Arthur Dylan", "PUERTAS AGUILAR Kalet Gael", "QUISPE MARIN, Stefano Fabi√°n", "RAMOS TICONA, Liam Caleb", "TORRES CHISI, Luciana Michelle", "ZEGARA ANDRADE Maritza Noem√≠"], "2": ["CALCINA QUISPE Nicole Kiara", "CHAMBI CHAMBI Lucy Cristel", "CHOQUEPATA MAMANI Ayddam Mateo", "DIAZ CAPACOILA, Greissy Camila", "GUZMAN CCAMA Dorud Emir", "HUAMANI HUALLA Sof√≠a Guadalupe", "HUAYCHO HUACANI, Lucero Krissia", "MAMANI APAZA Leonard Jos√≠as", "MONTEZA RIVAS Geral Mihael", "OCSA LLANQUIRE Thiago Hern√°n", "ORTEGA QUISPE Kaleb Richard", "PONCE CARDENAS L√≠a Antonella", "RAVELO PACCO, Arjen Thyago", "SACSI QUISPE Yelina Maite", "SALAZAR P√âREZ Juan David", "TAIPE DE LA CRUZ Vasthy Andrea", "TORRES PAUCCARA Marcos Sebasti√°n", "VILLAFUERTE TICONA Luis √Ångel"], "3": ["AMANQUI YANARICO, Ana Divora", "ARIZA CASTRO Antonela Kendall", "AROCUTIPA MAMANI, Roci√≥ Yamileth", "CALCINA MURILLO, Thiago Jhunior", "CCANCHILLO TORRES, Jes√∫s Franco", "CHAMBI VILCA Nicol Abigail", "CONDORI QUISPE, Raquel Amira", "HUITTOCCOLLO HUARACCONE, Jhans Roly", "MAMANI QUISPE, Dayana Nicol", "MAMANI QUISPE, Shirley Abigail", "MAMANI RAMOS, Lesly Abigail", "MAQUERA ROMERO, Esteyci Alejandra", "MELENDEZ PE√ëAFIEL, Dayiro Albert", "MELENDEZ PE√ëAFIEL, Mois√©s Leonel", "MOLLEAPAZA VALERIANO, Evangelina Shamara", "OSORIO IMATA, Keyla", "PACCO LOPE, Lionard Griezmann", "QUELLCA CHOQUEPATA, Thiago Luan", "QUISPE CAMALA, Jos√© Manuel", "QUISPE CAMALA, Juan Manuel", "QUISPE CHAUPI, Misael Mat√≠as"], "4": ["ANCCALLE MERMA, Jes√∫s", "APAZA GIRALDO NICOLAS NEYMAR", "CHOQUENAIRA PONTECIL, Neymar", "CORDERO MONTEZ, Williannys Anabella", "CUTIMBO TACUMA, Esa√∫ Alvaro", "GUZMAN SEVILLANO, Sebasti√°n Lian", "HUARICCALLO HUACHO Clhoe Allison", "MAMANI PAUCCAR, Zaza Jeison", "PHALA TORRES, Israel Jos√©", "QUISPE HUAMANI, Angie Medeley", "QUISPE QUISPE, Luz Kiara", "VALDEZ SUNI, Evelyn Adaluz", "YAULI QUISPE, Zebasthian Luis"], "5": ["ANCASI VILLAFUETE Andrea Edith", "APAZA MAMANI Mateo Jacob", "AROCUTIPA MAMANI Dayiro Jheampol", "BATALLANOS SALHUA Al√≠a Luz", "BEL√ìN AQUINO Joaqu√≠n Jhared", "CAPRISTANO AYNAYA Yamilett lucero", "CHORA COAQUIRA Tiago Mateo", "CRUZ ROJAS Nicole", "GUZMAN CCAMA Sebasti√°n Rodrigo", "HUITTOCCOLLO HUARACCONE Leydi Nicol", "LAURA SUPA Hebert Antony", "LIZARRAGA TICONA Dylan Caleb", "MACHUCA CRUZ Ghislaine", "MAMANI ROJAS Alejandra Celeste", "MANCHA COAQUIRA Wilmar Junior", "MIRAMIRA GUTIERREZ El√≠as Samuel", "OCSA LLANQUIRE Brianna jazmin", "PACCO LOPE Naydelyn Candy", "QUISPE MARAS Eymi Alondra", "QUISPE QUISPE Eduardo Sebasti√°n", "RUIZ TITO Arjen Brenner", "SACSI QUISPE Romina Yamilet", "TAIPE DE LA CRUZ Nerina", "YNOFUENTE CANAHUIRI Sheyla Nicole", "YUCRA SULLA Ian Luis Eidan"], "6": ["BARRIONUEVO CASTRO, Jeyko Paul", "BRINGAS JUAREZ, Bryams Jhamilth", "CALCINA MURILLO, Nicol Nataly", "CALDERON CARDENAS, Kiara Samira", "CAMI VILLAVICENCIO, Yhojan Yoset", "COAQUIRA CONDO, Briseth Ashlee", "DE LA CRUZ CONDORI, Jorvic Steeven", "ESTRADA ANCASI, Joshemir Anthony", "GASPAR VIZCARDO, Randy Oscar", "LIPA CASCAMAYTA, Rouse Perla Nicole", "LLANQUE ALMIRON, Hassiel Brigitte", "MANCHA MAMANI, Yidda Abigail", "MANCHA ROJAS, Dheivy Maycol", "OSORIO IMATA, Liz", "PALOMINO REYES, Naomi Eliana", "PE√ëA ARANIBAR, Rihana Franshesca", "QUISPE CAMALA, Ana Gabriela", "SANTILLAN NEYRA, Cristhoper Luis √Ångel", "TICONA RIOS, Jhon Joshiro", "VARGAS CHOQUE, Patrick Rodrigo", "YAULI QUISPE, Juan Diego"] },
            secundaria: { "1": ["ARUCUTIPA CALISAYA Yuliet Luanna", "CISA SAHUAYANAY Miguel √Ångel", "COLQUE CHAMBI Jhems Kevin", "CRUZ ROJAS Jhon Alex", "CUYO CHOQUE Will Adriano", "GALLEGOS ZEA, James Jamir", "GUETTI RUIZ Johana Nicol", "GUTIERREZ OSORIO, Rony Alex", "GUTIERREZ ZAMATA, Gianela Ninel", "MENDOZA MAMANI, V√≠ctor Manuel", "MONTEZA RIVAS Yair Alexander", "SANGUINO MARQUEZ Carlos Santiago", "TICONA CONDORI Heidy Milena", "VI√ëA HUAMAN Esteban Andreus Caleb", "ZEVALLOS MAMANI Alisom Kimberly"], "2": ["AGUILAR TILCA, Midwad Harison", "ARMAS PE√ëA, Mois√©s Jubal", "ARUCUTIPA CALISAYA, Emerson garry", "BEL√ìN AQUINO, Dayiro Andree", "CALDERON LEANDRO, Yhong Puyol.", "CALLOAPAZA CONDORCAHUANA Jhamile Sadira", "CCANCHILLO TORRES, Yulissam Priyanka", "CHOQUE LIZARRAGA, Piero Valentino", "CHOQUEHUANCA CARI, Nicole Mia Marey", "COAQUIRA CONDO, Llandhel Roberth", "CONDORI QUISPE, Mayli Yasu", "CORIMANYA ARISACA, Branco Adriano", "DIAZ CAPACOILA, Anely Yesica", "HUAYHUA HUITTOCCOLLO Alonso Delbir", "LUNA QUISPE, Jimmy No√©", "LUQUE VILCAPAZA, Eva Luz", "MANCHA COAQUIRA, George Luis", "PEREIRA VILCA Neymar Piero", "PEREZ LUPO, Gerald Abd√≠as", "PHALA TORRES, Benjam√≠n Franco", "QUISPE CAMALA, Jos√© Daniel", "QUISPE GUTIERREZ, Ana Cristina", "QUISPE QUISPE, Thal√≠a √örsula", "RIVEROS SUPA, Mathias Leonardo", "VILCA GUTIERREZ, Jandy Betzabe"], "3": ["AMANQUI YANARICO, Jean Paul", "ANCCALLE MERMA, Danna Magdiell", "APAZA MAMANI, Eduardo Nicol√°s", "AROCUTIPA ROMERO, Zamir Yhonncy", "BEL√ìN AQUINO, Fabrizio Andr√©", "CHOQUEHUANCA CARI, David Yair", "FALCON PUMA, Enoc El√≠as", "GARCIA CISA SANTIAGO BENJAMIN", "GARCIA TICONA Emanuel Mat√≠as", "HANAMPA QUISPE, Erick Jonathan", "MACHUCA CRUZ Baurulet", "MALPARTIDA ALE Alvaro Joaqu√≠n", "MAMANI ANAYA Sebasti√°n Mateo", "MARQUEZ TACURI, Jes√∫s", "MERMA MENDOZA, Roberto Maradona", "MIRAMIRA GUTIERREZ, Jos√≠as Daniel", "ORTEGA BENAVENTE, Nill Antony", "OSORIO CCACCA Marisol", "ROQUE HUARCA, Dianeth Nicol", "TOTORA CUCHO Yuliana Nery", "VALDEZ SUNI, Luz Maricielo", "VARGAS CARI Marylin Elena Josenit"], "4": ["BRINGAS JUAREZ Brandon", "CANAZA QUISPE Luis Eduardo", "CARDENAS CARDENAS Vivian Maryel", "CONDORI QUISPE Abel Benjam√≠n", "GARCIA TICONA Angie Ruth", "GUTIERREZ ALVAREZ Lisandro", "JANAMPA LIMA Jeff Dacio", "LLANQUE ALMIRON Yader Jocsan", "MOLLEAPAZA VALERIANO Yesybell Analia", "SALAZAR PEREZ Juan Hersy", "SANGUINO MARQUEZ Daylen", "VILCA ALVAREZ Rodrigo Alejandro", "VI√ëA HUAMAN Brayan Andr√©s"], "5": ["APAZA GAMARRA German Enrique", "AYALA PE√ëAFIEL Diego Gabriel", "CALCINA QUISPE Lizeth Sheyla", "CAMI VILLAVICENCIO Olger Eliel", "CONDORI ANAHUA Abigail Dorkas", "CONDORI ANAHUA Jetzabe Mar√≠a del Pilar", "CORDOVA OVADA Gabriel Gede√≥n", "CUTIMBO TACUMA David Alexander", "HANAMPA QUISPE Rub√≠ Alejandra", "HUAMAN CANAHUIRI, Frank Antony", "HUARCAYA COILA STEFANY", "MARIN CHOQUE Fredy Erick", "ORCOAPAZA MAMANI Johan Joel", "PALO AGUILAR Yanira Brendaly", "QUISPE CAMALA Kevin Andi", "QUISPE CHOQUE Oliver Omar", "SANCHEZ PEROZO Oriana Valentina", "SANO MAMANI Jenny Abigail", "SUPANTA HUACHANI Angely", "VARGAS ALANOCA Maryori Nayomi"] }
        };

        const USER_ID = "PROFESOR_MANUEL";

        // ESTADO GLOBAL
        const state = {
            db: null,
            auth: null,
            user: null,
            config: {},
            questions: [],
            currentExamId: null,
            currentStudent: null,
            studentResults: [],
            fraudWarnings: 0,
            timer: null,
            questionIdx: 0,
            score: 0
        };

        // --- CORE: INICIALIZACI√ìN ---
        async function init() {
            try {
                const app = initializeApp(firebaseConfig);
                state.auth = getAuth(app);
                state.db = getFirestore(app);
                await signInAnonymously(state.auth);
                console.log("Firebase Conectado");

                // Router Simple
                const params = new URLSearchParams(window.location.search);
                if (params.get('q')) {
                    startStudentMode(params.get('q'));
                } else {
                    startTeacherMode();
                }
            } catch (e) {
                console.error("Error init:", e);
                // DIAGNOSTICO DE ERROR DE CONEXI√ìN FIREBASE
                let msg = "Error cr√≠tico de conexi√≥n con la Base de Datos.";
                if(e.code === 'auth/unauthorized-domain') {
                    msg += "\n\n‚ö†Ô∏è DOMINIO NO AUTORIZADO:\nDebes agregar 'usmanuelpolarcarnero-byte.github.io' en Firebase Console > Authentication > Settings > Authorized Domains.";
                } else if (e.code === 'auth/api-key-not-valid') {
                    msg += "\n\n‚ö†Ô∏è API KEY INV√ÅLIDA en FirebaseConfig.";
                } else {
                    msg += "\n\nDetalle: " + e.message;
                }
                alert(msg);
            }
        }

        // --- MODO DOCENTE ---
        function startTeacherMode() {
            navTo('view-dashboard');
            updateGrades(); // Init selects
        }

        window.app = {
            // NAVEGACI√ìN
            navTo: (id) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
            },
            goHome: () => window.location.href = window.location.pathname,
            
            // CONFIG IA
            configIA: () => {
                const k = prompt("API Key de Gemini:", localStorage.getItem('gemini_key') || "");
                if (k !== null) localStorage.setItem('gemini_key', k);
            },

            // GESTI√ìN EX√ÅMENES
            updateGrades: () => {
                const n = document.getElementById('cfg-nivel').value;
                const g = document.getElementById('cfg-grado');
                g.innerHTML = '';
                const max = n === 'primaria' ? 6 : 5;
                for(let i=1; i<=max; i++) {
                    const opt = document.createElement('option');
                    opt.value = i; opt.innerText = i + '¬∞';
                    g.appendChild(opt);
                }
            },

            // LECTURA DE ARCHIVOS
            handleFile: async (input) => {
                const file = input.files[0];
                if (!file) return;
                
                document.getElementById('file-loader').classList.remove('hidden');
                
                try {
                    let text = "";
                    if (file.type === "application/pdf") {
                        const ab = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(ab).promise;
                        for (let i = 1; i <= Math.min(pdf.numPages, 5); i++) {
                            const page = await pdf.getPage(i);
                            const tc = await page.getTextContent();
                            text += tc.items.map(item => item.str).join(' ') + "\n";
                        }
                    } else if (file.type.includes("word")) {
                        const ab = await file.arrayBuffer();
                        const res = await mammoth.extractRawText({arrayBuffer: ab});
                        text = res.value;
                    } else {
                        text = await file.text();
                    }
                    
                    document.getElementById('prompt-text').value = text.substring(0, 15000);
                    document.getElementById('file-name-display').innerText = file.name;
                    
                } catch (e) {
                    alert("Error leyendo archivo: " + e.message);
                } finally {
                    document.getElementById('file-loader').classList.add('hidden');
                }
            },

            // GENERACI√ìN CON IA (CASCADA)
            generateDraft: async () => {
                const promptText = document.getElementById('prompt-text').value;
                if (promptText.length < 10) return alert("Por favor ingrese un tema o suba un archivo.");
                
                let key = localStorage.getItem('gemini_key');
                if (!key) {
                    key = prompt("Ingrese su API Key de Gemini para continuar:");
                    if(!key) return;
                    localStorage.setItem('gemini_key', key);
                }

                // Guardar Config
                state.config = {
                    bimestre: document.getElementById('cfg-bimestre').value,
                    area: document.getElementById('cfg-area').value,
                    nivel: document.getElementById('cfg-nivel').value,
                    grado: document.getElementById('cfg-grado').value,
                    qCount: parseInt(document.getElementById('cfg-count').value),
                    time: parseInt(document.getElementById('cfg-time').value),
                    prompt: promptText
                };

                // UI Loading
                const btn = document.querySelector('button[onclick="app.generateDraft()"]');
                const prevHtml = btn.innerHTML;
                btn.innerHTML = `<div class="loader inline-block"></div> Generando...`;
                btn.disabled = true;

                // Modelos a probar en orden
                const models = [
                    'gemini-1.5-flash',
                    'gemini-1.5-flash-latest',
                    'gemini-1.5-pro',
                    'gemini-1.0-pro',
                    'gemini-pro'
                ];
                let success = false;

                for (const model of models) {
                    try {
                        console.log("Probando modelo:", model);
                        const sysPrompt = `Genera ${state.config.qCount} preguntas de opci√≥n m√∫ltiple sobre el texto proporcionado. Nivel escolar. JSON Array estricto: [{"q":"...","opts":["A","B","C","D"],"a":indice_0_3}]`;
                        
                        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                contents: [{parts: [{text: sysPrompt + "\nTEXTO: " + promptText}]}],
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        });

                        const data = await resp.json();
                        
                        if (data.error) {
                             // Si es error de modelo no encontrado, probamos siguiente
                             if (data.error.code === 404 || data.error.message.includes("not found")) {
                                 console.warn(`Modelo ${model} no encontrado, probando siguiente...`);
                                 continue;
                             }
                             throw new Error(data.error.message);
                        }
                        
                        state.questions = JSON.parse(data.candidates[0].content.parts[0].text);
                        success = true;
                        break; // Salir si funciona

                    } catch (e) {
                        console.warn(`Fallo ${model}:`, e);
                        if (e.message.includes("key") || e.message.includes("403")) {
                            localStorage.removeItem('gemini_key');
                            alert("Llave inv√°lida. Intente de nuevo.");
                            break;
                        }
                    }
                }

                btn.innerHTML = prevHtml;
                btn.disabled = false;

                if (success) {
                    renderReview();
                    app.navTo('view-review');
                } else {
                    alert("No se pudo generar el examen. Verifique su conexi√≥n o intente con un texto m√°s corto.");
                }
            },

            // PUBLICAR EXAMEN
            publishExam: async () => {
                try {
                    const docRef = await addDoc(collection(state.db, `artifacts/APP_ID/users/${USER_ID}/examenes`), {
                        config: state.config,
                        questions: state.questions,
                        active: true,
                        createdAt: Timestamp.now()
                    });
                    
                    state.currentExamId = docRef.id;
                    const link = `${window.location.href.split('?')[0]}?q=${docRef.id}`;
                    
                    // QR
                    document.getElementById('qr-container').innerHTML = "";
                    new QRCode(document.getElementById("qr-container"), { text: link, width: 180, height: 180 });
                    document.getElementById('live-link').innerText = link;
                    
                    app.navTo('view-live');
                } catch (e) {
                    alert("Error al publicar: " + e.message);
                }
            },

            // VER LISTA EX√ÅMENES
            loadExams: async () => {
                const list = document.getElementById('exam-list');
                list.innerHTML = '<p class="text-center text-xs">Cargando...</p>';
                document.getElementById('exam-list-container').classList.remove('hidden');
                
                try {
                    const q = collection(state.db, `artifacts/APP_ID/users/${USER_ID}/examenes`);
                    const snap = await getDocs(q);
                    
                    list.innerHTML = "";
                    snap.forEach(doc => {
                        const d = doc.data();
                        const date = d.createdAt.toDate().toLocaleDateString();
                        const status = d.active ? '<span class="text-green-500">Activo</span>' : '<span class="text-red-500">Cerrado</span>';
                        
                        list.innerHTML += `
                        <div onclick="app.loadResults('${doc.id}')" class="bg-white p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-50 flex justify-between items-center">
                            <div>
                                <p class="text-xs font-bold text-blue-900">${d.config.area.toUpperCase()} - ${d.config.grado}¬∞</p>
                                <p class="text-[10px] text-slate-400">${date} ‚Ä¢ ${status}</p>
                            </div>
                            <i class="fas fa-chevron-right text-slate-300"></i>
                        </div>`;
                    });
                } catch (e) { console.error(e); }
            },

            // VER RESULTADOS DOCENTE
            loadResults: async (id) => {
                state.currentExamId = id;
                app.navTo('view-results-teacher');
                const tbody = document.getElementById('res-table');
                tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4">Cargando...</td></tr>';
                
                try {
                    // Cargar config del examen
                    const examSnap = await getDoc(doc(state.db, `artifacts/APP_ID/users/${USER_ID}/examenes`, id));
                    const examData = examSnap.data();
                    state.config = examData.config; // Para sync
                    
                    document.getElementById('res-title').innerText = `${state.config.area} ${state.config.grado}¬∞`;
                    document.getElementById('res-meta').innerText = examData.active ? "En curso" : "Finalizado";
                    
                    // Bot√≥n bloqueo
                    const btn = document.getElementById('btn-lock');
                    btn.innerText = examData.active ? "Bloquear" : "Abrir";
                    btn.className = examData.active ? "text-xs bg-red-50 text-red-600 px-2 py-1 rounded font-bold" : "text-xs bg-green-50 text-green-600 px-2 py-1 rounded font-bold";

                    // Cargar respuestas
                    const resSnap = await getDocs(collection(state.db, `artifacts/APP_ID/users/${USER_ID}/examenes/${id}/respuestas`));
                    state.studentResults = []; // Guardar para sync
                    
                    tbody.innerHTML = "";
                    resSnap.forEach(doc => {
                        const r = doc.data();
                        const nota = getMinedu(r.score, r.total);
                        state.studentResults.push({...r, notaLetra: nota.L});
                        
                        const waMsg = `Hola ${r.student}, tu nota es ${nota.L} (${r.score}/${r.total})`;
                        
                        tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="p-2 text-slate-700">${r.student}</td>
                            <td class="p-2 text-center"><span class="${nota.C} font-bold px-2 rounded bg-slate-100">${nota.L}</span></td>
                            <td class="p-2 text-center">
                                <a href="https://wa.me/?text=${encodeURIComponent(waMsg)}" target="_blank" class="text-green-500"><i class="fab fa-whatsapp"></i></a>
                            </td>
                        </tr>`;
                    });
                } catch(e) { alert("Error cargando resultados"); }
            },

            // SINCRONIZAR OFICIAL
            syncOfficial: async () => {
                if(!confirm("¬øEnviar notas al Registro Oficial?")) return;
                
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const docId = `registro-${state.config.bimestre}-${state.config.nivel}-${state.config.grado}-${state.config.area}-${today}`;
                    const docRef = doc(state.db, `artifacts/APP_ID/users/${USER_ID}/registros_auxiliares`, docId);
                    
                    // Leer o Crear
                    const snap = await getDoc(docRef);
                    let data = snap.exists() ? snap.data() : { notas: {}, headers: { "header-C1-0": "Examen EduGen" }, prompt: "Examen Virtual" };
                    
                    // Actualizar notas
                    state.studentResults.forEach(r => {
                        data.notas[`nota-${r.idx}-C1-0`] = r.notaLetra;
                        data.notas[`asistencia-${r.idx}`] = "A";
                    });
                    
                    await setDoc(docRef, data, { merge: true });
                    alert("‚úÖ Notas sincronizadas correctamente.");
                } catch(e) {
                    alert("Error al sincronizar: " + e.message);
                }
            },

            toggleLock: async () => {
                const ref = doc(state.db, `artifacts/APP_ID/users/${USER_ID}/examenes`, state.currentExamId);
                const snap = await getDoc(ref);
                await updateDoc(ref, { active: !snap.data().active });
                app.loadResults(state.currentExamId);
            },

            // --- MODO ALUMNO ---
            startStudentMode: async (examId) => {
                state.currentExamId = examId;
                
                // 1. Verificar Examen
                const snap = await getDoc(doc(state.db, `artifacts/APP_ID/users/${USER_ID}/examenes`, examId));
                if (!snap.exists()) return document.body.innerHTML = "<h1 class='p-10'>Examen no encontrado</h1>";
                
                const data = snap.data();
                if (!data.active) return document.body.innerHTML = "<h1 class='p-10 text-center text-red-600 font-bold'>Este examen ha finalizado.</h1>";
                
                state.questions = data.questions;
                state.config = data.config;
                
                // 2. Cargar Lista
                const list = database[state.config.nivel][state.config.grado];
                const sel = document.getElementById('student-select');
                sel.innerHTML = '<option value="">Selecciona tu nombre...</option>';
                list.forEach((n, i) => {
                    const opt = document.createElement('option');
                    opt.value = i; opt.innerText = n;
                    sel.appendChild(opt);
                });
                
                document.getElementById('login-exam-info').innerText = `${state.config.area} - ${state.config.grado}¬∞`;
                app.navTo('view-student-login');
            },

            startExam: async () => {
                const idx = document.getElementById('student-select').value;
                if (!idx) return alert("Selecciona tu nombre");
                
                // Anti-Fraude 1: Local
                if(localStorage.getItem(`done_${state.currentExamId}_${idx}`)) return alert("Ya enviaste este examen.");

                // Anti-Fraude 2: Nube
                const resRef = doc(state.db, `artifacts/APP_ID/users/${USER_ID}/examenes/${state.currentExamId}/respuestas`, `res_${idx}`);
                const snap = await getDoc(resRef);
                if(snap.exists()) return alert("Ya existe un registro de tu examen.");

                state.currentStudent = { 
                    name: database[state.config.nivel][state.config.grado][idx], 
                    idx: idx 
                };
                
                // Setup Anti-Fraude 3: Blur
                window.addEventListener('blur', () => {
                    state.fraudWarnings++;
                    if(state.fraudWarnings >= 3) {
                        alert("Has salido de la pantalla demasiadas veces. El examen se enviar√° ahora.");
                        app.finishExam();
                    } else {
                        alert(`‚ö†Ô∏è ¬°ADVERTENCIA ${state.fraudWarnings}/3! No salgas de la pantalla.`);
                    }
                });

                app.navTo('view-exam');
                app.loadQuestion(0);
            },

            loadQuestion: (idx) => {
                if (idx >= state.questions.length) return app.finishExam();
                
                state.questionIdx = idx;
                const q = state.questions[idx];
                
                document.getElementById('q-idx').innerText = idx + 1;
                document.getElementById('q-total').innerText = state.questions.length;
                document.getElementById('q-text').innerText = q.q;
                document.getElementById('progress-bar').style.width = `${(idx / state.questions.length) * 100}%`;
                
                const optsDiv = document.getElementById('q-options');
                optsDiv.innerHTML = "";
                
                q.opts.forEach((opt, i) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-4 rounded-xl border border-slate-200 bg-white hover:bg-blue-50 transition mb-2";
                    btn.innerText = opt;
                    btn.onclick = () => app.answer(i);
                    optsDiv.appendChild(btn);
                });

                // Timer
                let t = state.config.time || 30;
                clearInterval(state.timer);
                document.getElementById('timer').innerText = t;
                state.timer = setInterval(() => {
                    t--;
                    document.getElementById('timer').innerText = t;
                    if(t <= 0) app.answer(-1); // Timeout
                }, 1000);
            },

            answer: (ansIdx) => {
                clearInterval(state.timer);
                const correct = state.questions[state.questionIdx].a;
                if (ansIdx === correct) state.score++;
                app.loadQuestion(state.questionIdx + 1);
            },

            finishExam: async () => {
                const total = state.questions.length;
                const note = getMinedu(state.score, total);
                
                document.getElementById('final-grade-letter').innerText = note.L;
                document.getElementById('final-grade-letter').className = `text-6xl font-extrabold my-2 ${note.C}`;
                document.getElementById('final-score-num').innerText = `${state.score}/${total}`;
                
                app.navTo('view-student-result');
                
                // Guardar
                try {
                    await setDoc(doc(state.db, `artifacts/APP_ID/users/${USER_ID}/examenes/${state.currentExamId}/respuestas`, `res_${state.currentStudent.idx}`), {
                        student: state.currentStudent.name,
                        idx: state.currentStudent.idx,
                        score: state.score,
                        total: total,
                        timestamp: Timestamp.now()
                    });
                    localStorage.setItem(`done_${state.currentExamId}_${state.currentStudent.idx}`, 'true');
                } catch(e) { console.error(e); }
            },

            // Compartir
            copyLink: () => {
                navigator.clipboard.writeText(document.getElementById('live-link').innerText);
                alert("Copiado!");
            },
            shareWA: () => {
                const link = document.getElementById('live-link').innerText;
                window.open(`https://wa.me/?text=Examen: ${link}`, '_blank');
            },
            simulateStudent: () => app.startStudentMode(state.currentExamId),
            viewResultsFromLive: () => app.loadResults(state.currentExamId)
        };

        // UI Aux
        function renderReview() {
            const l = document.getElementById('review-list');
            l.innerHTML = "";
            state.questions.forEach((q, i) => {
                l.innerHTML += `
                <div class="bg-white p-3 rounded border">
                    <input class="w-full font-bold mb-2 border-b" value="${q.q}" onchange="app.updateQ(${i},'q',this.value)">
                    <div class="grid grid-cols-2 gap-2">
                        ${q.opts.map((o, oi) => `<input class="text-xs border rounded p-1" value="${o}" onchange="app.updateOpt(${i},${oi},this.value)">`).join('')}
                    </div>
                </div>`;
            });
            app.updateQ = (i, f, v) => state.questions[i][f] = v;
            app.updateOpt = (q, o, v) => state.questions[q].opts[o] = v;
        }

        function getMinedu(s, t) {
            const p = (s/t)*100;
            if(p >= 85) return {L:'AD', C:'text-blue-600'};
            if(p >= 70) return {L:'A', C:'text-green-600'};
            if(p >= 50) return {L:'B', C:'text-yellow-600'};
            return {L:'C', C:'text-red-600'};
        }

        // Init
        init();
    </script>
</body>
</html>